CREATE OR REPLACE PACKAGE JHLISFUADM."JHL_OFA_UTILS_1" AS 
PROCEDURE JHL_OFA_GL_VOUCHERS_NEW(V_VOUCHER_NO  VARCHAR2  );
PROCEDURE CREATE_INDIVIDUAL_SUPPLIER(V_CUST_REF_NO NUMBER, V_AGENT_NO NUMBER DEFAULT NULL) ;
PROCEDURE CREATE_CORPORATE_SUPPLIER(COMPANY_CODE VARCHAR,COMPANY_BRANCH VARCHAR, V_AGENT_NO NUMBER DEFAULT NULL);
PROCEDURE JHL_OFA_PAYABLES_PROC;
PROCEDURE JHL_OFA_TRANSFORM_GL_VOU_PROC (V_VOUCHER_NO  VARCHAR2 );

FUNCTION BFN_GET_PAYEE_NAME(P_VOUCHER_NO VARCHAR2)
  RETURN VARCHAR2;
  PROCEDURE DELETE_SUPPLIER_MASTER;
  PROCEDURE OFA_GL_TRANS_PROC;
      PROCEDURE CREATE_OFA_RECEIVABLE_TRANS;
    PROCEDURE TRANSFORM_OFA_RECEIVABLE_TRANS;
   PROCEDURE TRANSFORM_OFA_GL_TRANS;
    PROCEDURE SEND_GL_TRANS_TO_OFA;
     PROCEDURE LOG_VOUCHER_ERROR(VOU_NO VARCHAR,V_ERROR_MSG VARCHAR);
     PROCEDURE CREATE_INDIVIDUAL_SUPPLIER_NEW(V_CUST_REF_NO NUMBER, V_AGENT_NO NUMBER DEFAULT NULL);
     PROCEDURE CREATE_CORPORATE_SUPPLIER_NEW(COMPANY_CODE VARCHAR,COMPANY_BRANCH VARCHAR, V_AGENT_NO NUMBER DEFAULT NULL);
     PROCEDURE JHL_OFA_TRANSFORM_GL_VOU (V_VOUCHER_NO  VARCHAR2 );
          PROCEDURE CREATE_OFA_CANCELLED_PYMT_GL ( VOUCHER_NO NUMBER DEFAULT NULL);
       PROCEDURE TRANSFORM_OFA_CANCEL_PY_TRANS;
       PROCEDURE TRANSFORM_OFA_PY_GL_TRANS;
         PROCEDURE SEND_PYMT_GL_TRANS_TO_OFA;
         PROCEDURE UPDT_CHQ;
      
END JHL_OFA_UTILS_1;
/
CREATE OR REPLACE PACKAGE BODY JHLISFUADM."JHL_OFA_UTILS_1"
AS
    PROCEDURE RAISE_ERROR (V_MSG IN VARCHAR2, V_ERR_NO IN NUMBER := NULL)
        IS
    BEGIN
        IF V_ERR_NO IS NULL
        THEN
            RAISE_APPLICATION_ERROR (
                    -20015,
                    V_MSG || ' - ' || SUBSTR (SQLERRM (SQLCODE), 10));
        ELSE
            RAISE_APPLICATION_ERROR (
                    V_ERR_NO,
                    V_MSG || ' - ' || SUBSTR (SQLERRM (SQLCODE), 10));
        END IF;
    END RAISE_ERROR;

    PROCEDURE JHL_OFA_GL_VOUCHERS_NEW (V_VOUCHER_NO VARCHAR2)
        IS
        CURSOR VOUCHERS
            IS
            SELECT 'Isf-Life' SOURCE_SYSTEM,
                   LEGACY_SUPPLIER_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'JHL_UG_LIF_LE' LEGAL_ENTITY_NAME,
                   V_VOU_NO VOUCHER_NUM,
                   V_VOU_NO INVOICE_NUM,
                   'STANDARD' INVOICE_TYPE,
                   TO_DATE (V_VOU_DATE, 'DD-MM-RRRR') INVOICE_DATE,
                   VENDOR_NAME,
                   VENDOR_SITE_CODE,
                   INVOICE_AMOUNT,
                   INVOICE_CURRENCY_CODE INVOICE_CURRENCY,
                   'USER' EXCHANGE_RATE_TYPE,
                   TO_DATE (V_VOU_DATE, 'DD-MM-RRRR') EXCHANGE_DATE,
                   'IMMEDIATE' TERMS_NAME,
                   TO_DATE (V_VOU_DATE, 'DD-MM-RRRR') TERMS_DATE,
                   DESCRIPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   PAY_GROUP_LOOKUP_CODE,
                   'ISF' SOURCE,


                   CASE
                       WHEN ROUND (TRUNC (SYSDATE) - TRUNC (V_VOU_DATE)) <= 30
                           THEN
                           V_VOU_DATE
                       ELSE
                           TO_DATE (SYSDATE, 'DD-MM-RRRR')
                       END
                       GL_DATE,
                   LIABILITY_ACCOUNT,
                   LINE_NUMBER,
                   'Item' LINETYPE,
                   LINE_AMOUNT,
                   LEGACY_REF1,
                   N_CUST_REF_NO LEGACY_REF2,
                   LEGACY_REF3,
                   'JHLUPROD' LEGACY_REF4,
                   TO_DATE (V_VOU_DATE, 'DD-MM-RRRR') LEGACY_REF5,
                   'JHLUPROD' LEGACY_REF6,
                   TO_DATE (V_VOU_DATE, 'DD-MM-RRRR') LEGACY_REF7,
                   '210' LEGACY_REF8,
                   NVL (OPT_CHANNEL_CODE, '11') LEGACY_REF9,
                   NVL (OPT_PRODUCT_CODE, '12') LEGACY_REF10,
                   10 || V_VOU_NO SEQ_ID,
                   1 PROCESS_FLAG,
                   11 CREATED_BY,
                   V_VOU_DATE CREATION_DATE,
                   V_VOU_DATE LAST_UPDATE_DATE,
                   V_MAIN_VOU_NO,
                   V_VOU_NO,
                   TO_CHAR (N_CUST_REF_NO) VENDOR_NUM,
                   EXCHANGE_RATE,
                   LEGACY_REF11,
                   VERIFIED_BY LEGACY_REF12,
                   VERIFIED_DT LEGACY_REF13,
                   APPROVED_BY LEGACY_REF14,
                   APPROVED_DT LEGACY_REF15
            FROM JHL_OFA_PYMT_TRANSACTIONS
            WHERE OPT_PROCESSED = 'N' AND V_VOU_NO = V_VOUCHER_NO
            ORDER BY LINE_NUMBER;
    BEGIN
        INSERT INTO JHL_OFA_PYMT_VOUCHER_DTLS (OPV_NO,
                                               V_VOU_NO,
                                               OPV_DATE,
                                               OPV_USER)
        VALUES (OPV_NO_SEQ.NEXTVAL,
                V_VOUCHER_NO,
                SYSDATE,
                'JHLISFUADM');

        FOR I IN VOUCHERS
            LOOP







                INSERT
                INTO XXJICUG_AP_INVOICES_STG@JICOFPROD.COM (SEQ_ID,
                                                            PROCESS_FLAG,
                                                            SOURCE_SYSTEM,
                                                            LEGACY_SUPPLIER_CODE,
                                                            OPERATING_UNIT,
                                                            LEGAL_ENTITY_NAME,
                                                            VOUCHER_NUM,
                                                            INVOICE_NUM,
                                                            INVOICE_TYPE,
                                                            INVOICE_DATE,
                                                            VENDOR_NUM,
                                                            VENDOR_NAME,
                                                            VENDOR_SITE_CODE,
                                                            INVOICE_AMOUNT,
                                                            INVOICE_CURRENCY,
                                                            EXCHANGE_RATE_TYPE,
                                                            EXCHANGE_DATE,
                                                            TERMS_NAME,
                                                            TERMS_DATE,
                                                            DESCRIPTION,
                                                            PAYMENT_METHOD_CODE,
                                                            PAY_GROUP_LOOKUP_CODE,
                                                            SOURCE,
                                                            GL_DATE,
                                                            LIABILITY_ACCOUNT,
                                                            LINE_NUMBER,
                                                            LINETYPE,
                                                            LINE_AMOUNT,
                                                            LEGACY_REF1,
                                                            LEGACY_REF2,
                                                            LEGACY_REF3,
                                                            LEGACY_REF4,
                                                            LEGACY_REF5,
                                                            LEGACY_REF6,
                                                            LEGACY_REF7,
                                                            LEGACY_REF8,
                                                            LEGACY_REF9,
                                                            LEGACY_REF10,
                                                            CREATED_BY,
                                                            CREATION_DATE,
                                                            LAST_UPDATE_DATE,
                                                            EXCHANGE_RATE,
                                                            LEGACY_REF11,
                                                            LEGACY_REF12,
                                                            LEGACY_REF13,
                                                            LEGACY_REF14,
                                                            LEGACY_REF15)
                VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                        1,
                        I.SOURCE_SYSTEM,
                        I.LEGACY_SUPPLIER_CODE,
                        I.OPERATING_UNIT,
                        I.LEGAL_ENTITY_NAME,
                        I.VOUCHER_NUM,
                        I.INVOICE_NUM,
                        I.INVOICE_TYPE,
                        I.INVOICE_DATE,
                        I.VENDOR_NUM,
                        I.VENDOR_NAME,
                        I.VENDOR_SITE_CODE,
                        I.INVOICE_AMOUNT,
                        I.INVOICE_CURRENCY,
                        I.EXCHANGE_RATE_TYPE,
                        I.EXCHANGE_DATE,
                        I.TERMS_NAME,
                        I.TERMS_DATE,
                        I.DESCRIPTION,
                        I.PAYMENT_METHOD_CODE,
                        I.PAY_GROUP_LOOKUP_CODE,
                        I.SOURCE,
                        I.GL_DATE,
                        I.LIABILITY_ACCOUNT,
                        I.LINE_NUMBER,
                        I.LINETYPE,
                        I.LINE_AMOUNT,
                        I.LEGACY_REF1,
                        I.LEGACY_REF2,
                        I.LEGACY_REF3,
                        I.LEGACY_REF4,
                        I.LEGACY_REF5,
                        I.LEGACY_REF6,
                        I.LEGACY_REF7,
                        I.LEGACY_REF8,
                        I.LEGACY_REF9,
                        I.LEGACY_REF10,
                        I.CREATED_BY,
                        I.CREATION_DATE,
                        I.LAST_UPDATE_DATE,
                        I.EXCHANGE_RATE,
                        I.LEGACY_REF11,
                        I.LEGACY_REF12,
                        I.LEGACY_REF13,
                        I.LEGACY_REF14,
                        I.LEGACY_REF15);
            END LOOP;

        UPDATE JHL_OFA_PYMT_TRANSACTIONS
        SET OPT_PROCESSED = 'Y'
        WHERE V_VOU_NO = V_VOUCHER_NO;

        COMMIT;
    END;



    PROCEDURE CREATE_INDIVIDUAL_SUPPLIER (
        V_CUST_REF_NO    NUMBER,
        V_AGENT_NO       NUMBER DEFAULT NULL)
        IS
        CURSOR SUPPLIERS
            IS
            SELECT C.V_NAME VENDOR_NAME,
                   DECODE (C.V_STATUS, 'A', 'Y', 'N') ENABLED_FLAG,
                   'VENDOR' TYPE_OF_SUPPLIER,
                   'Immediate' TERMS_NAME,
                   'ISF-INDIVIDUAL-CLAIM' PAY_GROUP,
                   99 PAY_PRIORITY,
                   'UGX' INVOICE_CURRENCY,
                   'UGX' PAYMENT_CURRENCY,
                   'N' HOLD_FLAG,
                   'INVOICE' TERMS_DATE_BASIS,
                   'N' INSPEC_REQ_FLAG,
                   'N' RCPT_REQUIRED_FLAG,
                   'R' MATCH_OPTION,
                   'CHECK' PAYM_METHOD_CODE,
                   DECODE (
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'),
                           '.', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           '-', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'))
                       LEGACY_REF1,
                   REPLACE (
                           TRIM (
                                   (SELECT V_IDEN_NO
                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                    WHERE     V_IDEN_CODE = 'NIC'
                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO
                                      AND ROWNUM = 1)),
                           ' ',
                           '')
                       LEGACY_REF2,
                   C.V_LASTUPD_USER LEGACY_REF3,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF4,
                   C.V_LASTUPD_USER LEGACY_REF5,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF6,
                   TO_DATE (D_BIRTH_DATE, 'DD-MM-RRRR') LEGACY_REF7,
                   'Uganda' LEGACY_REF9,
                   '11' LEGACY_REF11,
                   SYSDATE LAST_UPDATE_DATE,
                   N_CUST_REF_NO
            FROM GNMT_CUSTOMER_MASTER C

            WHERE N_CUST_REF_NO = V_CUST_REF_NO;


        CURSOR SUPPLIERS_SITE (
            V_CUST_REF_NO NUMBER)
            IS
            SELECT P.V_POLICY_NO VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = P.N_PAYER_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                 ADDRESS_LINE1,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = P.N_PAYER_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                 CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'ISF-INDIVIDUAL-CLAIM' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152037' PREPAYMENT_ACCOUNT_ID,
                   '202301' LIABILITY_ACCOUNT,
                   DECODE (
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'),
                           '.', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           '-', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'))
                       LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2,
                   P.V_POLICY_NO LEGACY_REF3,
                   P.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF5,
                   P.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '11' LEGACY_REF9,
                   '12' LEGACY_REF10
            FROM GNMT_POLICY P, GNMT_CUSTOMER_MASTER C, GNLU_PAY_METHOD PM
            WHERE     P.N_PAYER_REF_NO = C.N_CUST_REF_NO
              AND P.V_PMT_METHOD_CODE = PM.V_PMT_METHOD_CODE

              AND C.N_CUST_REF_NO = V_CUST_REF_NO
            UNION
            SELECT TO_CHAR ('PYR-' || C.N_CUST_REF_NO) VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       ADDRESS_LINE1,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'ISF-INDIVIDUAL-CLAIM' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152121' PREPAYMENT_ACCOUNT_ID,
                   '202351' LIABILITY_ACCOUNT,
                   DECODE (
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'),
                           '.', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           '-', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'))
                                                       LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2,
                   TO_CHAR (NULL) LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '13' LEGACY_REF9,
                   '12' LEGACY_REF10
            FROM AMMM_AGENT_MASTER AGN, GNMT_CUSTOMER_MASTER C
            WHERE     AGN.N_CUST_REF_NO = C.N_CUST_REF_NO

              AND AGN.N_AGENT_NO = NVL (V_AGENT_NO, AGN.N_AGENT_NO)
              AND C.N_CUST_REF_NO = V_CUST_REF_NO
            UNION
            SELECT TO_CHAR ('PYR-' || C.N_CUST_REF_NO) VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       ADDRESS_LINE1,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'ISF-INDIVIDUAL-CLAIM' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152121' PREPAYMENT_ACCOUNT_ID,
                   '202351' LIABILITY_ACCOUNT,
                   DECODE (
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'),
                           '.', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           '-', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'))
                                                       LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2,
                   TO_CHAR (NULL) LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '13' LEGACY_REF9,
                   '12' LEGACY_REF10
            FROM GNMT_CUSTOMER_MASTER C
            WHERE     TO_CHAR (C.N_CUST_REF_NO) NOT IN
                      (SELECT AGN.N_CUST_REF_NO
                       FROM AMMM_AGENT_MASTER AGN
                       WHERE AGN.N_CUST_REF_NO IS NOT NULL
                       UNION ALL
                       SELECT POL.N_PAYER_REF_NO
                       FROM GNMT_POLICY POL
                       WHERE POL.N_PAYER_REF_NO IS NOT NULL)
              AND C.N_CUST_REF_NO = V_CUST_REF_NO;


        CURSOR SUPPLIER_CONTACT (
            V_CUST_REF_NO NUMBER)
            IS
            SELECT 'JHL_UG_LIF_OU' OPERATING_UNIT,
                   NVL (
                           TRIM (
                                   SUBSTR (TRIM (NVL (V_FIRST_NAME, C.V_NAME)),
                                           1,
                                           INSTR (NVL (V_FIRST_NAME, C.V_NAME), ' ') - 1)),
                           C.V_NAME)
                                   FIRST_NAME,


                   NVL (
                           TRIM (SUBSTR (TRIM (NVL (V_FIRST_NAME, C.V_NAME)),
                                         INSTR (TRIM (NVL (V_FIRST_NAME, C.V_NAME)),
                                                ' ',
                                                -1,
                                                1))),
                           '.')
                                   LAST_NAME,

                   NVL (
                           (SELECT V_CONTACT_NUMBER
                            FROM GNDT_CUSTMOBILE_CONTACTS
                            WHERE     N_CUST_REF_NO = C.N_CUST_REF_NO
                              AND V_STATUS = 'A'
                              AND V_CONTACT_NUMBER NOT LIKE '%@%'
                              AND ROWNUM = 1),
                           '.')
                                   PHONE,
                   NVL (
                           (SELECT V_CONTACT_NUMBER
                            FROM GNDT_CUSTMOBILE_CONTACTS
                            WHERE     N_CUST_REF_NO = C.N_CUST_REF_NO
                              AND V_STATUS = 'A'
                              AND V_CONTACT_NUMBER LIKE '%@%'
                              AND ROWNUM = 1),
                           '.')
                                   EMAIL_ADDRESS,
                   DECODE (
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'),
                           '.', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           '-', 'XUGL' || C.N_CUST_REF_NO || 'I',
                           NVL (
                                   REPLACE (
                                           TRIM (
                                                   (SELECT MAX (V_IDEN_NO)
                                                    FROM GNDT_CUSTOMER_IDENTIFICATION
                                                    WHERE     V_IDEN_CODE = 'PIN'
                                                      AND V_LASTUPD_INFTIM =
                                                          (SELECT MAX (V_LASTUPD_INFTIM)
                                                           FROM GNDT_CUSTOMER_IDENTIFICATION
                                                           WHERE     V_IDEN_CODE = 'PIN'
                                                             AND N_CUST_REF_NO =
                                                                 C.N_CUST_REF_NO)
                                                      AND N_CUST_REF_NO = C.N_CUST_REF_NO)),
                                           ' ',
                                           ''),
                                   'XUGL' || C.N_CUST_REF_NO || 'I'))
                                   LEGACY_REF1
            FROM GNMT_CUSTOMER_MASTER C
            WHERE C.N_CUST_REF_NO = V_CUST_REF_NO;

        V_SUPPLIER_COUNT        NUMBER := 0;
        V_SUPPLIER_SITE_COUNT   NUMBER := 0;
        V_PIN_COUNT             NUMBER := 0;
        V_SITE_COUNT            NUMBER := 0;
        V_CONTACT_COUNT         NUMBER := 0;
    BEGIN
        FOR I IN SUPPLIERS
            LOOP
                BEGIN
                    SELECT COUNT (*)
                    INTO V_SUPPLIER_COUNT
                    FROM JHL_OFA_SUPPLIER
                    WHERE N_CUST_REF_NO = I.N_CUST_REF_NO;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_SUPPLIER_COUNT := 0;
                END;


                IF V_SUPPLIER_COUNT = 0
                THEN
                    INSERT INTO JHL_OFA_SUPPLIER (OSP_NO,
                                                  N_CUST_REF_NO,
                                                  OSP_PIN_NO,
                                                  OSP_DATE,
                                                  OSP_ID_NO)
                    VALUES (JHL_OSP_NO_SEQ.NEXTVAL,
                            I.N_CUST_REF_NO,
                            I.LEGACY_REF1,
                            SYSDATE,
                            I.LEGACY_REF2);
                END IF;















                BEGIN
                    SELECT COUNT (*)
                    INTO V_PIN_COUNT
                    FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                    WHERE     PAY_GROUP = 'ISF-INDIVIDUAL-CLAIM'
                      AND LEGACY_REF1 = I.LEGACY_REF1;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_PIN_COUNT := 0;
                END;




                IF V_PIN_COUNT = 0
                THEN
                    INSERT
                    INTO XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM (SEQ_ID,
                                                                PROCESS_FLAG,
                                                                VENDOR_NAME,
                                                                ENABLED_FLAG,
                                                                TYPE_OF_SUPPLIER,
                                                                TERMS_NAME,
                                                                PAY_GROUP,
                                                                PAY_PRIORITY,
                                                                INVOICE_CURRENCY,
                                                                PAYMENT_CURRENCY,
                                                                HOLD_FLAG,
                                                                TERMS_DATE_BASIS,
                                                                INSPEC_REQ_FLAG,
                                                                RCPT_REQUIRED_FLAG,
                                                                MATCH_OPTION,
                                                                PAYM_METHOD_CODE,
                                                                LEGACY_REF1,
                                                                LEGACY_REF2,
                                                                LEGACY_REF3,
                                                                LEGACY_REF4,
                                                                LEGACY_REF5,
                                                                LEGACY_REF6,
                                                                LEGACY_REF7,
                                                                LEGACY_REF9,
                                                                LEGACY_REF11,
                                                                LAST_UPDATE_DATE)
                    VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                            1,
                            I.VENDOR_NAME,
                            I.ENABLED_FLAG,
                            I.TYPE_OF_SUPPLIER,
                            I.TERMS_NAME,
                            I.PAY_GROUP,
                            I.PAY_PRIORITY,
                            I.INVOICE_CURRENCY,
                            I.PAYMENT_CURRENCY,
                            I.HOLD_FLAG,
                            I.TERMS_DATE_BASIS,
                            I.INSPEC_REQ_FLAG,
                            I.RCPT_REQUIRED_FLAG,
                            I.MATCH_OPTION,
                            I.PAYM_METHOD_CODE,
                            I.LEGACY_REF1,
                            I.LEGACY_REF2,
                            I.LEGACY_REF3,
                            I.LEGACY_REF4,
                            I.LEGACY_REF5,
                            I.LEGACY_REF6,
                            I.LEGACY_REF7,
                            I.LEGACY_REF9,
                            I.LEGACY_REF11,
                            I.LAST_UPDATE_DATE);
                END IF;

                FOR J IN SUPPLIERS_SITE (I.N_CUST_REF_NO)
                    LOOP
                        BEGIN
                            SELECT COUNT (*)
                            INTO V_SUPPLIER_SITE_COUNT
                            FROM JHL_OFA_SUPPLIER_SITE
                            WHERE     N_CUST_REF_NO = I.N_CUST_REF_NO
                              AND NVL (V_POLICY_NO, 'XXXXX') =
                                  NVL (J.LEGACY_REF3, 'XXXXX');
                        EXCEPTION
                            WHEN OTHERS
                                THEN
                                    V_SUPPLIER_SITE_COUNT := 0;
                        END;



                        BEGIN
                            SELECT COUNT (*)
                            INTO V_SITE_COUNT
                            FROM APPS.XXJIC_AP_SUPPLIER_MAP@JICOFPROD.COM
                            WHERE     LOB_NAME IN ('JHL_UG_LIF_OU')
                              AND PIN_NO = I.LEGACY_REF1
                              AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE;
                        EXCEPTION
                            WHEN OTHERS
                                THEN
                                    V_SITE_COUNT := 0;
                        END;

                        IF V_SITE_COUNT = 0
                        THEN
                            BEGIN
                                SELECT COUNT (*)
                                INTO V_SITE_COUNT
                                FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                                WHERE     PAY_GRP_LKP_CODE = 'ISF-INDIVIDUAL-CLAIM'
                                  AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE
                                  AND LEGACY_REF1 = J.LEGACY_REF1
                                  AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_SITE_COUNT := 0;
                            END;
                        END IF;


                        IF V_SUPPLIER_SITE_COUNT = 0
                        THEN
                            INSERT INTO JHL_OFA_SUPPLIER_SITE (OSPC_NO,
                                                               N_CUST_REF_NO,
                                                               V_POLICY_NO,
                                                               OSPC_DATE)
                            VALUES (JHL_OSPC_NO_SEQ.NEXTVAL,
                                    I.N_CUST_REF_NO,
                                    J.LEGACY_REF3,
                                    SYSDATE);
                        END IF;



                        IF V_SITE_COUNT = 0
                        THEN
                            INSERT
                            INTO XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM (
                                SEQ_ID,
                                PROCESS_FLAG,
                                VENDOR_SITE_CODE,
                                PURCHASIN_SITE_FLAG,
                                RFQ_ONLY_SITE_FLAG,
                                PAY_SITE_FLAG,
                                ADDRESS_LINE1,
                                CITY,
                                STATE,
                                ZIP,
                                COUNTRY,
                                TERMS_DATE_BASIS,
                                PAY_GRP_LKP_CODE,
                                TERMS_NAME,
                                INV_CURR_CODE,
                                PYMT_CURR_CODE,
                                OPERATING_UNIT,
                                MATCH_OPTION,
                                PAYMENT_METHOD_CODE,
                                PREPAYMENT_ACCOUNT_ID,
                                PREPAYMENT_ACCOUNT,
                                LIABILITY_ACCOUNT,
                                LIABILITY_ACCOUNT_ID,
                                LEGACY_REF1,
                                LEGACY_REF2,
                                LEGACY_REF3,
                                LEGACY_REF4,
                                LEGACY_REF5,
                                LEGACY_REF6,
                                LEGACY_REF7,
                                LEGACY_REF8,
                                LEGACY_REF9,
                                LEGACY_REF10)
                            VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                    1,
                                    J.VENDOR_SITE_CODE,
                                    J.PURCHASIN_SITE_FLAG,
                                    J.RFQ_ONLY_SITE_FLAG,
                                    J.PAY_SITE_FLAG,
                                    J.ADDRESS_LINE1,
                                    J.CITY,
                                    J.STATE,
                                    J.ZIP,
                                    J.COUNTRY,
                                    J.TERMS_DATE_BASIS,
                                    J.PAY_GRP_LKP_CODE,
                                    J.TERMS_NAME,
                                    J.INV_CURR_CODE,
                                    J.PYMT_CURR_CODE,
                                    J.OPERATING_UNIT,
                                    J.MATCH_OPTION,
                                    J.PAYMENT_METHOD_CODE,
                                    J.PREPAYMENT_ACCOUNT_ID,
                                    J.PREPAYMENT_ACCOUNT_ID,
                                    J.LIABILITY_ACCOUNT,
                                    J.LIABILITY_ACCOUNT,
                                    J.LEGACY_REF1,
                                    J.LEGACY_REF2,
                                    J.LEGACY_REF3,
                                    J.LEGACY_REF4,
                                    J.LEGACY_REF5,
                                    J.LEGACY_REF6,
                                    J.LEGACY_REF7,
                                    J.LEGACY_REF8,
                                    J.LEGACY_REF9,
                                    J.LEGACY_REF10);
                        END IF;
                    END LOOP;



                FOR C IN SUPPLIER_CONTACT (I.N_CUST_REF_NO)
                    LOOP
                        BEGIN
                            SELECT COUNT (*)
                            INTO V_CONTACT_COUNT
                            FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                            WHERE     LEGACY_REF1 = C.LEGACY_REF1
                              AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                        EXCEPTION
                            WHEN OTHERS
                                THEN
                                    V_CONTACT_COUNT := 0;
                        END;

                        IF V_CONTACT_COUNT = 0
                        THEN
                            INSERT
                            INTO XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM (
                                SEQ_ID,
                                PROCESS_FLAG,
                                OPERATING_UNIT,
                                FIRST_NAME,
                                LAST_NAME,
                                PHONE,
                                EMAIL_ADDRESS,
                                LEGACY_REF1)
                            VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                    1,
                                    C.OPERATING_UNIT,
                                    C.FIRST_NAME,
                                    C.LAST_NAME,
                                    C.PHONE,
                                    C.EMAIL_ADDRESS,
                                    C.LEGACY_REF1);
                        END IF;
                    END LOOP;



                BEGIN
                    SELECT COUNT (*)
                    INTO V_SITE_COUNT
                    FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                    WHERE     PAY_GRP_LKP_CODE = 'ISF-INDIVIDUAL-CLAIM'
                      AND LEGACY_REF1 = I.LEGACY_REF1
                      AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_SITE_COUNT := 0;
                END;


                IF V_SITE_COUNT = 0
                THEN
                    DELETE FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                    WHERE     PAY_GROUP = 'ISF-INDIVIDUAL-CLAIM'
                      AND LEGACY_REF1 = I.LEGACY_REF1
                      AND LEGACY_REF9 = 'Uganda';

                    DELETE FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                    WHERE     LEGACY_REF1 = I.LEGACY_REF1
                      AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                END IF;
            END LOOP;



        COMMIT;
    END;

    PROCEDURE CREATE_CORPORATE_SUPPLIER (
        COMPANY_CODE      VARCHAR,
        COMPANY_BRANCH    VARCHAR,
        V_AGENT_NO        NUMBER DEFAULT NULL)
        IS
        CURSOR SUPPLIERS
            IS
            SELECT C.V_COMPANY_NAME VENDOR_NAME,
                   DECODE (C.V_COMP_STAT, 'A', 'Y', 'N') ENABLED_FLAG,
                   'VENDOR' TYPE_OF_SUPPLIER,
                   'Immediate' TERMS_NAME,
                   'ISF-CORPORATE' PAY_GROUP,
                   99 PAY_PRIORITY,
                   'UGX' INVOICE_CURRENCY,
                   'UGX' PAYMENT_CURRENCY,
                   'N' HOLD_FLAG,
                   'INVOICE' TERMS_DATE_BASIS,
                   'N' INSPEC_REQ_FLAG,
                   'N' RCPT_REQUIRED_FLAG,
                   'R' MATCH_OPTION,
                   'CHECK' PAYM_METHOD_CODE,
                   'XUGL' || C.V_COMPANY_CODE || 'C' LEGACY_REF1,
                   NULL LEGACY_REF2,
                   C.V_LASTUPD_USER LEGACY_REF3,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF4,
                   C.V_LASTUPD_USER LEGACY_REF5,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF6,
                   NULL LEGACY_REF7,
                   'Uganda' LEGACY_REF9,
                   '11' LEGACY_REF11,
                   SYSDATE LAST_UPDATE_DATE,
                   C.V_COMPANY_CODE,
                   C.V_COMPANY_BRANCH
            FROM GNMM_COMPANY_MASTER C
            WHERE     C.V_COMPANY_CODE = COMPANY_CODE
              AND C.V_COMPANY_BRANCH = COMPANY_BRANCH;



        CURSOR SUPPLIER_SITE (
            V_COMPANYCODE      VARCHAR,
            V_COMPANYBRANCH    VARCHAR)
            IS
            SELECT P.V_POLICY_NO VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NULL ATTENTION_AR_FLAG,
                   NVL (
                           (SELECT G.V_POST_BOX
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                 ADDRESS_LINE1,
                   NVL (
                           (SELECT G.V_TOWN
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                 CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   NULL PROVINCE,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'ISF-CORPORATE' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152037' PREPAYMENT_ACCOUNT_ID,
                   '202301' LIABILITY_ACCOUNT,
                   'XUGL' || C.V_COMPANY_CODE || 'C' LEGACY_REF1,
                   TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH)
                       LEGACY_REF2,
                   P.V_POLICY_NO LEGACY_REF3,
                   P.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF5,
                   P.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '11' LEGACY_REF9,
                   '11' LEGACY_REF10,
                   C.V_COMPANY_CODE,
                   C.V_COMPANY_BRANCH
            FROM GNMT_POLICY P,
                 GNMM_COMPANY_MASTER C,
                 GNMM_POLICY_STATUS_MASTER STATUS,
                 GNLU_INSTITUTION_TYPE INS,
                 GNLU_PAY_METHOD PM
            WHERE     P.V_COMPANY_CODE = C.V_COMPANY_CODE
              AND P.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
              AND P.V_CNTR_STAT_CODE = STATUS.V_STATUS_CODE
              AND C.V_INST_TYPE = INS.V_INST_TYPE
              AND P.V_PMT_METHOD_CODE = PM.V_PMT_METHOD_CODE


              AND C.V_COMPANY_CODE = V_COMPANYCODE
              AND C.V_COMPANY_BRANCH = V_COMPANYBRANCH
            UNION
            SELECT SUBSTR (
                           TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH),
                           1,
                           15)
                                                       VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NULL ATTENTION_AR_FLAG,
                   NVL (
                           (SELECT G.V_POST_BOX
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = AGN.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = AGN.V_COMPANY_BRANCH),
                           'KAMPALA')
                                                       ADDRESS_LINE1,
                   NVL (
                           (SELECT G.V_TOWN
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = AGN.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = AGN.V_COMPANY_BRANCH),
                           'KAMPALA')
                                                       CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   NULL PROVINCE,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'ISF-CORPORATE' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152121' PREPAYMENT_ACCOUNT_ID,
                   '202351' LIABILITY_ACCOUNT,
                   'XUGL' || AGN.V_COMPANY_CODE || 'C' LEGACY_REF1,
                   TO_CHAR (
                           TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH))
                                                       LEGACY_REF2,
                   TO_CHAR (NULL) LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (C.V_LASTUPD_INFTIM, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (C.V_LASTUPD_INFTIM, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '12' LEGACY_REF9,
                   '11' LEGACY_REF10,
                   AGN.V_COMPANY_CODE,
                   AGN.V_COMPANY_BRANCH
            FROM GNMM_COMPANY_MASTER C,
                 AMMM_AGENT_MASTER AGN,
                 GNLU_INSTITUTION_TYPE INS
            WHERE     C.V_COMPANY_CODE = AGN.V_COMPANY_CODE
              AND C.V_COMPANY_BRANCH = AGN.V_COMPANY_BRANCH
              AND C.V_INST_TYPE = INS.V_INST_TYPE

              AND AGN.V_COMPANY_CODE = V_COMPANYCODE
              AND AGN.V_COMPANY_BRANCH = V_COMPANYBRANCH
              AND AGN.N_AGENT_NO = NVL (V_AGENT_NO, AGN.N_AGENT_NO)
            UNION
            SELECT SUBSTR (
                           TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH),
                           1,
                           15)
                                                     VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NULL ATTENTION_AR_FLAG,
                   NVL (
                           (SELECT G.V_POST_BOX
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                                     ADDRESS_LINE1,
                   NVL (
                           (SELECT G.V_TOWN
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                                     CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   NULL PROVINCE,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'ISF-CORPORATE' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152037' PREPAYMENT_ACCOUNT_ID,
                   '202301' LIABILITY_ACCOUNT,
                   'XUGL' || C.V_COMPANY_CODE || 'C' LEGACY_REF1,
                   TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH)
                                                     LEGACY_REF2,
                   NULL LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                     LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                     LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '11' LEGACY_REF9,
                   '11' LEGACY_REF10,
                   C.V_COMPANY_CODE,
                   C.V_COMPANY_BRANCH
            FROM GNMM_COMPANY_MASTER C
            WHERE     1 = 1
              AND C.V_COMPANY_CODE = V_COMPANYCODE
              AND C.V_COMPANY_BRANCH = V_COMPANYBRANCH
              AND (C.V_COMPANY_CODE, C.V_COMPANY_BRANCH) NOT IN
                  (SELECT AGN.V_COMPANY_CODE, AGN.V_COMPANY_BRANCH
                   FROM AMMM_AGENT_MASTER AGN
                   WHERE AGN.V_COMPANY_CODE IS NOT NULL)
              AND (C.V_COMPANY_CODE, C.V_COMPANY_BRANCH) NOT IN
                  (SELECT P.V_COMPANY_CODE, P.V_COMPANY_BRANCH
                   FROM GNMT_POLICY P,
                        GNMM_POLICY_STATUS_MASTER STATUS
                   WHERE     P.V_CNTR_STAT_CODE = STATUS.V_STATUS_CODE
                     AND P.V_COMPANY_CODE IS NOT NULL

                  );


        CURSOR SUPPLIER_CONTACT (
            V_COMPANYCODE      VARCHAR,
            V_COMPANYBRANCH    VARCHAR)
            IS
            SELECT DISTINCT
                'JHL_UG_LIF_OU' OPERATING_UNIT,
                C.V_COMPANY_NAME FIRST_NAME,
                '.' LAST_NAME,
                NVL (
                        SUBSTR (
                                (SELECT V_CONTACT_NUMBER
                                 FROM GNDT_COMPMOBILE_CONTACTS H
                                 WHERE     H.V_COMPANY_CODE = C.V_COMPANY_CODE
                                   AND H.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
                                   AND V_CONTACT_NUMBER NOT LIKE '%@%'
                                   AND ROWNUM = 1),
                                1,
                                30),
                        '.')
                    PHONE,
                NVL (
                        (SELECT V_CONTACT_NUMBER
                         FROM GNDT_COMPMOBILE_CONTACTS H
                         WHERE     H.V_COMPANY_CODE = C.V_COMPANY_CODE
                           AND H.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
                           AND V_CONTACT_NUMBER LIKE '%@%'
                           AND ROWNUM = 1),
                        '.')
                    EMAIL_ADDRESS,
                'XUGL' || C.V_COMPANY_CODE || 'C' LEGACY_REF1
            FROM GNMM_COMPANY_MASTER C
            WHERE     C.V_COMPANY_CODE = V_COMPANYCODE
              AND C.V_COMPANY_BRANCH = V_COMPANYBRANCH;



        V_SUPPLIER_COUNT        NUMBER := 0;
        V_SUPPLIER_SITE_COUNT   NUMBER := 0;
        V_PIN_COUNT             NUMBER := 0;

        V_CSP_PIN_NO            VARCHAR2 (50);
        V_SITE_COUNT            NUMBER := 0;
        V_CONTACT_COUNT         NUMBER := 0;
    BEGIN
        FOR I IN SUPPLIERS
            LOOP
                BEGIN
                    SELECT COUNT (*)
                    INTO V_SUPPLIER_COUNT
                    FROM JHL_OFA_CO_SUPPLIER
                    WHERE     V_COMPANY_CODE = I.V_COMPANY_CODE
                      AND V_COMPANY_BRANCH = I.V_COMPANY_BRANCH;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_SUPPLIER_COUNT := 0;
                END;

                IF V_SUPPLIER_COUNT = 0
                THEN
                    SELECT NVL (MAX (CSP_PIN_COUNT), 0)
                    INTO V_PIN_COUNT
                    FROM JHL_OFA_CO_SUPPLIER;

                    V_PIN_COUNT := V_PIN_COUNT + 1;

                    INSERT INTO JHL_OFA_CO_SUPPLIER (CSP_NO,
                                                     V_COMPANY_CODE,
                                                     V_COMPANY_BRANCH,
                                                     CSP_PIN_NO,
                                                     CSP_DATE,
                                                     CSP_PIN_COUNT)
                    VALUES (JHL_CSP_NO_SEQ.NEXTVAL,
                            I.V_COMPANY_CODE,
                            I.V_COMPANY_BRANCH,
                            'XUGL' || V_PIN_COUNT || 'C',
                            SYSDATE,
                            V_PIN_COUNT);
                END IF;


                BEGIN
                    SELECT CSP_PIN_NO
                    INTO V_CSP_PIN_NO
                    FROM JHL_OFA_CO_SUPPLIER
                    WHERE     V_COMPANY_CODE = I.V_COMPANY_CODE
                      AND V_COMPANY_BRANCH = I.V_COMPANY_BRANCH;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            RAISE_ERROR ('Error Getting Pin number');
                END;



                IF V_CSP_PIN_NO IS NULL
                THEN
                    RAISE_ERROR ('Pin Number is null');
                END IF;

                BEGIN
                    SELECT COUNT (*)
                    INTO V_PIN_COUNT
                    FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                    WHERE PAY_GROUP = 'ISF-CORPORATE' AND LEGACY_REF1 = V_CSP_PIN_NO;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_PIN_COUNT := 0;
                END;















                IF V_PIN_COUNT = 0
                THEN
                    INSERT
                    INTO XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM (SEQ_ID,
                                                                PROCESS_FLAG,
                                                                VENDOR_NAME,
                                                                ENABLED_FLAG,
                                                                TYPE_OF_SUPPLIER,
                                                                TERMS_NAME,
                                                                PAY_GROUP,
                                                                PAY_PRIORITY,
                                                                INVOICE_CURRENCY,
                                                                PAYMENT_CURRENCY,
                                                                HOLD_FLAG,
                                                                TERMS_DATE_BASIS,
                                                                INSPEC_REQ_FLAG,
                                                                RCPT_REQUIRED_FLAG,
                                                                MATCH_OPTION,
                                                                PAYM_METHOD_CODE,
                                                                LEGACY_REF1,
                                                                LEGACY_REF2,
                                                                LEGACY_REF3,
                                                                LEGACY_REF4,
                                                                LEGACY_REF5,
                                                                LEGACY_REF6,
                                                                LEGACY_REF7,
                                                                LEGACY_REF9,
                                                                LEGACY_REF11,
                                                                LAST_UPDATE_DATE)
                    VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                            1,
                            I.VENDOR_NAME,
                            I.ENABLED_FLAG,
                            I.TYPE_OF_SUPPLIER,
                            I.TERMS_NAME,
                            I.PAY_GROUP,
                            I.PAY_PRIORITY,
                            I.INVOICE_CURRENCY,
                            I.PAYMENT_CURRENCY,
                            I.HOLD_FLAG,
                            I.TERMS_DATE_BASIS,
                            I.INSPEC_REQ_FLAG,
                            I.RCPT_REQUIRED_FLAG,
                            I.MATCH_OPTION,
                            I.PAYM_METHOD_CODE,
                            V_CSP_PIN_NO,
                            I.LEGACY_REF2,
                            I.LEGACY_REF3,
                            I.LEGACY_REF4,
                            I.LEGACY_REF5,
                            I.LEGACY_REF6,
                            I.LEGACY_REF7,
                            I.LEGACY_REF9,
                            I.LEGACY_REF11,
                            I.LAST_UPDATE_DATE);
                END IF;

                FOR J IN SUPPLIER_SITE (I.V_COMPANY_CODE, I.V_COMPANY_BRANCH)
                    LOOP
                        BEGIN
                            SELECT COUNT (*)
                            INTO V_SUPPLIER_SITE_COUNT
                            FROM JHL_OFA_CO_SUPPLIER_SITE
                            WHERE     V_COMPANY_CODE = I.V_COMPANY_CODE
                              AND V_COMPANY_BRANCH = I.V_COMPANY_BRANCH
                              AND NVL (V_POLICY_NO, 'XXXXX') =
                                  NVL (J.LEGACY_REF3, 'XXXXX');
                        EXCEPTION
                            WHEN OTHERS
                                THEN
                                    V_SUPPLIER_SITE_COUNT := 0;
                        END;



                        BEGIN
                            SELECT COUNT (*)
                            INTO V_SITE_COUNT
                            FROM APPS.XXJIC_AP_SUPPLIER_MAP@JICOFPROD.COM
                            WHERE     LOB_NAME IN ('JHL_UG_LIF_OU')
                              AND PIN_NO = V_CSP_PIN_NO
                              AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE;
                        EXCEPTION
                            WHEN OTHERS
                                THEN
                                    V_SITE_COUNT := 0;
                        END;



                        IF V_SITE_COUNT = 0
                        THEN
                            BEGIN
                                SELECT COUNT (*)
                                INTO V_SITE_COUNT
                                FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                                WHERE     PAY_GRP_LKP_CODE = 'ISF-CORPORATE'
                                  AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE
                                  AND LEGACY_REF1 = V_CSP_PIN_NO
                                  AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_SITE_COUNT := 0;
                            END;
                        END IF;


                        IF V_SUPPLIER_SITE_COUNT = 0
                        THEN
                            INSERT INTO JHL_OFA_CO_SUPPLIER_SITE (CSPS_NO,
                                                                  V_COMPANY_CODE,
                                                                  V_COMPANY_BRANCH,
                                                                  V_POLICY_NO,
                                                                  CSPS_DATE)
                            VALUES (JHL_CSPS_NO_SEQ.NEXTVAL,
                                    I.V_COMPANY_CODE,
                                    I.V_COMPANY_BRANCH,
                                    J.LEGACY_REF3,
                                    SYSDATE);
                        END IF;


                        IF V_SITE_COUNT = 0
                        THEN
                            INSERT
                            INTO XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM (
                                SEQ_ID,
                                PROCESS_FLAG,
                                VENDOR_SITE_CODE,
                                PURCHASIN_SITE_FLAG,
                                RFQ_ONLY_SITE_FLAG,
                                PAY_SITE_FLAG,
                                ADDRESS_LINE1,
                                CITY,
                                STATE,
                                ZIP,
                                COUNTRY,
                                TERMS_DATE_BASIS,
                                PAY_GRP_LKP_CODE,
                                TERMS_NAME,
                                INV_CURR_CODE,
                                PYMT_CURR_CODE,
                                OPERATING_UNIT,
                                MATCH_OPTION,
                                PAYMENT_METHOD_CODE,
                                PREPAYMENT_ACCOUNT,
                                PREPAYMENT_ACCOUNT_ID,
                                LIABILITY_ACCOUNT,
                                LIABILITY_ACCOUNT_ID,
                                LEGACY_REF1,
                                LEGACY_REF2,
                                LEGACY_REF3,
                                LEGACY_REF4,
                                LEGACY_REF5,
                                LEGACY_REF6,
                                LEGACY_REF7,
                                LEGACY_REF8,
                                LEGACY_REF9,
                                LEGACY_REF10)
                            VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                    1,
                                    J.VENDOR_SITE_CODE,
                                    J.PURCHASIN_SITE_FLAG,
                                    J.RFQ_ONLY_SITE_FLAG,
                                    J.PAY_SITE_FLAG,
                                    J.ADDRESS_LINE1,
                                    J.CITY,
                                    J.STATE,
                                    J.ZIP,
                                    J.COUNTRY,
                                    J.TERMS_DATE_BASIS,
                                    J.PAY_GRP_LKP_CODE,
                                    J.TERMS_NAME,
                                    J.INV_CURR_CODE,
                                    J.PYMT_CURR_CODE,
                                    J.OPERATING_UNIT,
                                    J.MATCH_OPTION,
                                    J.PAYMENT_METHOD_CODE,
                                    J.PREPAYMENT_ACCOUNT_ID,
                                    J.PREPAYMENT_ACCOUNT_ID,
                                    J.LIABILITY_ACCOUNT,
                                    J.LIABILITY_ACCOUNT,
                                    V_CSP_PIN_NO,
                                    J.LEGACY_REF2,
                                    J.LEGACY_REF3,
                                    J.LEGACY_REF4,
                                    J.LEGACY_REF5,
                                    J.LEGACY_REF6,
                                    J.LEGACY_REF7,
                                    J.LEGACY_REF8,
                                    J.LEGACY_REF9,
                                    J.LEGACY_REF10);
                        END IF;
                    END LOOP;


                FOR C IN SUPPLIER_CONTACT (I.V_COMPANY_CODE, I.V_COMPANY_BRANCH)
                    LOOP
                        BEGIN
                            SELECT COUNT (*)
                            INTO V_CONTACT_COUNT
                            FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                            WHERE     LEGACY_REF1 = V_CSP_PIN_NO
                              AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                        EXCEPTION
                            WHEN OTHERS
                                THEN
                                    V_CONTACT_COUNT := 0;
                        END;


                        IF V_CONTACT_COUNT = 0
                        THEN
                            INSERT
                            INTO XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM (
                                PROCESS_FLAG,
                                OPERATING_UNIT,
                                FIRST_NAME,
                                LAST_NAME,
                                PHONE,
                                EMAIL_ADDRESS,
                                LEGACY_REF1,
                                SEQ_ID)
                            VALUES (1,
                                    C.OPERATING_UNIT,
                                    SUBSTR (C.FIRST_NAME, 1, 50),
                                    C.LAST_NAME,
                                    C.PHONE,
                                    C.EMAIL_ADDRESS,
                                    V_CSP_PIN_NO,
                                    XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM);
                        END IF;
                    END LOOP;



                BEGIN
                    SELECT COUNT (*)
                    INTO V_SITE_COUNT
                    FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                    WHERE     PAY_GRP_LKP_CODE = 'ISF-CORPORATE'
                      AND LEGACY_REF1 = V_CSP_PIN_NO
                      AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_SITE_COUNT := 0;
                END;



                IF V_SITE_COUNT = 0
                THEN
                    DELETE FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                    WHERE     PAY_GROUP = 'ISF-CORPORATE'
                      AND LEGACY_REF1 = V_CSP_PIN_NO
                      AND LEGACY_REF9 = 'Uganda';

                    DELETE FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                    WHERE     LEGACY_REF1 = V_CSP_PIN_NO
                      AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                END IF;
            END LOOP;
    END;



    PROCEDURE JHL_OFA_PAYABLES_PROC
        IS
        CURSOR VOUCHERS
            IS
            SELECT V_VOU_DESC, V_VOU_NO, D_VOU_DATE
            FROM PYMT_VOUCHER_ROOT PM, PYMT_VOU_MASTER PV
            WHERE     PM.V_MAIN_VOU_NO = PV.V_MAIN_VOU_NO
              AND TO_DATE (D_VOU_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                    '01-JAN-20',
                    'DD/MM/RRRR')
                AND TO_DATE (
                                SYSDATE,
                                'DD/MM/RRRR')
              AND JHL_GEN_PKG.IS_VOUCHER_CANCELLED (V_VOU_NO) = 'N'
              AND JHL_GEN_PKG.IS_VOUCHER_AUTHORIZED (V_VOU_NO) = 'Y'
              and V_VOU_NO NOT IN ('2021020177');
--and V_VOU_NO IN ('2023007522');









        V_START_DATE   DATE;
    BEGIN














        V_START_DATE := SYSDATE;

        FOR I IN VOUCHERS
            LOOP
                BEGIN




































                    JHL_OFA_TRANSFORM_GL_VOU (I.V_VOU_NO);





                END;

                COMMIT;
            END LOOP;

        INSERT INTO JHL_OFA_JOBS (OJB_ID,
                                  OJB_NAME,
                                  OJB_START_DT,
                                  OJB_END_DT)
        VALUES (JHL_OJB_ID_SEQ.NEXTVAL,
                'JHL_OFA_PAYABLES_PROC',
                V_START_DATE,
                SYSDATE);

        COMMIT;
    END;

    PROCEDURE JHL_OFA_TRANSFORM_GL_VOU_PROC (V_VOUCHER_NO VARCHAR2)
        IS
        CURSOR VOUCHERS
            IS
            SELECT V_GL_CODE ACCT_CODE,
                   V_PROCESS_CODE,
                   SUM (DECODE (V_TYPE, 'D', -N_AMT, N_AMT)) AMOUNT,
                   DECODE (V_DESC, 'INCOME_TAX', 'WHT TAX', V_DESC) V_DESC,
                   (SELECT DISTINCT OFA_ACC_CODE
                    FROM JHL_ISF_OFA_ACC_MAP ACCS
                    WHERE     ACCS.ISF_GL_CODE = D.V_GL_CODE
                      AND OFA_ACC_CODE IS NOT NULL
                      AND ACCS.ACC_DESC = D.V_DESC)
                       OFA_ACC_CODE,
                   DECODE (SIGN (SUM (DECODE (V_TYPE, 'D', -N_AMT, N_AMT))),
                           -1, 1,
                           2)
                       ORD,
                   V_DOCU_REF_NO V_VOU_NO,
                   BPG_FINANCE_BATCHES.BFN_GET_PAYEE_NAME (V_DOCU_REF_NO)
                       VENDOR_NAME,
                   ABS (SUM (DECODE (V_TYPE, 'D', -N_AMT, N_AMT))) AMT
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE     M.N_REF_NO = D.N_REF_NO
              AND M.V_JOURNAL_STATUS = 'C'

              AND V_DOCU_TYPE = 'VOUCHER'
              AND TO_DATE (M.D_POSTED_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                    '01-JAN-17',
                    'DD/MM/RRRR')
                AND TO_DATE (
                        '31-JAN-17',
                        'DD/MM/RRRR')

              AND V_DOCU_REF_NO = V_VOUCHER_NO
            GROUP BY V_GL_CODE,
                     V_PROCESS_CODE,
                     V_DESC,
                     V_DOCU_REF_NO
            ORDER BY ORD, AMT DESC;


        CURSOR VOUCHER
            IS
            SELECT V_VOU_DESC,
                   V_PAYEE_NAME,
                   N_CUST_REF_NO,
                   V_COMPANY_CODE,
                   V_COMPANY_BRANCH,
                   V_IND_COMPANY,
                   PM.V_MAIN_VOU_NO V_MAIN_VOU_NO,
                   N_VOU_AMOUNT,
                   D_VOU_DATE,
                   'UGX' V_CURRENCY_CODE
            FROM PYMT_VOUCHER_ROOT PM, PYMT_VOU_MASTER PV
            WHERE     PM.V_MAIN_VOU_NO = PV.V_MAIN_VOU_NO
              AND PV.V_VOU_NO = V_VOUCHER_NO;



        PAYEE_NAME        VARCHAR (400);
        V_N_CUST_REF_NO   NUMBER (25);
        COMPANY_CODE      VARCHAR2 (20);
        COMPANY_BRANCH    VARCHAR2 (50);
        IND_COMPANY       VARCHAR2 (2);


        V_PAY_AMOUNT      NUMBER;
        V_SIGN            NUMBER;
        V_GROSS_AMT       NUMBER;
        V_ACCOUNT         VARCHAR2 (50);
        V_DESC            VARCHAR2 (200);
        V_ACCT_CODE       VARCHAR2 (50);
        V_COUNT           NUMBER;
        POLICY_NO         VARCHAR2 (30);
        V_PIN_NO          VARCHAR2 (30);

        V_AMOUNT          NUMBER;
        MAIN_VOU_NO       VARCHAR2 (50);
        VOU_COUNT         NUMBER;
        V_SITE_CODE       VARCHAR2 (50);

        V_TOTAL_AMOUNT    NUMBER;

        V_ERROR_MESSAGE   VARCHAR2 (1000);
        V_EXIST_COUNT     NUMBER := 0;
        V_VOU_DATE        DATE;

        V_AGENT_NO        NUMBER;
        CURRENCY_CODE     VARCHAR2 (100);

        V_POLICY_COUNT    NUMBER;
    BEGIN
        VOU_COUNT := 0;

        SELECT COUNT (*)
        INTO VOU_COUNT
        FROM JHL_OFA_PYMT_TRANSACTIONS
        WHERE V_VOU_NO = V_VOUCHER_NO;

        V_AGENT_NO := NULL;

        IF VOU_COUNT = 0
        THEN
            V_COUNT := 0;

            FOR I IN VOUCHERS
                LOOP
                    IF I.ACCT_CODE <> '115092'
                    THEN
                        V_COUNT := V_COUNT + 1;

                        FOR V IN VOUCHER
                            LOOP
                                V_DESC := V.V_VOU_DESC;
                                PAYEE_NAME := V.V_PAYEE_NAME;
                                V_N_CUST_REF_NO := V.N_CUST_REF_NO;
                                COMPANY_CODE := V.V_COMPANY_CODE;
                                COMPANY_BRANCH := V.V_COMPANY_BRANCH;
                                IND_COMPANY := V.V_IND_COMPANY;
                                MAIN_VOU_NO := V.V_MAIN_VOU_NO;
                                V_PAY_AMOUNT := V.N_VOU_AMOUNT;
                                V_SIGN := SIGN (V.N_VOU_AMOUNT);
                                V_VOU_DATE := V.D_VOU_DATE;
                                CURRENCY_CODE := V.V_CURRENCY_CODE;
                            END LOOP;



                        IF IND_COMPANY = 'I'
                        THEN
                            BEGIN
                                SELECT COUNT (*)
                                INTO V_POLICY_COUNT
                                FROM GNMT_POLICY P
                                WHERE     P.N_PAYER_REF_NO = V_N_CUST_REF_NO
                                  AND P.N_PAYER_REF_NO IS NOT NULL;
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_POLICY_COUNT := 0;
                            END;
                        ELSE
                            BEGIN
                                SELECT COUNT (*)
                                INTO V_POLICY_COUNT
                                FROM GNMT_POLICY P
                                WHERE     P.V_COMPANY_CODE = COMPANY_CODE
                                  AND P.V_COMPANY_BRANCH = COMPANY_BRANCH
                                  AND P.V_COMPANY_CODE IS NOT NULL;
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_POLICY_COUNT := 0;
                            END;
                        END IF;





                        POLICY_NO := NULL;

                        IF     V_POLICY_COUNT > 0
                            AND UPPER (V_DESC) NOT IN
                                ('REFUND COMPANY OVERSHOT',
                                 'MEDICAL FEES PAYMENT',
                                 'COMMISSION')
                        THEN
                            IF IND_COMPANY = 'I'
                            THEN
                                BEGIN
                                    SELECT V_POLICY_NO
                                    INTO POLICY_NO
                                    FROM PYDT_VOUCHER_POLICY_CLIENT
                                    WHERE     V_VOU_NO = V_VOUCHER_NO
                                      AND V_POLICY_NO IN
                                          (SELECT V_POLICY_NO
                                           FROM GNMT_POLICY P
                                           WHERE     P.N_PAYER_REF_NO =
                                                     V_N_CUST_REF_NO
                                             AND P.N_PAYER_REF_NO
                                               IS NOT NULL);
                                EXCEPTION
                                    WHEN OTHERS
                                        THEN
                                            POLICY_NO := NULL;
                                END;
                            ELSE
                                BEGIN
                                    SELECT V_POLICY_NO
                                    INTO POLICY_NO
                                    FROM PYDT_VOUCHER_POLICY_CLIENT
                                    WHERE     V_VOU_NO = V_VOUCHER_NO
                                      AND V_POLICY_NO IN
                                          (SELECT V_POLICY_NO
                                           FROM GNMT_POLICY P
                                           WHERE     P.V_COMPANY_CODE =
                                                     COMPANY_CODE
                                             AND P.V_COMPANY_BRANCH =
                                                 COMPANY_BRANCH
                                             AND P.V_COMPANY_CODE
                                               IS NOT NULL);
                                EXCEPTION
                                    WHEN OTHERS
                                        THEN
                                            POLICY_NO := NULL;
                                END;
                            END IF;
                        END IF;





                        IF IND_COMPANY = 'I'
                        THEN
                            V_SITE_CODE := NVL (POLICY_NO, 'PYR-' || V_N_CUST_REF_NO);



                            CREATE_INDIVIDUAL_SUPPLIER (V_N_CUST_REF_NO);

                            BEGIN
                                SELECT OSP_PIN_NO
                                INTO V_PIN_NO
                                FROM JHL_OFA_SUPPLIER
                                WHERE N_CUST_REF_NO = V_N_CUST_REF_NO;
                            EXCEPTION


                                WHEN OTHERS
                                    THEN
                                        RAISE_ERROR (
                                                'ERROR GETTING pIN NUMBER  CO CODE=='
                                                    || V_N_CUST_REF_NO
                                                    || ' NAME ='
                                                    || PAYEE_NAME);

                            END;



                            IF V_SITE_CODE IS NULL
                            THEN
                                RAISE_ERROR (
                                        ' Site Code missing '
                                            || V_N_CUST_REF_NO
                                            || ' ;;;;'
                                            || V_DESC
                                            || ' ;;;;'
                                            || POLICY_NO);
                            END IF;
                        ELSE
                            V_SITE_CODE :=
                                    NVL (
                                            POLICY_NO,
                                            SUBSTR (
                                                    TO_CHAR (COMPANY_CODE || '-' || COMPANY_BRANCH),
                                                    1,
                                                    15));


                            CREATE_CORPORATE_SUPPLIER (COMPANY_CODE, COMPANY_BRANCH);



                            BEGIN
                                SELECT CSP_PIN_NO
                                INTO V_PIN_NO
                                FROM JHL_OFA_CO_SUPPLIER
                                WHERE     V_COMPANY_CODE = COMPANY_CODE
                                  AND V_COMPANY_BRANCH = COMPANY_BRANCH;
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        RAISE_ERROR (
                                                'ERROR GETTING pIN NUMBER  CO CODE=='
                                                    || COMPANY_CODE
                                                    || ' BRN ='
                                                    || COMPANY_BRANCH);
                            END;
                        END IF;


                        V_AMOUNT := I.AMOUNT * V_SIGN * -1;





                        INSERT INTO JHL_OFA_PYMT_TRANSACTIONS (OPT_NO,
                                                               V_VOU_NO,
                                                               LEGACY_SUPPLIER_CODE,
                                                               VENDOR_NAME,
                                                               VENDOR_SITE_CODE,
                                                               INVOICE_AMOUNT,
                                                               INVOICE_CURRENCY_CODE,
                                                               EXCHANGE_RATE,
                                                               DESCRIPTION,
                                                               LIABILITY_ACCOUNT,
                                                               LINE_NUMBER,
                                                               LEGACY_REF1,
                                                               LINE_AMOUNT,
                                                               N_CUST_REF_NO,
                                                               V_COMPANY_CODE,
                                                               V_COMPANY_BRANCH,
                                                               V_MAIN_VOU_NO,
                                                               LEGACY_REF3,
                                                               V_VOU_DATE)
                        VALUES (
                                   OFA_OPT_NO_SEQ.NEXTVAL,
                                   I.V_VOU_NO,
                                   NVL (
                                           TO_CHAR (V_N_CUST_REF_NO),
                                           TO_CHAR (
                                                   COMPANY_CODE || '-' || COMPANY_BRANCH)),
                                   I.VENDOR_NAME,
                                   V_SITE_CODE,
                                   V_PAY_AMOUNT,
                                   CURRENCY_CODE,
                                   1,
                                   I.V_DESC,
                                   I.OFA_ACC_CODE,
                                   V_COUNT,
                                   V_PIN_NO,
                                   V_AMOUNT,
                                   V_N_CUST_REF_NO,
                                   COMPANY_CODE,
                                   COMPANY_BRANCH,
                                   MAIN_VOU_NO,
                                   POLICY_NO,
                                   V_VOU_DATE);
                    END IF;
                END LOOP;

            SELECT SUM (LINE_AMOUNT)
            INTO V_TOTAL_AMOUNT
            FROM JHL_OFA_PYMT_TRANSACTIONS
            WHERE V_VOU_NO = V_VOUCHER_NO;

            UPDATE JHL_OFA_PYMT_TRANSACTIONS
            SET INVOICE_AMOUNT = V_TOTAL_AMOUNT
            WHERE V_VOU_NO = V_VOUCHER_NO;

            BEGIN
                SELECT COUNT (*)
                INTO V_EXIST_COUNT
                FROM APPS.XXJIC_AP_CLAIM_MAP@JICOFPROD.COM
                WHERE     LOB_NAME = 'JHL_UG_LIF_OU'
                  AND PAYMENT_VOUCHER = V_VOUCHER_NO;
            EXCEPTION
                WHEN OTHERS
                    THEN
                        V_EXIST_COUNT := 0;
            END;

            IF V_EXIST_COUNT = 0
            THEN
                BEGIN
                    SELECT COUNT (*)
                    INTO V_EXIST_COUNT
                    FROM XXJICUG_AP_INVOICES_STG@JICOFPROD.COM
                    WHERE     OPERATING_UNIT = 'JHL_UG_LIF_OU'
                      AND VOUCHER_NUM = V_VOUCHER_NO;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_EXIST_COUNT := 0;
                END;
            END IF;


            IF V_EXIST_COUNT = 0 AND V_TOTAL_AMOUNT <> 0
            THEN
                JHL_OFA_GL_VOUCHERS_NEW (V_VOUCHER_NO);
            END IF;
        END IF;
    EXCEPTION
        WHEN OTHERS
            THEN
                RAISE_ERROR ('v_voucher_no==' || V_VOUCHER_NO);
    END;



    PROCEDURE JHL_OFA_TRANSFORM_GL_VOU_BK (V_VOUCHER_NO VARCHAR2)
        IS
        CURSOR VOUCHERS
            IS
            SELECT V_GL_CODE ACCT_CODE,
                   V_PROCESS_CODE,
                   SUM (DECODE (V_TYPE, 'D', -N_AMT, N_AMT)) AMOUNT,
                   DECODE (V_DESC, 'INCOME_TAX', 'WHT TAX', V_DESC) V_DESC,
                   (SELECT DISTINCT OFA_ACC_CODE
                    FROM JHL_ISF_OFA_ACC_MAP
                    WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                      AND TRIM (ACC_DESC) = TRIM (D.V_DESC))
                       OFA_ACC_CODE,
                   DECODE (SIGN (SUM (DECODE (V_TYPE, 'D', -N_AMT, N_AMT))),
                           -1, 1,
                           2)
                       ORD,
                   V_DOCU_REF_NO V_VOU_NO,
                   BPG_FINANCE_BATCHES.BFN_GET_PAYEE_NAME (V_DOCU_REF_NO)
                       VENDOR_NAME,
                   ABS (SUM (DECODE (V_TYPE, 'D', -N_AMT, N_AMT))) AMT
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
              AND V_DOCU_TYPE = 'VOUCHER'
              AND V_DOCU_REF_NO = V_VOUCHER_NO
            GROUP BY V_GL_CODE,
                     V_PROCESS_CODE,
                     V_DESC,
                     V_DOCU_REF_NO
            ORDER BY ORD, AMT DESC;


        CURSOR VOUCHER
            IS
            SELECT V_VOU_DESC,
                   V_PAYEE_NAME,
                   N_CUST_REF_NO,
                   V_COMPANY_CODE,
                   V_COMPANY_BRANCH,
                   V_IND_COMPANY,
                   PM.V_MAIN_VOU_NO V_MAIN_VOU_NO,
                   N_VOU_AMOUNT,
                   D_VOU_DATE,
                   DECODE (V_CURRENCY_CODE, 'UGS', 'UGX', V_CURRENCY_CODE)
                                    V_CURRENCY_CODE
            FROM PYMT_VOUCHER_ROOT PM, PYMT_VOU_MASTER PV
            WHERE     PM.V_MAIN_VOU_NO = PV.V_MAIN_VOU_NO
              AND PV.V_VOU_NO = V_VOUCHER_NO;



        PAYEE_NAME        VARCHAR (400);
        V_N_CUST_REF_NO   NUMBER (25);
        COMPANY_CODE      VARCHAR2 (20);
        COMPANY_BRANCH    VARCHAR2 (50);
        IND_COMPANY       VARCHAR2 (2);


        V_PAY_AMOUNT      NUMBER;
        V_SIGN            NUMBER;
        V_GROSS_AMT       NUMBER;
        V_ACCOUNT         VARCHAR2 (50);
        V_DESC            VARCHAR2 (200);
        V_ACCT_CODE       VARCHAR2 (50);
        V_COUNT           NUMBER;
        POLICY_NO         VARCHAR2 (30);
        V_PIN_NO          VARCHAR2 (30);

        V_AMOUNT          NUMBER;
        MAIN_VOU_NO       VARCHAR2 (50);
        VOU_COUNT         NUMBER;
        V_SITE_CODE       VARCHAR2 (50);

        V_TOTAL_AMOUNT    NUMBER;

        V_ERROR_MESSAGE   VARCHAR2 (1000);
        V_EXIST_COUNT     NUMBER := 0;
        V_VOU_DATE        DATE;
        CURRENCY_CODE     VARCHAR2 (100);

        V_AGENT_NO        NUMBER;
    BEGIN
        VOU_COUNT := 0;

        SELECT COUNT (*)
        INTO VOU_COUNT
        FROM JHL_OFA_PYMT_TRANSACTIONS
        WHERE V_VOU_NO = V_VOUCHER_NO;

        V_AGENT_NO := NULL;

        IF VOU_COUNT = 0
        THEN
            V_COUNT := 0;

            FOR I IN VOUCHERS
                LOOP
                    IF I.ACCT_CODE <> '115092'
                    THEN
                        V_COUNT := V_COUNT + 1;



                        FOR V IN VOUCHER
                            LOOP
                                V_DESC := V.V_VOU_DESC;
                                PAYEE_NAME := V.V_PAYEE_NAME;
                                V_N_CUST_REF_NO := V.N_CUST_REF_NO;
                                COMPANY_CODE := V.V_COMPANY_CODE;
                                COMPANY_BRANCH := V.V_COMPANY_BRANCH;
                                IND_COMPANY := V.V_IND_COMPANY;
                                MAIN_VOU_NO := V.V_MAIN_VOU_NO;
                                V_PAY_AMOUNT := V.N_VOU_AMOUNT;
                                V_SIGN := SIGN (V.N_VOU_AMOUNT);
                                V_VOU_DATE := V.D_VOU_DATE;
                                CURRENCY_CODE := V.V_CURRENCY_CODE;
                            END LOOP;

                        BEGIN
                            SELECT DISTINCT V_POLICY_NO
                            INTO POLICY_NO
                            FROM PYDT_VOUCHER_POLICY_CLIENT
                            WHERE V_VOU_NO = V_VOUCHER_NO;
                        EXCEPTION
                            WHEN OTHERS
                                THEN
                                    POLICY_NO := NULL;
                        END;





                        IF IND_COMPANY = 'I'
                        THEN
                            IF V_DESC = 'COMMISSION'
                            THEN
                                V_AGENT_NO := NULL;


                                BEGIN
                                    SELECT TO_CHAR (
                                                   TRIM (N_AGENT_NO || ' - ' || V_AGENT_CODE))
                                    INTO V_SITE_CODE
                                    FROM AMMM_AGENT_MASTER AGN
                                    WHERE     AGN.N_CUST_REF_NO = V_N_CUST_REF_NO
                                      AND V_STATUS = 'A';
                                EXCEPTION
                                    WHEN NO_DATA_FOUND
                                        THEN
                                            SELECT MAX (
                                                           TO_CHAR (
                                                                   TRIM (
                                                                           N_AGENT_NO
                                                                               || ' - '
                                                                               || V_AGENT_CODE)))
                                            INTO V_SITE_CODE
                                            FROM AMMM_AGENT_MASTER AGN
                                            WHERE AGN.N_CUST_REF_NO = V_N_CUST_REF_NO;
                                    WHEN OTHERS
                                        THEN



                                            RAISE_ERROR (
                                                    'Error getting agent No ' || V_N_CUST_REF_NO);
                                END;

                                SELECT N_AGENT_NO
                                INTO V_AGENT_NO
                                FROM AMMM_AGENT_MASTER AGN
                                WHERE     AGN.N_CUST_REF_NO = V_N_CUST_REF_NO
                                  AND TO_CHAR (
                                              TRIM (N_AGENT_NO || ' - ' || V_AGENT_CODE)) =
                                      V_SITE_CODE;
                            ELSE
                                V_SITE_CODE := POLICY_NO;
                            END IF;



                            CREATE_INDIVIDUAL_SUPPLIER (V_N_CUST_REF_NO, V_AGENT_NO);

                            BEGIN
                                SELECT OSP_PIN_NO
                                INTO V_PIN_NO
                                FROM JHL_OFA_SUPPLIER
                                WHERE N_CUST_REF_NO = V_N_CUST_REF_NO;
                            EXCEPTION


                                WHEN OTHERS
                                    THEN
                                        RAISE_ERROR (
                                                'ERROR GETTING pIN NUMBER  CO CODE=='
                                                    || V_N_CUST_REF_NO
                                                    || ' NAME ='
                                                    || PAYEE_NAME);

                            END;



                            IF V_SITE_CODE IS NULL
                            THEN
                                RAISE_ERROR (
                                        ' Site Code missing '
                                            || V_N_CUST_REF_NO
                                            || ' ;;;;'
                                            || V_DESC
                                            || ' ;;;;'
                                            || POLICY_NO);
                            END IF;
                        ELSE
                            IF V_DESC = 'COMMISSION'
                            THEN
                                V_AGENT_NO := NULL;



                                BEGIN
                                    SELECT TO_CHAR (
                                                   TRIM (N_AGENT_NO || ' - ' || V_AGENT_CODE))
                                    INTO V_SITE_CODE
                                    FROM AMMM_AGENT_MASTER AGN
                                    WHERE     AGN.V_COMPANY_CODE = COMPANY_CODE
                                      AND AGN.V_COMPANY_BRANCH = COMPANY_BRANCH
                                      AND V_STATUS = 'A';
                                EXCEPTION
                                    WHEN NO_DATA_FOUND
                                        THEN
                                            SELECT MAX (
                                                           TO_CHAR (
                                                                   TRIM (
                                                                           N_AGENT_NO
                                                                               || ' - '
                                                                               || V_AGENT_CODE)))
                                            INTO V_SITE_CODE
                                            FROM AMMM_AGENT_MASTER AGN
                                            WHERE     AGN.V_COMPANY_CODE = COMPANY_CODE
                                              AND AGN.V_COMPANY_BRANCH = COMPANY_BRANCH;
                                    WHEN OTHERS
                                        THEN
                                            RAISE_ERROR (
                                                    'Error getting agent No '
                                                        || COMPANY_CODE
                                                        || ' '
                                                        || COMPANY_BRANCH);
                                END;


                                SELECT N_AGENT_NO
                                INTO V_AGENT_NO
                                FROM AMMM_AGENT_MASTER AGN
                                WHERE     AGN.V_COMPANY_CODE = COMPANY_CODE
                                  AND AGN.V_COMPANY_BRANCH = COMPANY_BRANCH
                                  AND TO_CHAR (
                                              TRIM (N_AGENT_NO || ' - ' || V_AGENT_CODE)) =
                                      V_SITE_CODE;
                            ELSE
                                V_SITE_CODE := POLICY_NO;
                            END IF;


                            CREATE_CORPORATE_SUPPLIER (COMPANY_CODE,
                                                       COMPANY_BRANCH,
                                                       V_AGENT_NO);

                            BEGIN
                                SELECT CSP_PIN_NO
                                INTO V_PIN_NO
                                FROM JHL_OFA_CO_SUPPLIER
                                WHERE     V_COMPANY_CODE = COMPANY_CODE
                                  AND V_COMPANY_BRANCH = COMPANY_BRANCH;
                            EXCEPTION


                                WHEN OTHERS
                                    THEN
                                        RAISE_ERROR (
                                                'ERROR GETTING pIN NUMBER  CO CODE=='
                                                    || COMPANY_CODE
                                                    || ' BRN ='
                                                    || COMPANY_BRANCH);

                            END;




                        END IF;

                        V_AMOUNT := I.AMOUNT * V_SIGN * -1;






                        IF V_DESC LIKE '%OVERSHOT%'
                        THEN
                            POLICY_NO := NULL;
                            V_SITE_CODE :=
                                    SUBSTR (TO_CHAR (COMPANY_CODE || '-' || COMPANY_BRANCH),
                                            1,
                                            15);
                        END IF;



                        INSERT INTO JHL_OFA_PYMT_TRANSACTIONS (OPT_NO,
                                                               V_VOU_NO,
                                                               LEGACY_SUPPLIER_CODE,
                                                               VENDOR_NAME,
                                                               VENDOR_SITE_CODE,
                                                               INVOICE_AMOUNT,
                                                               INVOICE_CURRENCY_CODE,
                                                               EXCHANGE_RATE,
                                                               DESCRIPTION,
                                                               LIABILITY_ACCOUNT,
                                                               LINE_NUMBER,
                                                               LEGACY_REF1,
                                                               LINE_AMOUNT,
                                                               N_CUST_REF_NO,
                                                               V_COMPANY_CODE,
                                                               V_COMPANY_BRANCH,
                                                               V_MAIN_VOU_NO,
                                                               LEGACY_REF3,
                                                               V_VOU_DATE)
                        VALUES (
                                   OFA_OPT_NO_SEQ.NEXTVAL,
                                   I.V_VOU_NO,
                                   NVL (
                                           TO_CHAR (V_N_CUST_REF_NO),
                                           TO_CHAR (
                                                   COMPANY_CODE || '-' || COMPANY_BRANCH)),
                                   I.VENDOR_NAME,
                                   V_SITE_CODE,
                                   V_PAY_AMOUNT,
                                   CURRENCY_CODE,
                                   1,
                                   I.V_DESC,
                                   I.OFA_ACC_CODE,
                                   V_COUNT,
                                   V_PIN_NO,
                                   V_AMOUNT,
                                   V_N_CUST_REF_NO,
                                   COMPANY_CODE,
                                   COMPANY_BRANCH,
                                   MAIN_VOU_NO,
                                   POLICY_NO,
                                   V_VOU_DATE);





                    END IF;
                END LOOP;

            SELECT SUM (LINE_AMOUNT)
            INTO V_TOTAL_AMOUNT
            FROM JHL_OFA_PYMT_TRANSACTIONS
            WHERE V_VOU_NO = V_VOUCHER_NO;

            UPDATE JHL_OFA_PYMT_TRANSACTIONS
            SET INVOICE_AMOUNT = V_TOTAL_AMOUNT
            WHERE V_VOU_NO = V_VOUCHER_NO;

            BEGIN
                SELECT COUNT (*)
                INTO V_EXIST_COUNT
                FROM APPS.XXJIC_AP_CLAIM_MAP@JICOFPROD.COM
                WHERE     LOB_NAME = 'JHL_UG_LIF_OU'
                  AND PAYMENT_VOUCHER = V_VOUCHER_NO;
            EXCEPTION
                WHEN OTHERS
                    THEN
                        V_EXIST_COUNT := 0;
            END;










            IF V_EXIST_COUNT = 0
            THEN
                JHL_OFA_GL_VOUCHERS_NEW (V_VOUCHER_NO);
            END IF;



        END IF;



    END;


    PROCEDURE JHL_OFA_TRANSFORM_GL_VOU (V_VOUCHER_NO VARCHAR2)
        IS
        CURSOR VOUCHERS
            IS
            SELECT V_GL_CODE ACCT_CODE,
                   V_PROCESS_CODE,
                   SUM (DECODE (V_TYPE, 'D', -N_SOURCE_AMOUNT, N_SOURCE_AMOUNT))
                             AMOUNT,
                   DECODE (V_DESC, 'INCOME_TAX', 'WHT TAX', V_DESC) V_DESC,
                   (SELECT DISTINCT OFA_ACC_CODE
                    FROM JHL_ISF_OFA_ACC_MAP
                    WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                      AND TRIM (ACC_DESC) = TRIM (D.V_DESC))
                       OFA_ACC_CODE,
                   DECODE (
                           SIGN (
                                   SUM (
                                           DECODE (V_TYPE,
                                                   'D', -N_SOURCE_AMOUNT,
                                                   N_SOURCE_AMOUNT))),
                           -1, 1,
                           2)
                       ORD,
                   V_DOCU_REF_NO V_VOU_NO,
                   BPG_FINANCE_BATCHES.BFN_GET_PAYEE_NAME (V_DOCU_REF_NO)
                       VENDOR_NAME,
                   ABS (
                           SUM (
                                   DECODE (V_TYPE, 'D', -N_SOURCE_AMOUNT, N_SOURCE_AMOUNT)))
                       AMT,
                   N_CONVERSION_RATE
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE     M.N_REF_NO = D.N_REF_NO
              AND M.V_JOURNAL_STATUS = 'C'
              AND V_DOCU_TYPE = 'VOUCHER'
              AND V_DOCU_REF_NO = V_VOUCHER_NO
            GROUP BY V_GL_CODE,
                     V_PROCESS_CODE,
                     V_DESC,
                     V_DOCU_REF_NO,
                     N_CONVERSION_RATE
            ORDER BY ORD, AMT DESC;


        CURSOR VOUCHER
            IS
            SELECT V_VOU_DESC,
                   V_PAYEE_NAME,
                   N_CUST_REF_NO,
                   V_COMPANY_CODE,
                   V_COMPANY_BRANCH,
                   V_IND_COMPANY,
                   PM.V_MAIN_VOU_NO V_MAIN_VOU_NO,
                   N_VOU_AMOUNT,
                   D_VOU_DATE,
                   DECODE (V_CURRENCY_CODE, 'UGS', 'UGX', V_CURRENCY_CODE)
                                    V_CURRENCY_CODE
            FROM PYMT_VOUCHER_ROOT PM, PYMT_VOU_MASTER PV
            WHERE     PM.V_MAIN_VOU_NO = PV.V_MAIN_VOU_NO
              AND PV.V_VOU_NO = V_VOUCHER_NO;



        PAYEE_NAME            VARCHAR (400);
        V_N_CUST_REF_NO       NUMBER (25);
        COMPANY_CODE          VARCHAR2 (20);
        COMPANY_BRANCH        VARCHAR2 (50);
        IND_COMPANY           VARCHAR2 (2);


        V_PAY_AMOUNT          NUMBER;
        V_SIGN                NUMBER;
        V_GROSS_AMT           NUMBER;
        V_ACCOUNT             VARCHAR2 (50);
        V_DESC                VARCHAR2 (200);
        V_ACCT_CODE           VARCHAR2 (50);
        V_COUNT               NUMBER;
        POLICY_NO             VARCHAR2 (30);
        V_PIN_NO              VARCHAR2 (30);

        V_AMOUNT              NUMBER;
        MAIN_VOU_NO           VARCHAR2 (50);
        VOU_COUNT             NUMBER;
        V_SITE_CODE           VARCHAR2 (50);

        V_TOTAL_AMOUNT        NUMBER;

        V_ERROR_MESSAGE       VARCHAR2 (1000);
        V_EXIST_COUNT         NUMBER := 0;
        V_VOU_DATE            DATE;

        V_AGENT_NO            NUMBER;
        CURRENCY_CODE         VARCHAR2 (100);

        V_POLICY_COUNT        NUMBER;

        V_POL_TYPE            VARCHAR2 (2);
        V_POL_NO              VARCHAR2 (250);

        V_POL_PAYER           NUMBER (25);
        V_CO_CODE             VARCHAR2 (20);
        V_CO_BRH              VARCHAR2 (50);
        V_DIFF_PAYEE_NAME     VARCHAR (400);
        V_VENDOR_NAME         VARCHAR (400);
        V_PAY_GROUP           VARCHAR2 (50);

        V_POST_COUNT          NUMBER := 0;
        V_ST_ERROR_COUNT      NUMBER := 0;
        V_LEG_SUP_CODE        VARCHAR2 (150);

        V_VOU_AUTH_DATE       DATE;

        V_VOU_APPROVED        VARCHAR2 (5) := 'N';

        V_CHANNEL             VARCHAR2 (30);
        V_PRODUCT             VARCHAR2 (30);
        V_ACC_COUNT           NUMBER := 0;


        V_EMAIL_NO            VARCHAR2 (150);
        V_PHONE_NO            VARCHAR2 (150);

        V_CONTROL_ACC_COUNT   NUMBER := 0;
    BEGIN
        V_POST_COUNT := 0;

        SELECT COUNT (*)
        INTO V_POST_COUNT

        FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
        WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
          AND V_DOCU_TYPE = 'VOUCHER'

          AND V_DOCU_REF_NO = V_VOUCHER_NO;

        VOU_COUNT := 0;

        SELECT COUNT (*)
        INTO VOU_COUNT
        FROM JHL_OFA_PYMT_TRANSACTIONS
        WHERE V_VOU_NO = V_VOUCHER_NO;


        V_ST_ERROR_COUNT := 0;

        SELECT COUNT (*)
        INTO V_ST_ERROR_COUNT

        FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
        WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS <> 'C'
          AND V_DOCU_TYPE = 'VOUCHER'

          AND V_DOCU_REF_NO = V_VOUCHER_NO;


        V_VOU_APPROVED := 'N';
        V_VOU_APPROVED := JHL_GEN_PKG.IS_VOUCHER_AUTHORIZED (V_VOUCHER_NO);

        V_ACC_COUNT := 0;

        SELECT COUNT (*)
        INTO V_ACC_COUNT
        FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
        WHERE     M.N_REF_NO = D.N_REF_NO
          AND M.V_JOURNAL_STATUS = 'C'

          AND V_DOCU_TYPE = 'VOUCHER'

          AND V_DOCU_REF_NO = V_VOUCHER_NO
          AND (SELECT DISTINCT OFA_ACC_CODE
               FROM JHL_ISF_OFA_ACC_MAP
               WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                 AND TRIM (ACC_DESC) = TRIM (D.V_DESC))
            IS NULL;


        SELECT COUNT (*)
        INTO V_CONTROL_ACC_COUNT
        FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
        WHERE     M.N_REF_NO = D.N_REF_NO
          AND M.V_JOURNAL_STATUS = 'C'
          AND V_DOCU_TYPE = 'VOUCHER'
          AND V_DESC LIKE '%PAYMENT CONTROL%'
          AND V_DOCU_REF_NO = V_VOUCHER_NO;



        DELETE FROM JHL_OFA_VOUCHER_ERRORS
        WHERE V_VOU_NO = V_VOUCHER_NO;





        IF V_ACC_COUNT <> 0
        THEN
            INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO,
                                                V_VOU_NO,
                                                OVE_DESC,
                                                V_GL_CODE,
                                                V_ACC_DESC)
            SELECT JHL_OVE_NO_SEQ.NEXTVAL,
                   V_VOUCHER_NO,
                   'MISSING ACCOUNT MAPPING',
                   V_GL_CODE,
                   V_DESC
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE     M.N_REF_NO = D.N_REF_NO
              AND M.V_JOURNAL_STATUS = 'C'

              AND V_DOCU_TYPE = 'VOUCHER'

              AND V_DOCU_REF_NO = V_VOUCHER_NO
              AND (SELECT DISTINCT OFA_ACC_CODE
                   FROM JHL_ISF_OFA_ACC_MAP
                   WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                     AND TRIM (ACC_DESC) = TRIM (D.V_DESC))
                IS NULL;


        END IF;


        IF V_ST_ERROR_COUNT <> 0
        THEN
            INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO, V_VOU_NO, OVE_DESC)
            VALUES (
                       JHL_OVE_NO_SEQ.NEXTVAL,
                       V_VOUCHER_NO,
                       'ISF ACCOUNTING ENTRIES ERROR');
        END IF;

        IF V_VOU_APPROVED <> 'Y'
        THEN
            INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO, V_VOU_NO, OVE_DESC)
            VALUES (
                       JHL_OVE_NO_SEQ.NEXTVAL,
                       V_VOUCHER_NO,
                       'VOUCHER IS NOT APPROVED IN ISF ');
        END IF;

        IF V_CONTROL_ACC_COUNT = 0
        THEN
            INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO, V_VOU_NO, OVE_DESC)
            VALUES (
                       JHL_OVE_NO_SEQ.NEXTVAL,
                       V_VOUCHER_NO,
                       'ISF CONTROL ACCOUNT MISSING');
        END IF;



        IF (    VOU_COUNT = 0
            AND V_POST_COUNT <> 0
            AND V_ST_ERROR_COUNT = 0
            AND V_VOU_APPROVED = 'Y'
            AND V_ACC_COUNT = 0)
        THEN





            BEGIN
                SELECT DISTINCT M.V_POLAG_TYPE, M.V_POLAG_NO
                INTO V_POL_TYPE, V_POL_NO
                FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
                WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
                  AND V_DOCU_TYPE = 'VOUCHER'

                  AND V_DOCU_REF_NO = V_VOUCHER_NO;
            EXCEPTION
                WHEN TOO_MANY_ROWS
                    THEN
                        BEGIN
                            SELECT DISTINCT M.V_POLAG_TYPE, M.V_POLAG_NO
                            INTO V_POL_TYPE, V_POL_NO
                            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
                            WHERE     M.N_REF_NO = D.N_REF_NO
                              AND M.V_JOURNAL_STATUS = 'C'

                              AND V_DOCU_TYPE = 'VOUCHER'


                              AND V_DOCU_REF_NO = V_VOUCHER_NO
                              AND M.V_POLAG_NO IN (SELECT V_POLICY_NO
                                                   FROM PYDT_VOUCHER_POLICY_CLIENT
                                                   WHERE V_VOU_NO = V_VOUCHER_NO);
                        EXCEPTION
                            WHEN TOO_MANY_ROWS
                                THEN
                                    V_POL_TYPE := 'M';
                                    V_POL_NO := 'N';
                            WHEN OTHERS
                                THEN
                                    RAISE_ERROR ('many rows==' || V_VOUCHER_NO);
                        END;
                WHEN OTHERS
                    THEN
                        RAISE_ERROR ('Error getting voucher type ==' || V_VOUCHER_NO);
            END;

            IF V_POL_TYPE IS NULL OR V_POL_NO IS NULL
            THEN
                RAISE_ERROR ('policy type is null ==' || V_VOUCHER_NO);
            END IF;


            FOR V IN VOUCHER
                LOOP
                    V_DESC := V.V_VOU_DESC;
                    PAYEE_NAME := V.V_PAYEE_NAME;
                    V_N_CUST_REF_NO := V.N_CUST_REF_NO;
                    COMPANY_CODE := V.V_COMPANY_CODE;
                    COMPANY_BRANCH := V.V_COMPANY_BRANCH;
                    IND_COMPANY := V.V_IND_COMPANY;
                    MAIN_VOU_NO := V.V_MAIN_VOU_NO;
                    V_PAY_AMOUNT := V.N_VOU_AMOUNT;
                    V_SIGN := SIGN (V.N_VOU_AMOUNT);
                    V_VOU_DATE := V.D_VOU_DATE;
                    CURRENCY_CODE := V.V_CURRENCY_CODE;
                END LOOP;

            V_VOU_AUTH_DATE :=
                    JHL_GEN_PKG.GET_VOUCHER_APPROVAL_DATE (V_VOUCHER_NO);


            SELECT DISTINCT
                DECODE ( (JHL_GEN_PKG.GET_ENTRY_CHANNEL (M.N_REF_NO)),
                         '10', '11',
                         '30', '12',
                         '11')
                    CHANNEL,
                DECODE (V_LOB_CODE,  'LOB001', '12',  'LOB003', '11','LOB004', '13','LOB005', '14','LOB002', '63',  '12')
                    PRODUCT
            INTO V_CHANNEL, V_PRODUCT
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
              AND V_DOCU_TYPE = 'VOUCHER'
              AND V_DOCU_REF_NO = V_VOUCHER_NO AND ROWNUM = 1;





            V_VENDOR_NAME := PAYEE_NAME;
            V_POL_PAYER := V_N_CUST_REF_NO;
            V_CO_CODE := COMPANY_CODE;
            V_CO_BRH := COMPANY_BRANCH;
            V_SITE_CODE := NULL;
            V_PIN_NO := NULL;
            V_DIFF_PAYEE_NAME := NULL;
            V_PAY_GROUP := NULL;

            IF V_POL_PAYER IS NOT NULL
            THEN
                SELECT MAX (VENDOR_SITE_CODE)
                INTO V_SITE_CODE
                FROM (SELECT P.V_POLICY_NO VENDOR_SITE_CODE
                      FROM GNMT_POLICY P,
                           GNMT_CUSTOMER_MASTER C,
                           GNLU_PAY_METHOD PM
                      WHERE     P.N_PAYER_REF_NO = C.N_CUST_REF_NO
                        AND P.V_PMT_METHOD_CODE = PM.V_PMT_METHOD_CODE(+)

                        AND C.N_CUST_REF_NO = V_POL_PAYER
                      UNION
                      SELECT TO_CHAR ('PYR-' || C.N_CUST_REF_NO)
                                 VENDOR_SITE_CODE
                      FROM AMMM_AGENT_MASTER AGN, GNMT_CUSTOMER_MASTER C
                      WHERE AGN.N_CUST_REF_NO = C.N_CUST_REF_NO
                        AND C.N_CUST_REF_NO = V_POL_PAYER
                      UNION
                      SELECT TO_CHAR ('PYR-' || C.N_CUST_REF_NO)
                                 VENDOR_SITE_CODE
                      FROM GNMT_CUSTOMER_MASTER C
                      WHERE     TO_CHAR (C.N_CUST_REF_NO) NOT IN
                                (SELECT AGN.N_CUST_REF_NO
                                 FROM AMMM_AGENT_MASTER AGN
                                 WHERE AGN.N_CUST_REF_NO IS NOT NULL
                                 UNION ALL
                                 SELECT POL.N_PAYER_REF_NO
                                 FROM GNMT_POLICY POL
                                 WHERE POL.N_PAYER_REF_NO IS NOT NULL)
                        AND C.N_CUST_REF_NO = V_POL_PAYER);
            ELSE
                SELECT MAX (VENDOR_SITE_CODE)
                INTO V_SITE_CODE
                FROM (SELECT P.V_POLICY_NO VENDOR_SITE_CODE
                      FROM GNMT_POLICY P,
                           GNMM_COMPANY_MASTER C,
                           GNMM_POLICY_STATUS_MASTER STATUS,
                           GNLU_INSTITUTION_TYPE INS,
                           GNLU_PAY_METHOD PM
                      WHERE     P.V_COMPANY_CODE = C.V_COMPANY_CODE
                        AND P.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
                        AND P.V_CNTR_STAT_CODE = STATUS.V_STATUS_CODE
                        AND C.V_INST_TYPE = INS.V_INST_TYPE
                        AND P.V_PMT_METHOD_CODE = PM.V_PMT_METHOD_CODE


                        AND C.V_COMPANY_CODE = V_CO_CODE
                        AND C.V_COMPANY_BRANCH = V_CO_BRH
                      UNION
                      SELECT SUBSTR (
                                     TO_CHAR (
                                             C.V_COMPANY_CODE
                                                 || '-'
                                                 || C.V_COMPANY_BRANCH),
                                     1,
                                     15)
                                 VENDOR_SITE_CODE
                      FROM GNMM_COMPANY_MASTER C,
                           AMMM_AGENT_MASTER AGN,
                           GNLU_INSTITUTION_TYPE INS
                      WHERE     C.V_COMPANY_CODE = AGN.V_COMPANY_CODE
                        AND C.V_COMPANY_BRANCH = AGN.V_COMPANY_BRANCH
                        AND C.V_INST_TYPE = INS.V_INST_TYPE

                        AND AGN.V_COMPANY_CODE = V_CO_CODE
                        AND AGN.V_COMPANY_BRANCH = V_CO_BRH
                        AND AGN.N_AGENT_NO =
                            NVL (V_AGENT_NO, AGN.N_AGENT_NO)
                      UNION
                      SELECT SUBSTR (
                                     TO_CHAR (
                                             C.V_COMPANY_CODE
                                                 || '-'
                                                 || C.V_COMPANY_BRANCH),
                                     1,
                                     15)
                                 VENDOR_SITE_CODE
                      FROM GNMM_COMPANY_MASTER C
                      WHERE     1 = 1
                        AND C.V_COMPANY_CODE = V_CO_CODE
                        AND C.V_COMPANY_BRANCH = V_CO_BRH
                        AND (C.V_COMPANY_CODE, C.V_COMPANY_BRANCH) NOT IN
                            (SELECT AGN.V_COMPANY_CODE,
                                    AGN.V_COMPANY_BRANCH
                             FROM AMMM_AGENT_MASTER AGN
                             WHERE AGN.V_COMPANY_CODE IS NOT NULL)
                        AND (C.V_COMPANY_CODE, C.V_COMPANY_BRANCH) NOT IN
                            (SELECT P.V_COMPANY_CODE,
                                    P.V_COMPANY_BRANCH
                             FROM GNMT_POLICY P,
                                  GNMM_POLICY_STATUS_MASTER STATUS
                             WHERE     P.V_CNTR_STAT_CODE =
                                       STATUS.V_STATUS_CODE
                               AND P.V_COMPANY_CODE IS NOT NULL

                            ));
            END IF;



            IF V_POL_TYPE = 'P'
            THEN
                POLICY_NO := V_POL_NO;

                V_PAY_GROUP := 'LIFE-CLAIM';


                IF V_POL_PAYER IS NOT NULL
                THEN
                    CREATE_INDIVIDUAL_SUPPLIER_NEW (V_POL_PAYER);


                    BEGIN
                        V_PIN_NO := JHL_BI_UTILS.GET_IND_CUSTOMER_PIN (V_POL_PAYER);
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || V_POL_PAYER
                                            || ' NAME ='
                                            || V_VENDOR_NAME);
                    END;



                    BEGIN
                        SELECT V_CONTACT_NUMBER
                        INTO V_EMAIL_NO
                        FROM GNDT_CUSTMOBILE_CONTACTS
                        WHERE     1 = 1
                          AND V_CONTACT_CODE = 'CONT003'
                          AND N_CUST_REF_NO = V_POL_PAYER
                          AND V_CONTACT_NUMBER LIKE '%@%';
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_EMAIL_NO := NULL;
                    END;

                    BEGIN
                        SELECT V_CONTACT_NUMBER
                        INTO V_PHONE_NO
                        FROM GNDT_CUSTMOBILE_CONTACTS
                        WHERE     1 = 1
                          AND V_CONTACT_CODE = 'CONT010'
                          AND N_CUST_REF_NO = V_POL_PAYER
                          AND V_CONTACT_NUMBER NOT LIKE '%@%';
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_PHONE_NO := NULL;
                    END;
                ELSE
                    CREATE_CORPORATE_SUPPLIER_NEW (V_CO_CODE, V_CO_BRH);

                    BEGIN
                        V_PIN_NO :=
                                JHL_BI_UTILS.GET_CO_CUSTOMER_PIN (V_CO_CODE, V_CO_BRH);
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || V_CO_CODE
                                            || ' BRN ='
                                            || V_CO_BRH);
                    END;




                    BEGIN
                        SELECT V_CONTACT_NUMBER
                        INTO V_EMAIL_NO
                        FROM GNDT_COMPMOBILE_CONTACTS H
                        WHERE     H.V_COMPANY_CODE = V_CO_CODE
                          AND H.V_COMPANY_BRANCH = V_CO_BRH
                          AND V_CONTACT_CODE = 'CONT003'
                          AND V_CONTACT_NUMBER LIKE '%@%';
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_EMAIL_NO := NULL;
                    END;

                    BEGIN
                        SELECT V_CONTACT_NUMBER
                        INTO V_PHONE_NO
                        FROM GNDT_COMPMOBILE_CONTACTS H
                        WHERE     H.V_COMPANY_CODE = V_CO_CODE
                          AND H.V_COMPANY_BRANCH = V_CO_BRH
                          AND V_CONTACT_CODE IN ('CONT009', 'CONT010')
                          AND V_CONTACT_NUMBER LIKE '%@%';
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_PHONE_NO := NULL;
                    END;
                END IF;
            ELSE
                IF V_POL_TYPE = 'M' AND V_DESC = 'Medical Fees Payment'
                THEN
                    V_PAY_GROUP := 'LIFE-CLAIM';
                ELSIF V_POL_TYPE = 'M' AND V_DESC <> 'Medical Fees Payment'
                THEN
                    RAISE_ERROR (
                            'v_pol_type==' || V_POL_TYPE || 'v_desc==' || V_DESC);
                ELSE
                    V_PAY_GROUP := 'LIFE-COMMISSION';
                END IF;

                IF IND_COMPANY = 'I'
                THEN



                    CREATE_INDIVIDUAL_SUPPLIER_NEW (V_N_CUST_REF_NO);

                    BEGIN
                        V_PIN_NO :=
                                JHL_BI_UTILS.GET_IND_CUSTOMER_PIN (V_N_CUST_REF_NO);
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || V_N_CUST_REF_NO
                                            || ' NAME ='
                                            || PAYEE_NAME);
                    END;

                    IF V_SITE_CODE IS NULL
                    THEN
                        RAISE_ERROR (
                                ' Site Code missing '
                                    || V_N_CUST_REF_NO
                                    || ' ;;;;'
                                    || V_DESC
                                    || ' ;;;;'
                                    || POLICY_NO);
                    END IF;
                ELSE


                    CREATE_CORPORATE_SUPPLIER_NEW (COMPANY_CODE, COMPANY_BRANCH);


                    BEGIN
                        V_PIN_NO :=
                                JHL_BI_UTILS.GET_CO_CUSTOMER_PIN (COMPANY_CODE,
                                                                  COMPANY_BRANCH);
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || COMPANY_CODE
                                            || ' BRN ='
                                            || COMPANY_BRANCH);
                    END;
                END IF;
            END IF;



            V_COUNT := 0;

            FOR I IN VOUCHERS
                LOOP

                    IF ( I.V_DESC NOT LIKE ('%PAYMENT CONTROL%') AND NVL(V_PAY_AMOUNT,0) >0)
                    THEN
                        V_COUNT := V_COUNT + 1;

                        V_AMOUNT := I.AMOUNT * V_SIGN * -1;

                        V_LEG_SUP_CODE := NULL;



                        IF V_POL_TYPE = 'P'
                        THEN
                            V_LEG_SUP_CODE :=
                                    NVL (TO_CHAR (V_POL_PAYER),
                                         TO_CHAR (V_CO_CODE || '-' || V_CO_BRH));
                        ELSE
                            V_LEG_SUP_CODE :=
                                    NVL (TO_CHAR (V_N_CUST_REF_NO),
                                         TO_CHAR (COMPANY_CODE || '-' || COMPANY_BRANCH));
                        END IF;


                        IF (TO_DATE (V_VOU_DATE, 'DD/MM/RRRR') < '31-JUL-17')
                        THEN
                            V_VOU_DATE := SYSDATE;
                            RAISE_ERROR (
                                    'v_vou =='
                                        || I.V_VOU_NO
                                        || 'v_vou_date=='
                                        || V_VOU_DATE
                                        || 'v_vou_auth_date=='
                                        || V_VOU_AUTH_DATE);
                        END IF;

                        IF (TO_DATE (V_VOU_AUTH_DATE, 'DD/MM/RRRR') < '31-JUL-17')
                        THEN
                            V_VOU_AUTH_DATE := SYSDATE;
                            RAISE_ERROR (
                                    'v_vou =='
                                        || I.V_VOU_NO
                                        || 'v_vou_date=='
                                        || V_VOU_DATE
                                        || 'v_vou_auth_date=='
                                        || V_VOU_AUTH_DATE);
                        END IF;


                        IF (JHL_BI_UTILS.IS_VOUCHER_ANNUITY (I.V_VOU_NO) = 'Y')
                        THEN
                            V_PAY_GROUP := 'LIFE-ANNUITY';
                        END IF;

                        IF (JHL_BI_UTILS.CHECK_VALID_PIN (V_PIN_NO) <> 'Y')
                        THEN
                            IF V_PIN_NO IS NULL
                            THEN
                                INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO,
                                                                    V_VOU_NO,
                                                                    OVE_DESC,
                                                                    V_SUP_CODE)
                                VALUES (
                                           JHL_OVE_NO_SEQ.NEXTVAL,
                                           V_VOUCHER_NO,
                                           'MISSING CLIENT PIN  ::'
                                               || V_PIN_NO
                                               || ' Client Code:: '
                                               || V_LEG_SUP_CODE
                                               || ' Name :: '
                                               || NVL (V_VENDOR_NAME, I.VENDOR_NAME),
                                           V_LEG_SUP_CODE);
                            ELSE
                                INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO,
                                                                    V_VOU_NO,
                                                                    OVE_DESC,
                                                                    V_SUP_CODE)
                                VALUES (
                                           JHL_OVE_NO_SEQ.NEXTVAL,
                                           V_VOUCHER_NO,
                                           'INVALID CLIENT PIN  ::>'
                                               || V_PIN_NO
                                               || '< Client Code:: '
                                               || V_LEG_SUP_CODE
                                               || ' Name :: '
                                               || NVL (V_VENDOR_NAME, I.VENDOR_NAME),
                                           V_LEG_SUP_CODE);
                            END IF;
                        END IF;



                        IF (    V_AMOUNT <> 0
                            AND JHL_BI_UTILS.CHECK_VALID_PIN (V_PIN_NO) = 'Y')
                        THEN
                            INSERT
                            INTO JHL_OFA_PYMT_TRANSACTIONS (OPT_NO,
                                                            V_VOU_NO,
                                                            LEGACY_SUPPLIER_CODE,
                                                            VENDOR_NAME,
                                                            VENDOR_SITE_CODE,
                                                            INVOICE_AMOUNT,
                                                            INVOICE_CURRENCY_CODE,
                                                            EXCHANGE_RATE,
                                                            DESCRIPTION,
                                                            LIABILITY_ACCOUNT,
                                                            LINE_NUMBER,
                                                            LEGACY_REF1,
                                                            LINE_AMOUNT,
                                                            N_CUST_REF_NO,
                                                            V_COMPANY_CODE,
                                                            V_COMPANY_BRANCH,
                                                            V_MAIN_VOU_NO,
                                                            LEGACY_REF3,
                                                            V_VOU_DATE,
                                                            LEGACY_REF11,
                                                            V_VOU_DESC,
                                                            PAY_GROUP_LOOKUP_CODE,
                                                            OPT_DATE,
                                                            POL_TYPE,
                                                            POL_NO,
                                                            DIF_N_CUST_REF_NO,
                                                            DIF_V_COMPANY_CODE,
                                                            DIF_V_COMPANY_BRANCH,
                                                            OPT_VOU_APPROVAL_DT,
                                                            PAYMENT_METHOD_CODE,
                                                            CAPTURED_BY,
                                                            VERIFIED_BY,
                                                            APPROVED_BY,
                                                            CAPTURED_DT,
                                                            VERIFIED_DT,
                                                            APPROVED_DT,
                                                            OPT_BRANCH_CODE,
                                                            OPT_CHANNEL_CODE,
                                                            OPT_PRODUCT_CODE,
                                                            VENDOR_EMAIL_ADDRESS,
                                                            VENDOR_PHONE,
                                                            CREATED_AT)
                            VALUES (
                                       OFA_OPT_NO_SEQ.NEXTVAL,
                                       I.V_VOU_NO,
                                       V_LEG_SUP_CODE,
                                       NVL (V_VENDOR_NAME, I.VENDOR_NAME),
                                       V_SITE_CODE,
                                       V_PAY_AMOUNT,
                                       CURRENCY_CODE,
                                       I.N_CONVERSION_RATE,
                                       I.V_DESC,
                                       I.OFA_ACC_CODE,
                                       V_COUNT,
                                       V_PIN_NO,
                                       V_AMOUNT,
                                       V_POL_PAYER,
                                       V_CO_CODE,
                                       V_CO_BRH,
                                       MAIN_VOU_NO,
                                       POLICY_NO,
                                       V_VOU_DATE,
                                       V_DIFF_PAYEE_NAME,
                                       V_DESC,
                                       V_PAY_GROUP,
                                       SYSDATE,
                                       V_POL_TYPE,
                                       V_POL_NO,
                                       V_N_CUST_REF_NO,
                                       COMPANY_CODE,
                                       COMPANY_BRANCH,
                                       V_VOU_AUTH_DATE,
                                       DECODE (
                                               JHL_GEN_PKG.GET_VOUCHER_PAYMENT_METHOD (
                                                       I.V_VOU_NO),
                                               'EFT', 'EFT',
                                               'CHECK'),
                                       JHL_GEN_PKG.GET_VOUCHER_STATUS_USER (I.V_VOU_NO,
                                                                            'PREPARE'),
                                       JHL_GEN_PKG.GET_VOUCHER_STATUS_USER (I.V_VOU_NO,
                                                                            'VERIFY'),
                                       JHL_GEN_PKG.GET_VOUCHER_STATUS_USER (I.V_VOU_NO,
                                                                            'APPROVE'),
                                       JHL_GEN_PKG.GET_VOUCHER_DATE (I.V_VOU_NO,
                                                                     'PREPARE'),
                                       JHL_GEN_PKG.GET_VOUCHER_DATE (I.V_VOU_NO,
                                                                     'VERIFY'),
                                       JHL_GEN_PKG.GET_VOUCHER_DATE (I.V_VOU_NO,
                                                                     'APPROVE'),
                                       '210',
                                       V_CHANNEL,
                                       V_PRODUCT,
                                       V_EMAIL_NO,
                                       V_PHONE_NO,
                                       SYSDATE);
                        END IF;
                    END IF;
                END LOOP;

            SELECT SUM (LINE_AMOUNT)
            INTO V_TOTAL_AMOUNT
            FROM JHL_OFA_PYMT_TRANSACTIONS
            WHERE V_VOU_NO = V_VOUCHER_NO;

            UPDATE JHL_OFA_PYMT_TRANSACTIONS
            SET INVOICE_AMOUNT = V_TOTAL_AMOUNT
            WHERE V_VOU_NO = V_VOUCHER_NO;



            BEGIN
                SELECT COUNT (*)
                INTO V_EXIST_COUNT
                FROM APPS.XXJIC_AP_CLAIM_MAP@JICOFPROD.COM
                WHERE     LOB_NAME = 'JHL_UG_LIF_OU'
                  AND PAYMENT_VOUCHER = V_VOUCHER_NO;
            EXCEPTION
                WHEN OTHERS
                    THEN
                        V_EXIST_COUNT := 0;
            END;


















            IF V_EXIST_COUNT = 0
            THEN
                BEGIN
                    SELECT COUNT (*)
                    INTO V_EXIST_COUNT
                    FROM XXJICUG_AP_INVOICES_STG@JICOFPROD.COM
                    WHERE     OPERATING_UNIT = 'JHL_UG_LIF_OU'
                      AND VOUCHER_NUM = V_VOUCHER_NO;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_EXIST_COUNT := 0;
                END;
            END IF;









            IF (V_EXIST_COUNT = 0 AND V_TOTAL_AMOUNT <> 0)
            THEN
                JHL_OFA_GL_VOUCHERS_NEW (V_VOUCHER_NO);
            END IF;


            IF ( (V_EXIST_COUNT = 0 AND V_TOTAL_AMOUNT = 0) OR (V_PAY_AMOUNT = 0))
            THEN

                CREATE_OFA_CANCELLED_PYMT_GL (V_VOUCHER_NO);
            END IF;

        END IF;





    END;



    PROCEDURE JHL_OFA_TRANSFORM_GL_VOU_040221 (V_VOUCHER_NO VARCHAR2)
        IS
        CURSOR VOUCHERS
            IS





















            SELECT V_GL_CODE ACCT_CODE,
                   V_PROCESS_CODE,
                   SUM (DECODE (V_TYPE, 'D', -N_SOURCE_AMOUNT, N_SOURCE_AMOUNT))
                             AMOUNT,
                   DECODE (V_DESC, 'INCOME_TAX', 'WHT TAX', V_DESC) V_DESC,





                   (SELECT DISTINCT OFA_ACC_CODE
                    FROM JHL_ISF_OFA_ACC_MAP
                    WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                      AND TRIM (ACC_DESC) = TRIM (D.V_DESC))
                       OFA_ACC_CODE,
                   DECODE (
                           SIGN (
                                   SUM (
                                           DECODE (V_TYPE,
                                                   'D', -N_SOURCE_AMOUNT,
                                                   N_SOURCE_AMOUNT))),
                           -1, 1,
                           2)
                       ORD,
                   V_DOCU_REF_NO V_VOU_NO,
                   BPG_FINANCE_BATCHES.BFN_GET_PAYEE_NAME (V_DOCU_REF_NO)
                       VENDOR_NAME,
                   ABS (
                           SUM (
                                   DECODE (V_TYPE, 'D', -N_SOURCE_AMOUNT, N_SOURCE_AMOUNT)))
                       AMT,
                   N_CONVERSION_RATE
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
              AND V_DOCU_TYPE = 'VOUCHER'
              AND V_DOCU_REF_NO = V_VOUCHER_NO

            GROUP BY V_GL_CODE,
                     V_PROCESS_CODE,
                     V_DESC,
                     V_DOCU_REF_NO,
                     N_CONVERSION_RATE
            ORDER BY ORD, AMT DESC;


        CURSOR VOUCHER
            IS
            SELECT V_VOU_DESC,
                   V_PAYEE_NAME,
                   N_CUST_REF_NO,
                   V_COMPANY_CODE,
                   V_COMPANY_BRANCH,
                   V_IND_COMPANY,
                   PM.V_MAIN_VOU_NO V_MAIN_VOU_NO,
                   N_VOU_AMOUNT,
                   D_VOU_DATE,
                   DECODE (V_CURRENCY_CODE, 'UGS', 'UGX', V_CURRENCY_CODE)
                                    V_CURRENCY_CODE
            FROM PYMT_VOUCHER_ROOT PM, PYMT_VOU_MASTER PV
            WHERE     PM.V_MAIN_VOU_NO = PV.V_MAIN_VOU_NO
              AND PV.V_VOU_NO = V_VOUCHER_NO;



        PAYEE_NAME          VARCHAR (400);
        V_N_CUST_REF_NO     NUMBER (25);
        COMPANY_CODE        VARCHAR2 (20);
        COMPANY_BRANCH      VARCHAR2 (50);
        IND_COMPANY         VARCHAR2 (2);


        V_PAY_AMOUNT        NUMBER;
        V_SIGN              NUMBER;
        V_GROSS_AMT         NUMBER;
        V_ACCOUNT           VARCHAR2 (50);
        V_DESC              VARCHAR2 (200);
        V_ACCT_CODE         VARCHAR2 (50);
        V_COUNT             NUMBER;
        POLICY_NO           VARCHAR2 (30);
        V_PIN_NO            VARCHAR2 (30);

        V_AMOUNT            NUMBER;
        MAIN_VOU_NO         VARCHAR2 (50);
        VOU_COUNT           NUMBER;
        V_SITE_CODE         VARCHAR2 (50);

        V_TOTAL_AMOUNT      NUMBER;

        V_ERROR_MESSAGE     VARCHAR2 (1000);
        V_EXIST_COUNT       NUMBER := 0;
        V_VOU_DATE          DATE;

        V_AGENT_NO          NUMBER;
        CURRENCY_CODE       VARCHAR2 (100);

        V_POLICY_COUNT      NUMBER;

        V_POL_TYPE          VARCHAR2 (2);
        V_POL_NO            VARCHAR2 (250);

        V_POL_PAYER         NUMBER (25);
        V_CO_CODE           VARCHAR2 (20);
        V_CO_BRH            VARCHAR2 (50);
        V_DIFF_PAYEE_NAME   VARCHAR (400);
        V_VENDOR_NAME       VARCHAR (400);
        V_PAY_GROUP         VARCHAR2 (50);

        V_POST_COUNT        NUMBER := 0;
        V_LEG_SUP_CODE      VARCHAR2 (150);

        V_VOU_AUTH_DATE     DATE;

        V_ST_ERROR_COUNT    NUMBER := 0;
        V_VOU_APPROVED      VARCHAR2 (5) := 'N';

        V_CHANNEL           VARCHAR2 (30);
        V_PRODUCT           VARCHAR2 (30);
        V_ACC_COUNT         NUMBER := 0;
    BEGIN
        V_POST_COUNT := 0;


        SELECT COUNT (*)
        INTO V_POST_COUNT

        FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
        WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
          AND V_DOCU_TYPE = 'VOUCHER'

          AND V_DOCU_REF_NO = V_VOUCHER_NO;

        VOU_COUNT := 0;

        SELECT COUNT (*)
        INTO VOU_COUNT
        FROM JHL_OFA_PYMT_TRANSACTIONS
        WHERE V_VOU_NO = V_VOUCHER_NO;


        V_ST_ERROR_COUNT := 0;

        SELECT COUNT (*)
        INTO V_ST_ERROR_COUNT

        FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
        WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS <> 'C'
          AND V_DOCU_TYPE = 'VOUCHER'

          AND V_DOCU_REF_NO = V_VOUCHER_NO;

        V_VOU_APPROVED := 'N';

        V_VOU_APPROVED := JHL_GEN_PKG.IS_VOUCHER_AUTHORIZED (V_VOUCHER_NO);

        V_ACC_COUNT := 0;

        SELECT COUNT (*)
        INTO V_ACC_COUNT
        FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
        WHERE     M.N_REF_NO = D.N_REF_NO
          AND M.V_JOURNAL_STATUS = 'C'

          AND V_DOCU_TYPE = 'VOUCHER'

          AND V_DOCU_REF_NO = V_VOUCHER_NO
          AND (SELECT DISTINCT OFA_ACC_CODE
               FROM JHL_ISF_OFA_ACC_MAP
               WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                 AND TRIM (ACC_DESC) = TRIM (D.V_DESC))
            IS NULL;

        DELETE FROM JHL_OFA_VOUCHER_ERRORS
        WHERE V_VOU_NO = V_VOUCHER_NO;

        IF V_ACC_COUNT <> 0
        THEN
            INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO,
                                                V_VOU_NO,
                                                OVE_DESC,
                                                V_GL_CODE,
                                                V_ACC_DESC)
            SELECT JHL_OVE_NO_SEQ.NEXTVAL,
                   V_VOUCHER_NO,
                   'MISSING ACCOUNT MAPPING',
                   V_GL_CODE,
                   V_DESC
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE     M.N_REF_NO = D.N_REF_NO
              AND M.V_JOURNAL_STATUS = 'C'

              AND V_DOCU_TYPE = 'VOUCHER'

              AND V_DOCU_REF_NO = V_VOUCHER_NO
              AND (SELECT DISTINCT OFA_ACC_CODE
                   FROM JHL_ISF_OFA_ACC_MAP
                   WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                     AND TRIM (ACC_DESC) = TRIM (D.V_DESC))
                IS NULL;
        END IF;


        IF V_ST_ERROR_COUNT <> 0
        THEN
            INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO, V_VOU_NO, OVE_DESC)
            VALUES (
                       JHL_OVE_NO_SEQ.NEXTVAL,
                       V_VOUCHER_NO,
                       'ISF ACCOUNTING ENTRIES ERROR');
        END IF;

        IF V_VOU_APPROVED <> 'Y'
        THEN
            INSERT INTO JHL_OFA_VOUCHER_ERRORS (OVE_NO, V_VOU_NO, OVE_DESC)
            VALUES (
                       JHL_OVE_NO_SEQ.NEXTVAL,
                       V_VOUCHER_NO,
                       'VOUCHER IS NOT APPROVED IN ISF ');
        END IF;



        IF (    VOU_COUNT = 0
            AND V_POST_COUNT <> 0
            AND V_ST_ERROR_COUNT = 0
            AND V_VOU_APPROVED = 'Y'
            AND V_ACC_COUNT = 0)
        THEN





            BEGIN
                SELECT DISTINCT M.V_POLAG_TYPE, M.V_POLAG_NO
                INTO V_POL_TYPE, V_POL_NO
                FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
                WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
                  AND V_DOCU_TYPE = 'VOUCHER'

                  AND V_DOCU_REF_NO = V_VOUCHER_NO;
            EXCEPTION
                WHEN TOO_MANY_ROWS
                    THEN
                        BEGIN
                            SELECT DISTINCT M.V_POLAG_TYPE, M.V_POLAG_NO
                            INTO V_POL_TYPE, V_POL_NO
                            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
                            WHERE     M.N_REF_NO = D.N_REF_NO
                              AND M.V_JOURNAL_STATUS = 'C'

                              AND V_DOCU_TYPE = 'VOUCHER'


                              AND V_DOCU_REF_NO = V_VOUCHER_NO
                              AND M.V_POLAG_NO IN (SELECT V_POLICY_NO
                                                   FROM PYDT_VOUCHER_POLICY_CLIENT
                                                   WHERE V_VOU_NO = V_VOUCHER_NO);
                        EXCEPTION
                            WHEN TOO_MANY_ROWS
                                THEN
                                    V_POL_TYPE := 'M';
                                    V_POL_NO := 'N';
                            WHEN OTHERS
                                THEN
                                    RAISE_ERROR ('many rows==' || V_VOUCHER_NO);
                        END;
                WHEN OTHERS
                    THEN
                        RAISE_ERROR ('Error getting voucher type ==' || V_VOUCHER_NO);
            END;

            IF V_POL_TYPE IS NULL OR V_POL_NO IS NULL
            THEN
                RAISE_ERROR ('policy type is null ==' || V_VOUCHER_NO);
            END IF;


            FOR V IN VOUCHER
                LOOP
                    V_DESC := V.V_VOU_DESC;
                    PAYEE_NAME := V.V_PAYEE_NAME;
                    V_N_CUST_REF_NO := V.N_CUST_REF_NO;
                    COMPANY_CODE := V.V_COMPANY_CODE;
                    COMPANY_BRANCH := V.V_COMPANY_BRANCH;
                    IND_COMPANY := V.V_IND_COMPANY;
                    MAIN_VOU_NO := V.V_MAIN_VOU_NO;
                    V_PAY_AMOUNT := V.N_VOU_AMOUNT;
                    V_SIGN := SIGN (V.N_VOU_AMOUNT);
                    V_VOU_DATE := V.D_VOU_DATE;
                    CURRENCY_CODE := V.V_CURRENCY_CODE;
                END LOOP;

            V_VOU_AUTH_DATE :=
                    JHL_GEN_PKG.GET_VOUCHER_APPROVAL_DATE (V_VOUCHER_NO);

            SELECT DISTINCT
                DECODE ( (JHL_GEN_PKG.GET_ENTRY_CHANNEL (M.N_REF_NO)),
                         '10', '11',
                         '30', '12',
                         '11')
                    CHANNEL,
                DECODE (V_LOB_CODE,  'LOB001', '12',  'LOB003', '11','LOB004', '13','LOB005', '14','LOB002', '63',  '12')
                    PRODUCT
            INTO V_CHANNEL, V_PRODUCT
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE M.N_REF_NO = D.N_REF_NO AND M.V_JOURNAL_STATUS = 'C'
              AND V_DOCU_TYPE = 'VOUCHER'
              AND V_DOCU_REF_NO = V_VOUCHER_NO AND ROWNUM = 1;



            POLICY_NO := NULL;
            V_VENDOR_NAME := NULL;
            V_POL_PAYER := NULL;
            V_CO_CODE := NULL;
            V_CO_BRH := NULL;
            V_SITE_CODE := NULL;
            V_PIN_NO := NULL;
            V_DIFF_PAYEE_NAME := NULL;
            V_PAY_GROUP := NULL;

            IF V_POL_TYPE = 'P'
            THEN
                POLICY_NO := V_POL_NO;
                V_SITE_CODE := V_POL_NO;
                V_PAY_GROUP := 'LIFE-CLAIM';


                SELECT N_PAYER_REF_NO, P.V_COMPANY_CODE, P.V_COMPANY_BRANCH
                INTO V_POL_PAYER, V_CO_CODE, V_CO_BRH
                FROM GNMT_POLICY P
                WHERE P.V_POLICY_NO = V_POL_NO;

                IF V_POL_PAYER IS NOT NULL
                THEN
                    SELECT N_PAYER_REF_NO, V_NAME
                    INTO V_POL_PAYER, V_VENDOR_NAME
                    FROM GNMT_POLICY P, GNMT_CUSTOMER_MASTER C
                    WHERE     P.N_PAYER_REF_NO = C.N_CUST_REF_NO
                      AND P.V_POLICY_NO = V_POL_NO;

                    IF NVL (V_POL_PAYER, -2000) <> NVL (V_N_CUST_REF_NO, -2001)
                    THEN
                        V_DIFF_PAYEE_NAME := PAYEE_NAME;
                    ELSE
                        V_DIFF_PAYEE_NAME := NULL;
                    END IF;


                    CREATE_INDIVIDUAL_SUPPLIER_NEW (V_POL_PAYER);

                    BEGIN
                        SELECT OSP_PIN_NO
                        INTO V_PIN_NO
                        FROM JHL_OFA_SUPPLIER
                        WHERE N_CUST_REF_NO = V_POL_PAYER;
                    EXCEPTION


                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || V_POL_PAYER
                                            || ' NAME ='
                                            || V_VENDOR_NAME);

                    END;
                ELSE
                    SELECT P.V_COMPANY_CODE, P.V_COMPANY_BRANCH, V_COMPANY_NAME
                    INTO V_CO_CODE, V_CO_BRH, V_VENDOR_NAME
                    FROM GNMT_POLICY P, GNMM_COMPANY_MASTER C
                    WHERE     P.V_COMPANY_CODE = C.V_COMPANY_CODE
                      AND P.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
                      AND P.V_POLICY_NO = V_POL_NO;


                    IF (    NVL (COMPANY_CODE, 'EIRUWIW') =
                            NVL (V_CO_CODE, 'KSDFYUEY')
                        AND NVL (COMPANY_BRANCH, 'KSDFYUEY') =
                            NVL (V_CO_BRH, 'EIRUWIW'))
                    THEN
                        V_DIFF_PAYEE_NAME := NULL;
                    ELSE
                        V_DIFF_PAYEE_NAME := PAYEE_NAME;
                    END IF;



                    CREATE_CORPORATE_SUPPLIER_NEW (V_CO_CODE, V_CO_BRH);



                    BEGIN
                        SELECT CSP_PIN_NO
                        INTO V_PIN_NO
                        FROM JHL_OFA_CO_SUPPLIER
                        WHERE     V_COMPANY_CODE = V_CO_CODE
                          AND V_COMPANY_BRANCH = V_CO_BRH;
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || V_CO_CODE
                                            || ' BRN ='
                                            || V_CO_BRH);
                    END;
                END IF;
            ELSE
                IF V_POL_TYPE = 'M' AND V_DESC = 'Medical Fees Payment'
                THEN
                    V_PAY_GROUP := 'LIFE-CLAIM';
                ELSIF V_POL_TYPE = 'M' AND V_DESC <> 'Medical Fees Payment'
                THEN


                    V_PAY_GROUP := 'LIFE-CLAIM';
                ELSE
                    V_PAY_GROUP := 'LIFE-CLAIM';
                END IF;

                IF IND_COMPANY = 'I'
                THEN
                    V_SITE_CODE := NVL (POLICY_NO, 'PYR-' || V_N_CUST_REF_NO);


                    CREATE_INDIVIDUAL_SUPPLIER_NEW (V_N_CUST_REF_NO);

                    BEGIN
                        SELECT OSP_PIN_NO
                        INTO V_PIN_NO
                        FROM JHL_OFA_SUPPLIER
                        WHERE N_CUST_REF_NO = V_N_CUST_REF_NO;
                    EXCEPTION


                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || V_N_CUST_REF_NO
                                            || ' NAME ='
                                            || PAYEE_NAME);

                    END;



                    IF V_SITE_CODE IS NULL
                    THEN
                        RAISE_ERROR (
                                ' Site Code missing '
                                    || V_N_CUST_REF_NO
                                    || ' ;;;;'
                                    || V_DESC
                                    || ' ;;;;'
                                    || POLICY_NO);
                    END IF;
                ELSE
                    V_SITE_CODE :=
                            NVL (
                                    POLICY_NO,
                                    SUBSTR (TO_CHAR (COMPANY_CODE || '-' || COMPANY_BRANCH),
                                            1,
                                            15));


                    CREATE_CORPORATE_SUPPLIER_NEW (COMPANY_CODE, COMPANY_BRANCH);



                    BEGIN
                        SELECT CSP_PIN_NO
                        INTO V_PIN_NO
                        FROM JHL_OFA_CO_SUPPLIER
                        WHERE     V_COMPANY_CODE = COMPANY_CODE
                          AND V_COMPANY_BRANCH = COMPANY_BRANCH;
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'ERROR GETTING pIN NUMBER  CO CODE=='
                                            || COMPANY_CODE
                                            || ' BRN ='
                                            || COMPANY_BRANCH);
                    END;
                END IF;
            END IF;



            V_COUNT := 0;

            FOR I IN VOUCHERS
                LOOP
                    IF I.ACCT_CODE <> '115092'
                    THEN
                        V_COUNT := V_COUNT + 1;



                        V_AMOUNT := I.AMOUNT * V_SIGN * -1;



                        V_LEG_SUP_CODE := NULL;

                        IF V_POL_TYPE = 'P'
                        THEN
                            V_LEG_SUP_CODE :=
                                    NVL (TO_CHAR (V_POL_PAYER),
                                         TO_CHAR (V_CO_CODE || '-' || V_CO_BRH));
                        ELSE
                            V_LEG_SUP_CODE :=
                                    NVL (TO_CHAR (V_N_CUST_REF_NO),
                                         TO_CHAR (COMPANY_CODE || '-' || COMPANY_BRANCH));
                        END IF;


                        IF (I.OFA_ACC_CODE IS NULL)
                        THEN
                            RAISE_ERROR (
                                    'ofa account is null V_VOU_NO== ' || I.V_VOU_NO);
                        END IF;


                        IF V_AMOUNT <> 0
                        THEN
                            INSERT
                            INTO JHL_OFA_PYMT_TRANSACTIONS (OPT_NO,
                                                            V_VOU_NO,
                                                            LEGACY_SUPPLIER_CODE,
                                                            VENDOR_NAME,
                                                            VENDOR_SITE_CODE,
                                                            INVOICE_AMOUNT,
                                                            INVOICE_CURRENCY_CODE,
                                                            EXCHANGE_RATE,
                                                            DESCRIPTION,
                                                            LIABILITY_ACCOUNT,
                                                            LINE_NUMBER,
                                                            LEGACY_REF1,
                                                            LINE_AMOUNT,
                                                            N_CUST_REF_NO,
                                                            V_COMPANY_CODE,
                                                            V_COMPANY_BRANCH,
                                                            V_MAIN_VOU_NO,
                                                            LEGACY_REF3,
                                                            V_VOU_DATE,
                                                            LEGACY_REF11,
                                                            V_VOU_DESC,
                                                            PAY_GROUP_LOOKUP_CODE,
                                                            OPT_DATE,
                                                            POL_TYPE,
                                                            POL_NO,
                                                            DIF_N_CUST_REF_NO,
                                                            DIF_V_COMPANY_CODE,
                                                            DIF_V_COMPANY_BRANCH,
                                                            OPT_VOU_APPROVAL_DT,
                                                            PAYMENT_METHOD_CODE,
                                                            CAPTURED_BY,
                                                            VERIFIED_BY,
                                                            APPROVED_BY,
                                                            CAPTURED_DT,
                                                            VERIFIED_DT,
                                                            APPROVED_DT,
                                                            OPT_BRANCH_CODE,
                                                            OPT_CHANNEL_CODE,
                                                            OPT_PRODUCT_CODE)
                            VALUES (
                                       OFA_OPT_NO_SEQ.NEXTVAL,
                                       I.V_VOU_NO,
                                       V_LEG_SUP_CODE,
                                       NVL (V_VENDOR_NAME, I.VENDOR_NAME),
                                       V_SITE_CODE,
                                       V_PAY_AMOUNT,
                                       CURRENCY_CODE,
                                       I.N_CONVERSION_RATE,
                                       I.V_DESC,
                                       I.OFA_ACC_CODE,
                                       V_COUNT,
                                       V_PIN_NO,
                                       V_AMOUNT,
                                       V_POL_PAYER,
                                       V_CO_CODE,
                                       V_CO_BRH,
                                       MAIN_VOU_NO,
                                       POLICY_NO,
                                       V_VOU_DATE,
                                       V_DIFF_PAYEE_NAME,
                                       V_DESC,
                                       V_PAY_GROUP,
                                       SYSDATE,
                                       V_POL_TYPE,
                                       V_POL_NO,
                                       V_N_CUST_REF_NO,
                                       COMPANY_CODE,
                                       COMPANY_BRANCH,
                                       V_VOU_AUTH_DATE,
                                       'CHECK',
                                       JHL_GEN_PKG.GET_VOUCHER_STATUS_USER (I.V_VOU_NO,
                                                                            'PREPARE'),
                                       JHL_GEN_PKG.GET_VOUCHER_STATUS_USER (I.V_VOU_NO,
                                                                            'VERIFY'),
                                       JHL_GEN_PKG.GET_VOUCHER_STATUS_USER (I.V_VOU_NO,
                                                                            'APPROVE'),
                                       JHL_GEN_PKG.GET_VOUCHER_DATE (I.V_VOU_NO,
                                                                     'PREPARE'),
                                       JHL_GEN_PKG.GET_VOUCHER_DATE (I.V_VOU_NO,
                                                                     'VERIFY'),
                                       JHL_GEN_PKG.GET_VOUCHER_DATE (I.V_VOU_NO,
                                                                     'APPROVE'),
                                       '210',
                                       V_CHANNEL,
                                       V_PRODUCT);
                        END IF;
                    END IF;
                END LOOP;

            SELECT SUM (LINE_AMOUNT)
            INTO V_TOTAL_AMOUNT
            FROM JHL_OFA_PYMT_TRANSACTIONS
            WHERE V_VOU_NO = V_VOUCHER_NO;

            UPDATE JHL_OFA_PYMT_TRANSACTIONS
            SET INVOICE_AMOUNT = V_TOTAL_AMOUNT
            WHERE V_VOU_NO = V_VOUCHER_NO;

            BEGIN
                SELECT COUNT (*)
                INTO V_EXIST_COUNT
                FROM APPS.XXJIC_AP_CLAIM_MAP@JICOFPROD.COM
                WHERE     LOB_NAME = 'JHL_UG_LIF_OU'
                  AND PAYMENT_VOUCHER = V_VOUCHER_NO;
            EXCEPTION
                WHEN OTHERS
                    THEN
                        V_EXIST_COUNT := 0;
            END;












            IF V_EXIST_COUNT = 0
            THEN
                BEGIN
                    SELECT COUNT (*)
                    INTO V_EXIST_COUNT
                    FROM XXJICUG_AP_INVOICES_STG@JICOFPROD.COM
                    WHERE     OPERATING_UNIT = 'JHL_UG_LIF_OU'
                      AND VOUCHER_NUM = V_VOUCHER_NO;
                EXCEPTION
                    WHEN OTHERS
                        THEN
                            V_EXIST_COUNT := 0;
                END;
            END IF;


            IF (V_EXIST_COUNT = 0 AND V_TOTAL_AMOUNT <> 0)
            THEN
                JHL_OFA_GL_VOUCHERS_NEW (V_VOUCHER_NO);
            END IF;


            IF (V_EXIST_COUNT = 0 AND V_TOTAL_AMOUNT = 0)
            THEN
                CREATE_OFA_CANCELLED_PYMT_GL (V_VOUCHER_NO);
            END IF;
        END IF;



    END;

    FUNCTION BFN_GET_PAYEE_NAME (P_VOUCHER_NO VARCHAR2)
        RETURN VARCHAR2
        IS
        CURSOR CR_PAYEE_NAME
            IS
            SELECT V_PAYEE_NAME,
                   V_COMPANY_CODE,
                   V_COMPANY_BRANCH,
                   V_IND_COMPANY
            FROM PYMT_VOU_MASTER
            WHERE V_VOU_NO = P_VOUCHER_NO;

        CURSOR CR_COMP_NAME (
            P_COMP_CODE     IN VARCHAR2,
            P_COMP_BRANCH   IN VARCHAR2)
            IS
            SELECT V_COMPANY_NAME
            FROM GNMM_COMPANY_MASTER
            WHERE     V_COMPANY_CODE = P_COMP_CODE
              AND V_COMPANY_BRANCH = P_COMP_BRANCH;


        LV_IND_COMP       VARCHAR2 (2000);
        LV_COMP_CODE      VARCHAR2 (2000);
        LV_COMP_BRANCH    VARCHAR2 (2000);
        LV_PAYEE_NAME     VARCHAR2 (2000);
        LV_COMPANY_NAME   VARCHAR2 (2000);
        LV_PAYEE          VARCHAR2 (2000);
    BEGIN
        OPEN CR_PAYEE_NAME;

        FETCH CR_PAYEE_NAME
            INTO LV_PAYEE_NAME, LV_IND_COMP, LV_COMP_CODE, LV_COMP_BRANCH;

        CLOSE CR_PAYEE_NAME;

        OPEN CR_COMP_NAME (LV_COMP_CODE, LV_COMP_BRANCH);

        FETCH CR_COMP_NAME INTO LV_COMPANY_NAME;

        CLOSE CR_COMP_NAME;

        IF LV_IND_COMP = 'I'
        THEN
            LV_PAYEE := LV_PAYEE_NAME;
        ELSIF LV_IND_COMP = 'C'
        THEN
            LV_PAYEE := LV_COMPANY_NAME;
        ELSE
            LV_PAYEE := NULL;
        END IF;

        RETURN NVL (LV_PAYEE_NAME, '');
    END;


    PROCEDURE DELETE_SUPPLIER_MASTER
        IS
    BEGIN
        DELETE FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
        WHERE PAY_GROUP IN ('ISF-INDIVIDUAL-CLAIM', 'ISF-CORPORATE');

        DELETE FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
        WHERE PAY_GRP_LKP_CODE IN
              ('ISF-INDIVIDUAL-CLAIM', 'ISF-CORPORATE');

        DELETE FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
        WHERE OPERATING_UNIT = 'JHL_UG_LIF_OU';
    END;













    PROCEDURE OFA_GL_TRANS_PROC
        IS
        V_START_DATE   DATE;
    BEGIN
        V_START_DATE := SYSDATE;

        CREATE_OFA_RECEIVABLE_TRANS;
        TRANSFORM_OFA_RECEIVABLE_TRANS;
        TRANSFORM_OFA_GL_TRANS;
        SEND_GL_TRANS_TO_OFA;


        INSERT INTO JHL_OFA_JOBS (OJB_ID,
                                  OJB_NAME,
                                  OJB_START_DT,
                                  OJB_END_DT)
        VALUES (JHL_OJB_ID_SEQ.NEXTVAL,
                'ofa_gl_trans_proc',
                V_START_DATE,
                SYSDATE);

        COMMIT;
    END;



    PROCEDURE CREATE_OFA_RECEIVABLE_TRANS
        IS
        CURSOR REFS
            IS
            SELECT DISTINCT M.N_REF_NO N_REF_NO
            FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
            WHERE     M.N_REF_NO = D.N_REF_NO
              AND M.V_JOURNAL_STATUS = 'C'
              AND NVL (M.V_REMARKS, 'N') != 'X'
              AND V_DOCU_TYPE != 'VOUCHER'
              AND V_PROCESS_CODE NOT IN
                  ('ACT021',
                   'RIACT01',
                   'ACT070',
                   'ACT071',
                   'PY_APR_RI',
                   'PY_VRC_RI')
              AND TO_DATE (M.D_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                    '01-JAN-20',
                    'DD/MM/RRRR')
                AND TO_DATE (
                                SYSDATE,
                                'DD/MM/RRRR')
              AND M.N_REF_NO NOT IN (SELECT ORT.N_REF_NO
                                     FROM JHL_OFA_GL_TRANSACTIONS ORT
                                     WHERE ORT.N_REF_NO = M.N_REF_NO);



    BEGIN





        FOR I IN REFS
            LOOP
                BEGIN


















                    /*INSERTED  OGLT_PROCESSED, OGLT_POSTED AS 'N' IN THE INSERT AFTER AN ERROR 15082022*/

                    INSERT INTO JHL_OFA_GL_TRANSACTIONS (OGLT_NO,
                                                         N_REF_NO,
                                                         D_DATE,
                                                         V_BRANCH_CODE,
                                                         V_LOB_CODE,
                                                         V_PROCESS_CODE,
                                                         V_PROCESS_NAME,
                                                         V_DOCU_TYPE,
                                                         V_DOCU_REF_NO,
                                                         V_GL_CODE,
                                                         V_DESC,
                                                         V_TYPE,
                                                         N_AMT,
                                                         OFA_ACC_CODE,
                                                         V_SOURCE_CURRENCY,
                                                         V_POLAG_TYPE,
                                                         V_POLAG_NO,
                                                         D_POSTED_DATE,
                                                         V_SUN_JV,
                                                         OGLT_PROCESSED,
                                                         OGLT_POSTED,
                                                         OGLT_DATE,
                                                         OGTL_DRCR_NARRATION                                                )
                    SELECT JHL_OGLT_NO_SEQ.NEXTVAL,
                           M.N_REF_NO,
                           M.D_DATE,
                           NVL (V_BRANCH_CODE, 'HO'),
                           V_LOB_CODE,
                           NVL (V_PROCESS_CODE, 'N/A') V_PROCESS_CODE,
                           NVL ( (SELECT V_PROCESS_NAME
                                  FROM GNMM_PROCESS_MASTER
                                  WHERE V_PROCESS_ID = V_PROCESS_CODE),
                                 NVL (V_PROCESS_CODE, 'N/A'))
                                                       V_PROCESS_NAME,
                           V_DOCU_TYPE,
                           V_DOCU_REF_NO,
                           V_GL_CODE,
                           NVL (V_DESC, 'XX'),
                           V_TYPE,
                           N_AMT,







                           NVL (
                                   (SELECT DISTINCT OFA_ACC_CODE
                                    FROM JHL_ISF_OFA_ACC_MAP
                                    WHERE     TRIM (ISF_GL_CODE) = TRIM (D.V_GL_CODE)
                                      AND TRIM (ACC_DESC) = TRIM (D.V_DESC)),
                                   'N')
                                                       OFA_ACC_CODE,
                           'UGX',
                           M.V_POLAG_TYPE,
                           M.V_POLAG_NO,
                           M.D_POSTED_DATE,
                           M.V_REMARKS,
                           'N' OGLT_PROCESSED,
                           'N' OGLT_POSTED,
                           SYSDATE OGLT_DATE,
                           'X' OGTL_DRCR_NARRATION
                    FROM GNMT_GL_MASTER M, GNDT_GL_DETAILS D
                    WHERE     M.N_REF_NO = D.N_REF_NO
                      AND M.V_JOURNAL_STATUS = 'C'
                      AND NVL (M.V_REMARKS, 'N') != 'X'
                      AND V_DOCU_TYPE != 'VOUCHER'
                      AND V_PROCESS_CODE NOT IN ('ACT021', 'RIACT01')




                      AND M.N_REF_NO = I.N_REF_NO;




                EXCEPTION
                    WHEN OTHERS
                        THEN


                            RAISE_ERROR ('Error on ref == ' || I.N_REF_NO);
                END;


                COMMIT;
            END LOOP;


        DELETE FROM JHL_OFA_ISF_MIS_MAP;

        INSERT INTO JHL_OFA_ISF_MIS_MAP (V_GL_CODE, V_DESC, N_REF_NO)
        SELECT DISTINCT V_GL_CODE, NVL (V_DESC, 'XX'), N_REF_NO
        FROM JHL_OFA_GL_TRANSACTIONS
        WHERE OFA_ACC_CODE = 'N';


        DELETE FROM JHL_OFA_GL_TRANSACTIONS
        WHERE N_REF_NO IN (SELECT DISTINCT N_REF_NO
                           FROM JHL_OFA_GL_TRANSACTIONS
                           WHERE OFA_ACC_CODE = 'N');



        COMMIT;

    END;



    PROCEDURE TRANSFORM_OFA_RECEIVABLE_TRANS
        IS



















        CURSOR RCT_SUMMARY
            IS
            SELECT DISTINCT V_DOCU_REF_NO, TO_DATE (D_DATE, 'DD/MM/RRRR') D_DATE
            FROM JHL_OFA_GL_TRANSACTIONS
            WHERE     V_DOCU_TYPE = 'RECEIPT'
              AND OGLT_PROCESSED <> 'Y'
              AND TO_DATE (D_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                    '01-JAN-20',
                    'DD/MM/RRRR')
                AND TO_DATE (
                                SYSDATE,
                                'DD/MM/RRRR');





        CURSOR NON_RCT_SUMMARY
            IS
            SELECT DISTINCT
                V_PROCESS_CODE,
                V_LOB_CODE,
                TO_DATE (D_DATE, 'DD/MM/RRRR') D_DATE
            FROM JHL_OFA_GL_TRANSACTIONS
            WHERE     V_DOCU_TYPE <> 'RECEIPT'
              AND OGLT_PROCESSED <> 'Y'
              AND TO_DATE (D_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                    '01-JAN-20',
                    'DD/MM/RRRR')
                AND TO_DATE (
                                SYSDATE,
                                'DD/MM/RRRR');



        V_VGL_NO   NUMBER;
    BEGIN
        UPDATE JHL_OFA_GL_TRANSACTIONS
        SET V_LOB_CODE =
                DECODE (JHL_GEN_PKG.GET_ENTRY_CHANNEL (N_REF_NO),
                        30, 'LOB003',
                        10, 'LOB001',
                        'LOB001')
        WHERE     OGLT_PROCESSED <> 'Y'
          AND V_LOB_CODE = 'MIS'
          AND V_PROCESS_CODE IN ('AGCOMMPYMT', 'A0001-PROV');


        UPDATE JHL_OFA_GL_TRANSACTIONS
        SET V_LOB_CODE =
                (SELECT DECODE (N_CHANNEL_NO,
                                30, 'LOB003',
                                10, 'LOB001',
                                'LOB001')
                 FROM AMMM_AGENT_MASTER
                 WHERE N_AGENT_NO = (SELECT N_AGENT_NO
                                     FROM AMDT_AGENT_BENE_POOL_PAYMENT
                                     WHERE N_VOUCHER_NO = V_DOCU_REF_NO))
        WHERE     OGLT_PROCESSED <> 'Y'
          AND V_LOB_CODE = 'MIS'
          AND V_PROCESS_CODE IN ('ACT020');


        UPDATE JHL_OFA_GL_TRANSACTIONS
        SET OFA_ACC_CODE = '201206'
        WHERE     V_LOB_CODE = 'LOB001'
          AND OFA_ACC_CODE = '201209'
          AND OGLT_PROCESSED <> 'Y';



        UPDATE JHL_OFA_GL_TRANSACTIONS
        SET OGTL_DRCR_NARRATION =
                NVL (
                        (SELECT    V_COMPANY_NAME
                                       || '-'
                                       || N_VOUCHER_NO
                                       || '-'
                                       || N_GROSS_AMOUNT
                         FROM AMDT_AGENT_BENEFIT_POOL_DETAIL C,
                              AMDT_AGENT_BENE_POOL_PAYMENT D,
                              AMMM_AGENT_MASTER E,
                              GNMM_COMPANY_MASTER F
                         WHERE     V_TRANS_SOURCE_CODE = 'INCOME_TAX'
                           AND C.N_BENEFIT_POOL_PAY_SEQ =
                               D.N_BENEFIT_POOL_PAY_SEQ
                           AND C.N_AGENT_NO = E.N_AGENT_NO
                           AND NVL (E.V_COMPANY_CODE, 'X') =
                               NVL (F.V_COMPANY_CODE, 'X')
                           AND NVL (E.V_COMPANY_BRANCH, 'X') =
                               NVL (F.V_COMPANY_BRANCH, 'X')
                           AND TO_CHAR (C.N_BENEFIT_POOL_SEQ_NO) =
                               V_DOCU_REF_NO),
                        'X')
        WHERE     OFA_ACC_CODE = '201209'
          AND NVL (TRIM (OGTL_DRCR_NARRATION), 'X') = 'X'
          AND OGLT_PROCESSED <> 'Y';



        UPDATE JHL_OFA_GL_TRANSACTIONS
        SET OGTL_DRCR_NARRATION =
                NVL (
                        (SELECT    V_NAME
                                       || '-'
                                       || N_VOUCHER_NO
                                       || '-'
                                       || N_GROSS_AMOUNT
                         FROM AMDT_AGENT_BENEFIT_POOL_DETAIL C,
                              AMDT_AGENT_BENE_POOL_PAYMENT D,
                              AMMM_AGENT_MASTER E,
                              GNMT_CUSTOMER_MASTER F
                         WHERE     V_TRANS_SOURCE_CODE = 'INCOME_TAX'
                           AND C.N_BENEFIT_POOL_PAY_SEQ =
                               D.N_BENEFIT_POOL_PAY_SEQ
                           AND C.N_AGENT_NO = E.N_AGENT_NO
                           AND E.N_CUST_REF_NO = F.N_CUST_REF_NO
                           AND TO_CHAR (C.N_BENEFIT_POOL_SEQ_NO) =
                               V_DOCU_REF_NO),
                        'X')
        WHERE     OFA_ACC_CODE = '201206'
          AND NVL (TRIM (OGTL_DRCR_NARRATION), 'X') = 'X'
          AND OGLT_PROCESSED <> 'Y';



























        FOR R IN RCT_SUMMARY
            LOOP
                SELECT JGL_OFA_VGL_NO_SEQ.NEXTVAL INTO V_VGL_NO FROM DUAL;


                NULL;



                UPDATE JHL_OFA_GL_TRANSACTIONS
                SET OGLT_PROCESSED = 'Y',
                    OGLT_PROCESSED_DT = SYSDATE,
                    OFA_VGL_NO = V_VGL_NO,
                    OFA_VGL_CODE =
                        'OFA_JV_' || TO_CHAR (R.D_DATE, 'YYYY') || '_' || V_VGL_NO
                WHERE     V_DOCU_REF_NO = R.V_DOCU_REF_NO
                  AND TO_DATE (D_DATE, 'DD/MM/RRRR') =
                      TO_DATE (R.D_DATE, 'DD/MM/RRRR')
                  AND V_DOCU_TYPE = 'RECEIPT'
                  AND OGLT_PROCESSED <> 'Y';




            END LOOP;



        FOR C IN NON_RCT_SUMMARY
            LOOP

                SELECT JGL_OFA_VGL_NO_SEQ.NEXTVAL INTO V_VGL_NO FROM DUAL;

                UPDATE JHL_OFA_GL_TRANSACTIONS
                SET OGLT_PROCESSED = 'Y',
                    OGLT_PROCESSED_DT = SYSDATE,
                    OFA_VGL_NO = V_VGL_NO,
                    OFA_VGL_CODE =
                        'OFA_JV_' || TO_CHAR (C.D_DATE, 'YYYY') || '_' || V_VGL_NO
                WHERE     V_PROCESS_CODE = C.V_PROCESS_CODE
                  AND V_LOB_CODE = C.V_LOB_CODE
                  AND TO_DATE (D_DATE, 'DD/MM/RRRR') =
                      TO_DATE (C.D_DATE, 'DD/MM/RRRR')
                  AND V_DOCU_TYPE <> 'RECEIPT'
                  AND OGLT_PROCESSED <> 'Y';


                UPDATE GNMT_GL_MASTER GL
                SET V_REMARKS =
                        'OFA_JV_' || TO_CHAR (C.D_DATE, 'YYYY') || '_' || V_VGL_NO
                WHERE GL.N_REF_NO IN (SELECT DISTINCT TRN.N_REF_NO
                                      FROM JHL_OFA_GL_TRANSACTIONS TRN
                                      WHERE TRN.OFA_VGL_NO = V_VGL_NO);






            END LOOP;

        COMMIT;

    END;



    PROCEDURE TRANSFORM_OFA_GL_TRANS
        IS
        CURSOR RCT_TRANS
            IS
            SELECT 'NEW' STATUS,
                   '2088' SET_OF_BOOKS_ID,
                   'ISF LIFE' USER_JE_SOURCE_NAME,
                   DECODE (V_DOCU_TYPE, 'RECEIPT', 'ISF Receipts', 'ISF Others')
                       USER_JE_CATEGORY_NAME,
                   V_SOURCE_CURRENCY CURRENCY_CODE,
                   'A' ACTUAL_FLAG,
                   TO_CHAR (D_DATE, 'DD-MON-YY') ACCOUNTING_DATE,
                   TO_CHAR (D_DATE, 'DD-MON-YY') DATE_CREATED,
                   0 CREATED_BY,
                   DECODE (V_TYPE, 'D', N_AMT, NULL) ENTERED_DR,
                   DECODE (V_TYPE, 'C', N_AMT, NULL) ENTERED_CR,
                   '221' SEGMENT1,
                   DECODE (V_BRANCH_CODE, 'HO', '210', '000') SEGMENT2,
                   '00' SEGMENT3,
                   DECODE (V_LOB_CODE,  'LOB001', '12',  'LOB003', '11','LOB004', '13','LOB005', '14','LOB002', '63',  '00')
                       SEGMENT4,
                   OFA_ACC_CODE SEGMENT5,
                   '00' SEGMENT6,
                   '000' SEGMENT7,
                   '000' SEGMENT8,
                   OFA_VGL_NO GROUP_ID,
                   V_DOCU_TYPE || '-' || V_PROCESS_CODE || '-' || V_PROCESS_NAME
                       JOURNAL_DESCRIPTION,
                   V_DESC LINE_DESCRIPTION,
                   OFA_VGL_NO REFERENCE,
                   TO_CHAR (D_DATE, 'DD-MON-YY') REFERENCE_DATE,
                   V_DOCU_REF_NO REFERENCE1,
                   V_DOCU_TYPE REFERENCE2,
                   NULL N_REF_NO,
                   V_BRANCH_CODE,
                   V_LOB_CODE,
                   V_PROCESS_CODE,
                   V_DOCU_TYPE,
                   D_DATE,
                   OFA_VGL_NO,
                   OFA_VGL_CODE
            FROM (  SELECT TO_DATE (D_DATE, 'DD/MM/RRRR') D_DATE,
                           V_BRANCH_CODE,
                           V_LOB_CODE,
                           V_PROCESS_CODE,
                           V_PROCESS_NAME,
                           V_DOCU_TYPE,
                           V_DOCU_REF_NO,
                           V_GL_CODE,
                           V_DESC,
                           V_TYPE,
                           SUM (N_AMT) N_AMT,
                           OFA_ACC_CODE,
                           V_SOURCE_CURRENCY,
                           OFA_VGL_NO,
                           OFA_VGL_CODE
                    FROM JHL_OFA_GL_TRANSACTIONS TRANS
                    WHERE     1 = 1


                      AND OGLT_PROCESSED = 'Y'
                      AND OGLT_POSTED = 'N'
                      AND V_DOCU_TYPE = 'RECEIPT'
                      AND TRANS.OFA_VGL_NO NOT IN
                          (SELECT OFA_VGL_NO
                           FROM JHL_OFA_GL_INTERFACE INTER
                           WHERE INTER.OFA_VGL_NO = TRANS.OFA_VGL_NO)
                      AND TO_DATE (D_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                            '01-JAN-20',
                            'DD/MM/RRRR')
                        AND TO_DATE (
                                        SYSDATE,
                                        'DD/MM/RRRR')

                    GROUP BY TO_DATE (D_DATE, 'DD/MM/RRRR'),
                             V_BRANCH_CODE,
                             V_LOB_CODE,
                             V_PROCESS_CODE,
                             V_PROCESS_NAME,
                             V_DOCU_TYPE,
                             V_DOCU_REF_NO,
                             V_GL_CODE,
                             V_DESC,
                             V_TYPE,
                             OFA_ACC_CODE,
                             V_SOURCE_CURRENCY,
                             V_DOCU_TYPE,
                             OFA_VGL_NO,
                             OFA_VGL_CODE);

        CURSOR NON_RCT_TRANS
            IS
            SELECT 'NEW' STATUS,
                   '2088' SET_OF_BOOKS_ID,
                   'ISF LIFE' USER_JE_SOURCE_NAME,
                   'ISF Others' USER_JE_CATEGORY_NAME,
                   V_SOURCE_CURRENCY CURRENCY_CODE,
                   'A' ACTUAL_FLAG,
                   TO_CHAR (D_DATE, 'DD-MON-YY') ACCOUNTING_DATE,
                   TO_CHAR (D_DATE, 'DD-MON-YY') DATE_CREATED,
                   0 CREATED_BY,
                   DECODE (V_TYPE, 'D', N_AMT, NULL) ENTERED_DR,
                   DECODE (V_TYPE, 'C', N_AMT, NULL) ENTERED_CR,
                   '221' SEGMENT1,
                   DECODE (V_BRANCH_CODE, 'HO', '210', '000') SEGMENT2,
                   '00' SEGMENT3,
                   DECODE (V_LOB_CODE,  'LOB001', '12',  'LOB003', '11','LOB004', '13','LOB005', '14','LOB002', '63',  '00')
                       SEGMENT4,
                   OFA_ACC_CODE SEGMENT5,
                   '00' SEGMENT6,
                   '000' SEGMENT7,
                   '000' SEGMENT8,
                   OFA_VGL_NO GROUP_ID,
                   V_PROCESS_CODE || '-' || V_PROCESS_NAME JOURNAL_DESCRIPTION,
                   V_DESC LINE_DESCRIPTION,
                   OFA_VGL_NO REFERENCE,
                   TO_CHAR (D_DATE, 'DD-MON-YY') REFERENCE_DATE,
                   OFA_VGL_CODE REFERENCE1,
                   'ISF Others' REFERENCE2,
                   NULL N_REF_NO,
                   V_BRANCH_CODE,
                   V_LOB_CODE,
                   V_PROCESS_CODE,
                   D_DATE,
                   OFA_VGL_NO,
                   OFA_VGL_CODE,
                   OGTL_DRCR_NARRATION
            FROM (  SELECT TO_DATE (D_DATE, 'DD/MM/RRRR') D_DATE,
                           V_BRANCH_CODE,
                           V_LOB_CODE,
                           V_PROCESS_CODE,
                           V_PROCESS_NAME,
                           V_GL_CODE,
                           V_DESC,
                           V_TYPE,
                           SUM (N_AMT) N_AMT,
                           V_SOURCE_CURRENCY,
                           OFA_ACC_CODE,
                           OFA_VGL_NO,
                           OFA_VGL_CODE,
                           OGTL_DRCR_NARRATION
                    FROM JHL_OFA_GL_TRANSACTIONS TRANS
                    WHERE     1 = 1
                      AND OGLT_PROCESSED = 'Y'
                      AND OGLT_POSTED = 'N'
                      AND V_DOCU_TYPE <> 'RECEIPT'
                      AND TRANS.OFA_VGL_NO NOT IN
                          (SELECT OFA_VGL_NO
                           FROM JHL_OFA_NON_RCT_GL_INTER INTER
                           WHERE INTER.OFA_VGL_NO = TRANS.OFA_VGL_NO)
                      AND TO_DATE (D_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                            '01-JAN-20',
                            'DD/MM/RRRR')
                        AND TO_DATE (
                                        SYSDATE,
                                        'DD/MM/RRRR')
                    GROUP BY TO_DATE (D_DATE, 'DD/MM/RRRR'),
                             V_BRANCH_CODE,
                             V_LOB_CODE,
                             V_PROCESS_CODE,
                             V_PROCESS_NAME,
                             V_GL_CODE,
                             V_DESC,
                             V_TYPE,
                             V_SOURCE_CURRENCY,
                             OFA_ACC_CODE,
                             OFA_VGL_NO,
                             OFA_VGL_CODE,
                             OGTL_DRCR_NARRATION);
















        V_VGL_NO   NUMBER;
    BEGIN













        FOR I IN RCT_TRANS
            LOOP
                INSERT INTO JHL_OFA_GL_INTERFACE (OGLI_NO,
                                                  STATUS,
                                                  SET_OF_BOOKS_ID,
                                                  USER_JE_SOURCE_NAME,
                                                  USER_JE_CATEGORY_NAME,
                                                  CURRENCY_CODE,
                                                  ACTUAL_FLAG,
                                                  ACCOUNTING_DATE,
                                                  DATE_CREATED,
                                                  CREATED_BY,
                                                  ENTERED_DR,
                                                  ENTERED_CR,
                                                  SEGMENT1,
                                                  SEGMENT2,
                                                  SEGMENT3,
                                                  SEGMENT4,
                                                  SEGMENT5,
                                                  SEGMENT6,
                                                  SEGMENT7,
                                                  SEGMENT8,
                                                  GROUP_ID,
                                                  JOURNAL_DESCRIPTION,
                                                  LINE_DESCRIPTION,
                                                  REFERENCE,
                                                  REFERENCE_DATE,
                                                  REFERENCE1,
                                                  REFERENCE2,
                                                  N_REF_NO,
                                                  V_BRANCH_CODE,
                                                  V_LOB_CODE,
                                                  V_PROCESS_CODE,
                                                  REFERENCE5,
                                                  REFERENCE6,
                                                  REFERENCE10,
                                                  OGLI_PROCESSED,
                                                  V_DOCU_TYPE,
                                                  OGLI_POSTED,
                                                  D_DATE,
                                                  OFA_VGL_NO,
                                                  OFA_VGL_CODE,
                                                  OGLI_PROCESSED_DT)
                VALUES (JHL_OGLI_NO_SEQ.NEXTVAL,
                        I.STATUS,
                        I.SET_OF_BOOKS_ID,
                        I.USER_JE_SOURCE_NAME,
                        I.USER_JE_CATEGORY_NAME,
                        I.CURRENCY_CODE,
                        I.ACTUAL_FLAG,
                        I.ACCOUNTING_DATE,
                        I.DATE_CREATED,
                        I.CREATED_BY,
                        I.ENTERED_DR,
                        I.ENTERED_CR,
                        I.SEGMENT1,
                        I.SEGMENT2,
                        I.SEGMENT3,
                        I.SEGMENT4,
                        I.SEGMENT5,
                        I.SEGMENT6,
                        I.SEGMENT7,
                        I.SEGMENT8,
                        I.GROUP_ID,
                        I.JOURNAL_DESCRIPTION,
                        I.LINE_DESCRIPTION,
                        I.REFERENCE,
                        I.REFERENCE_DATE,
                        I.REFERENCE1,
                        I.REFERENCE2,
                        I.N_REF_NO,
                        I.V_BRANCH_CODE,
                        I.V_LOB_CODE,
                        I.V_PROCESS_CODE,
                        I.JOURNAL_DESCRIPTION,
                        I.N_REF_NO,
                        I.LINE_DESCRIPTION,
                        'Y',
                        I.V_DOCU_TYPE,
                        'N',
                        I.D_DATE,
                        I.OFA_VGL_NO,
                        I.OFA_VGL_CODE,
                        SYSDATE);


            END LOOP;



        FOR J IN NON_RCT_TRANS
            LOOP
                INSERT INTO JHL_OFA_NON_RCT_GL_INTER (OGLI_NO,
                                                      STATUS,
                                                      SET_OF_BOOKS_ID,
                                                      USER_JE_SOURCE_NAME,
                                                      USER_JE_CATEGORY_NAME,
                                                      CURRENCY_CODE,
                                                      ACTUAL_FLAG,
                                                      ACCOUNTING_DATE,
                                                      DATE_CREATED,
                                                      CREATED_BY,
                                                      ENTERED_DR,
                                                      ENTERED_CR,
                                                      SEGMENT1,
                                                      SEGMENT2,
                                                      SEGMENT3,
                                                      SEGMENT4,
                                                      SEGMENT5,
                                                      SEGMENT6,
                                                      SEGMENT7,
                                                      SEGMENT8,
                                                      GROUP_ID,
                                                      JOURNAL_DESCRIPTION,
                                                      LINE_DESCRIPTION,
                                                      REFERENCE,
                                                      REFERENCE_DATE,
                                                      REFERENCE1,
                                                      REFERENCE2,
                                                      N_REF_NO,
                                                      V_BRANCH_CODE,
                                                      V_LOB_CODE,
                                                      V_PROCESS_CODE,
                                                      REFERENCE5,
                                                      REFERENCE6,
                                                      REFERENCE10,
                                                      OGLI_PROCESSED,
                                                      D_DATE,
                                                      V_DOCU_TYPE,
                                                      OGLI_POSTED,
                                                      OFA_VGL_NO,
                                                      OFA_VGL_CODE,
                                                      OGLI_PROCESSED_DT,
                                                      OGLI_DRCR_NARRATION)
                VALUES (JHL_OGLI_NO_SEQ.NEXTVAL,
                        J.STATUS,
                        J.SET_OF_BOOKS_ID,
                        J.USER_JE_SOURCE_NAME,
                        J.USER_JE_CATEGORY_NAME,
                        J.CURRENCY_CODE,
                        J.ACTUAL_FLAG,
                        J.ACCOUNTING_DATE,
                        J.DATE_CREATED,
                        J.CREATED_BY,
                        J.ENTERED_DR,
                        J.ENTERED_CR,
                        J.SEGMENT1,
                        J.SEGMENT2,
                        J.SEGMENT3,
                        J.SEGMENT4,
                        J.SEGMENT5,
                        J.SEGMENT6,
                        J.SEGMENT7,
                        J.SEGMENT8,
                        J.GROUP_ID,
                        J.JOURNAL_DESCRIPTION,
                        J.LINE_DESCRIPTION,
                        J.REFERENCE,
                        J.REFERENCE_DATE,
                        J.REFERENCE1,
                        J.REFERENCE2,
                        J.N_REF_NO,
                        J.V_BRANCH_CODE,
                        J.V_LOB_CODE,
                        J.V_PROCESS_CODE,
                        J.JOURNAL_DESCRIPTION,
                        J.N_REF_NO,
                        J.LINE_DESCRIPTION,
                        'Y',
                        J.D_DATE,
                        J.USER_JE_CATEGORY_NAME,
                        'N',
                        J.OFA_VGL_NO,
                        J.OFA_VGL_CODE,
                        SYSDATE,
                        J.OGTL_DRCR_NARRATION);

            END LOOP;


        UPDATE JHL_OFA_GL_INTERFACE
        SET OGLI_RECEIPT_NO =
                (SELECT DISTINCT V_OTHER_REF_NO
                 FROM REMT_RECEIPT B
                 WHERE     V_RECEIPT_TABLE = 'DETAIL'
                   AND B.V_RECEIPT_NO = REFERENCE1
                   AND ROWNUM = 1),
            OGLI_RECEIPT_SOURCE =
                (SELECT DISTINCT V_SOURCE
                 FROM REMT_RECEIPT B
                 WHERE     V_RECEIPT_TABLE = 'DETAIL'
                   AND B.V_RECEIPT_NO = REFERENCE1
                   AND ROWNUM = 1),
            OGLI_OTHER_REF_DATE =
                (SELECT DISTINCT D_OTHER_REF_DATE
                 FROM REMT_RECEIPT B
                 WHERE     V_RECEIPT_TABLE = 'DETAIL'
                   AND B.V_RECEIPT_NO = REFERENCE1
                   AND ROWNUM = 1),
            OGLI_RCT_PAYEE =
                TRIM (JHL_GEN_PKG.GET_RECEIPT_PAYEE (REFERENCE1)),
            OGLI_INS_NUMBER =
                (SELECT DISTINCT V_INS_NUMBER
                 FROM REMT_RECEIPT RCT, REMT_RECEIPT_INSTRUMENTS RCT_INS
                 WHERE     RCT.N_RECEIPT_SESSION = RCT_INS.N_RECEIPT_SESSION
                   AND RCT.V_RECEIPT_TABLE = 'DETAIL'
                   AND RCT.V_RECEIPT_NO = REFERENCE1
                   AND ROWNUM = 1)
        WHERE OGLI_PROCESSED = 'Y' AND NVL (OGLI_POSTED, 'Y') <> 'Y';



        /*UPDATE JHL_OFA_GL_INTERFACE
         SET SEGMENT1 = '222',
             SEGMENT4 = '00',
             USER_JE_CATEGORY_NAME = 'DA-Receipts',
             USER_JE_SOURCE_NAME = 'DA-PENSION'
       WHERE     JHL_GEN_PKG.IS_PENSION_RECEIPT (REFERENCE1) = 'Y'
             AND OGLI_PROCESSED = 'Y'
             AND NVL (OGLI_POSTED, 'Y') <> 'Y';*/



        UPDATE JHL_OFA_GL_TRANSACTIONS
        SET OGLT_POSTED = 'Y', OGLT_POSTED_DATE = SYSDATE
        WHERE     OGLT_PROCESSED = 'Y'
          AND TO_DATE (D_DATE, 'DD/MM/RRRR') BETWEEN TO_DATE (
                '01-DEC-21',
                'DD/MM/RRRR')
            AND TO_DATE (
                            SYSDATE,
                            'DD/MM/RRRR')
          AND OGLT_POSTED <> 'Y'
          AND OFA_VGL_NO IN
              (SELECT OFA_VGL_NO
               FROM JHL_OFA_NON_RCT_GL_INTER
               WHERE OGLI_PROCESSED = 'Y' AND OGLI_POSTED = 'N'
               UNION ALL
               SELECT OFA_VGL_NO
               FROM JHL_OFA_GL_INTERFACE
               WHERE OGLI_PROCESSED = 'Y' AND OGLI_POSTED = 'N');



        COMMIT;









































































    END;



    PROCEDURE SEND_GL_TRANS_TO_OFA
        IS
        CURSOR TRANS
            IS
            SELECT OGLI_NO,
                   STATUS,
                   SET_OF_BOOKS_ID,
                   USER_JE_SOURCE_NAME,
                   USER_JE_CATEGORY_NAME,
                   CURRENCY_CODE,
                   ACTUAL_FLAG,
                   CASE
                       WHEN ROUND (TRUNC (SYSDATE) - TRUNC (D_DATE)) <= 30
                           THEN
                           ACCOUNTING_DATE
                       ELSE
                           TO_CHAR (SYSDATE, 'DD-MON-YY')
                       END
                                                             ACCOUNTING_DATE,
                   DATE_CREATED,
                   CREATED_BY,
                   ENTERED_DR,
                   ENTERED_CR,
                   SEGMENT1,
                   SEGMENT2,
                   SEGMENT3,
                   SEGMENT4,
                   SEGMENT5,
                   SEGMENT6,
                   SEGMENT7,
                   SEGMENT8,
                   GROUP_ID,
                   JOURNAL_DESCRIPTION,
                   LINE_DESCRIPTION,
                   TO_CHAR (NVL (OGLI_RCT_PAYEE, REFERENCE)) REFERENCE,
                   REFERENCE_DATE,
                   DECODE (
                           OGLI_RECEIPT_SOURCE,
                           'OFF_REC', NVL (OGLI_RECEIPT_NO, REFERENCE1),
                           DECODE (NVL (OGLI_RECEIPT_NO, 'XX'),
                                   'XX', REFERENCE1,
                                   REFERENCE1 || '-' || OGLI_RECEIPT_NO))
                                                             REFERENCE1,
                   REFERENCE2,
                   N_REF_NO,
                   V_BRANCH_CODE,
                   V_LOB_CODE,
                   V_PROCESS_CODE,
                   REFERENCE5,
                   TO_CHAR (NVL (OGLI_RCT_PAYEE, REFERENCE)) REFERENCE6,
                   DECODE (
                           NVL (OGLI_INS_NUMBER, 'XX'),
                           'XX', DECODE (NVL (OGLI_RECEIPT_NO, 'XX'),
                                         'XX', REFERENCE1,
                                         REFERENCE1 || '-' || OGLI_RECEIPT_NO),
                           DECODE (NVL (OGLI_RECEIPT_NO, 'XX'),
                                   'XX', REFERENCE1,
                                   REFERENCE1 || '-' || OGLI_RECEIPT_NO)
                               || ' - '
                               || OGLI_INS_NUMBER)
                                                             REFERENCE10,
                   OGLI_PROCESSED,
                   V_DOCU_TYPE,
                   OFA_VGL_NO,
                   OFA_VGL_CODE,
                   OGLI_POSTED,
                   D_DATE
            FROM JHL_OFA_GL_INTERFACE
            WHERE 1 = 1
              AND OGLI_PROCESSED = 'Y' AND OGLI_POSTED = 'N'

            UNION ALL
            SELECT OGLI_NO,
                   STATUS,
                   SET_OF_BOOKS_ID,
                   USER_JE_SOURCE_NAME,
                   USER_JE_CATEGORY_NAME,
                   CURRENCY_CODE,
                   ACTUAL_FLAG,
                   CASE
                       WHEN ROUND (TRUNC (SYSDATE) - TRUNC (D_DATE)) <= 30
                           THEN
                           ACCOUNTING_DATE
                       ELSE
                           TO_CHAR (SYSDATE, 'DD-MON-YY')
                       END
                                       ACCOUNTING_DATE,
                   DATE_CREATED,
                   CREATED_BY,
                   ENTERED_DR,
                   ENTERED_CR,
                   SEGMENT1,
                   SEGMENT2,
                   SEGMENT3,
                   SEGMENT4,
                   SEGMENT5,
                   SEGMENT6,
                   SEGMENT7,
                   SEGMENT8,
                   GROUP_ID,
                   JOURNAL_DESCRIPTION,
                   LINE_DESCRIPTION,
                   TO_CHAR (REFERENCE) REFERENCE,
                   REFERENCE_DATE,
                   REFERENCE1,
                   REFERENCE2,
                   N_REF_NO,
                   V_BRANCH_CODE,
                   V_LOB_CODE,
                   V_PROCESS_CODE,
                   REFERENCE5,
                   DECODE (OGLI_DRCR_NARRATION, 'X', NULL, OGLI_DRCR_NARRATION)
                                       REFERENCE6,
                   DECODE (
                           NVL (OGLI_SUN_JV, 'XX'),
                           'XX', REFERENCE10 || '-' || REFERENCE1,
                           REFERENCE10 || '-' || REFERENCE1 || '-' || OGLI_SUN_JV)
                                       REFERENCE10,
                   OGLI_PROCESSED,
                   V_DOCU_TYPE,
                   OFA_VGL_NO,
                   OFA_VGL_CODE,
                   OGLI_POSTED,
                   D_DATE
            FROM JHL_OFA_NON_RCT_GL_INTER
            WHERE 1 = 1
              AND OGLI_PROCESSED = 'Y' AND OGLI_POSTED = 'N';
    BEGIN



















        FOR I IN TRANS
            LOOP
                INSERT INTO APPS.GL_INTERFACE@JICOFPROD.COM (STATUS,
                                                             SET_OF_BOOKS_ID,
                                                             LEDGER_ID,
                                                             USER_JE_SOURCE_NAME,
                                                             USER_JE_CATEGORY_NAME,
                                                             CURRENCY_CODE,
                                                             ACTUAL_FLAG,
                                                             ACCOUNTING_DATE,
                                                             DATE_CREATED,
                                                             CREATED_BY,
                                                             ENTERED_DR,
                                                             ENTERED_CR,
                                                             SEGMENT1,
                                                             SEGMENT2,
                                                             SEGMENT3,
                                                             SEGMENT4,
                                                             SEGMENT5,
                                                             SEGMENT6,
                                                             SEGMENT7,
                                                             SEGMENT8,
                                                             GROUP_ID,
                                                             REFERENCE5,
                                                             REFERENCE10,
                                                             REFERENCE6,
                                                             REFERENCE_DATE,
                                                             REFERENCE1,
                                                             REFERENCE2)
                VALUES (I.STATUS,
                        I.SET_OF_BOOKS_ID,
                        I.SET_OF_BOOKS_ID,
                        TRIM (I.USER_JE_SOURCE_NAME),
                        TRIM (I.USER_JE_CATEGORY_NAME),
                        I.CURRENCY_CODE,
                        I.ACTUAL_FLAG,
                        I.ACCOUNTING_DATE,
                        I.DATE_CREATED,
                        I.CREATED_BY,
                        I.ENTERED_DR,
                        I.ENTERED_CR,
                        I.SEGMENT1,
                        I.SEGMENT2,
                        I.SEGMENT3,
                        I.SEGMENT4,
                        I.SEGMENT5,
                        I.SEGMENT6,
                        I.SEGMENT7,
                        I.SEGMENT8,
                        I.GROUP_ID,
                        I.REFERENCE5,
                        I.REFERENCE10,
                        I.REFERENCE6,
                        I.REFERENCE_DATE,
                        I.REFERENCE1,
                        I.REFERENCE2);


                UPDATE JHL_OFA_GL_INTERFACE
                SET OGLI_POSTED = 'Y', OGLI_POSTED_DATE = SYSDATE
                WHERE OGLI_NO = I.OGLI_NO;

                UPDATE JHL_OFA_NON_RCT_GL_INTER
                SET OGLI_POSTED = 'Y', OGLI_POSTED_DATE = SYSDATE
                WHERE OGLI_NO = I.OGLI_NO;

                COMMIT;
            END LOOP;



        COMMIT;
    END;

    PROCEDURE LOG_VOUCHER_ERROR (VOU_NO VARCHAR, V_ERROR_MSG VARCHAR)
        IS
        PRAGMA AUTONOMOUS_TRANSACTION;
    BEGIN
        INSERT INTO JHL_OFA_VOUCHER_ERROR_LOG (OVEL_NO,
                                               V_VOU_NO,
                                               OVEL_ERROR_MSG,
                                               OVEL_DATE)
        VALUES (OFA_OVEL_NO_SEQ.NEXTVAL,
                VOU_NO,
                V_ERROR_MSG,
                SYSDATE);

        COMMIT;
    END;

    PROCEDURE CREATE_INDIVIDUAL_SUPPLIER_NEW (
        V_CUST_REF_NO    NUMBER,
        V_AGENT_NO       NUMBER DEFAULT NULL)
        IS
        CURSOR SUPPLIERS
            IS
            SELECT C.V_NAME VENDOR_NAME,
                   DECODE (C.V_STATUS, 'A', 'Y', 'N') ENABLED_FLAG,
                   'INDIVIDUAL' TYPE_OF_SUPPLIER,
                   'Immediate' TERMS_NAME,
                   'LIFE-CLAIM' PAY_GROUP,
                   99 PAY_PRIORITY,
                   'UGX' INVOICE_CURRENCY,
                   'UGX' PAYMENT_CURRENCY,
                   'N' HOLD_FLAG,
                   'INVOICE' TERMS_DATE_BASIS,
                   'N' INSPEC_REQ_FLAG,
                   'N' RCPT_REQUIRED_FLAG,
                   'R' MATCH_OPTION,
                   'CHECK' PAYM_METHOD_CODE,
                   JHL_BI_UTILS.GET_IND_CUSTOMER_PIN (C.N_CUST_REF_NO)
                       LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2,
                   C.V_LASTUPD_USER LEGACY_REF3,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF4,
                   C.V_LASTUPD_USER LEGACY_REF5,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF6,
                   TO_DATE (D_BIRTH_DATE, 'DD-MM-RRRR') LEGACY_REF7,
                   'Uganda' LEGACY_REF9,
                   '11' LEGACY_REF11,
                   SYSDATE LAST_UPDATE_DATE,
                   N_CUST_REF_NO
            FROM GNMT_CUSTOMER_MASTER C

            WHERE N_CUST_REF_NO = V_CUST_REF_NO;


        CURSOR SUPPLIERS_SITE (
            V_CUST_REF_NO NUMBER)
            IS
            SELECT P.V_POLICY_NO VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = P.N_PAYER_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                 ADDRESS_LINE1,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = P.N_PAYER_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                 CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'LIFE-CLAIM' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152037' PREPAYMENT_ACCOUNT_ID,
                   '202301' LIABILITY_ACCOUNT,
                   JHL_BI_UTILS.GET_IND_CUSTOMER_PIN (C.N_CUST_REF_NO)
                       LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2,
                   P.V_POLICY_NO LEGACY_REF3,
                   P.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF5,
                   P.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '11' LEGACY_REF9,
                   '12' LEGACY_REF10
            FROM GNMT_POLICY P, GNMT_CUSTOMER_MASTER C, GNLU_PAY_METHOD PM
            WHERE     P.N_PAYER_REF_NO = C.N_CUST_REF_NO
              AND P.V_PMT_METHOD_CODE = PM.V_PMT_METHOD_CODE(+)

              AND C.N_CUST_REF_NO = V_CUST_REF_NO
            UNION
            SELECT TO_CHAR ('PYR-' || C.N_CUST_REF_NO) VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       ADDRESS_LINE1,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'LIFE-COMMISSION' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152121' PREPAYMENT_ACCOUNT_ID,
                   '202351' LIABILITY_ACCOUNT,
                   JHL_BI_UTILS.GET_IND_CUSTOMER_PIN (C.N_CUST_REF_NO)
                                                       LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2,
                   TO_CHAR (NULL) LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '13' LEGACY_REF9,
                   '12' LEGACY_REF10
            FROM AMMM_AGENT_MASTER AGN, GNMT_CUSTOMER_MASTER C
            WHERE     AGN.N_CUST_REF_NO = C.N_CUST_REF_NO

              AND AGN.N_AGENT_NO = NVL (V_AGENT_NO, AGN.N_AGENT_NO)
              AND C.N_CUST_REF_NO = V_CUST_REF_NO
            UNION
            SELECT TO_CHAR ('PYR-' || C.N_CUST_REF_NO) VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       ADDRESS_LINE1,
                   NVL (
                           (SELECT V_ADD_TWO
                            FROM GNDT_CUSTOMER_ADDRESS
                            WHERE N_CUST_REF_NO = C.N_CUST_REF_NO AND ROWNUM = 1),
                           'KAMPALA')
                                                       CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'LIFE-CLAIM' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152037' PREPAYMENT_ACCOUNT_ID,
                   '202301' LIABILITY_ACCOUNT,
                   JHL_BI_UTILS.GET_IND_CUSTOMER_PIN (C.N_CUST_REF_NO)
                                                       LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2,
                   TO_CHAR (NULL) LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '13' LEGACY_REF9,
                   '12' LEGACY_REF10
            FROM GNMT_CUSTOMER_MASTER C
            WHERE     TO_CHAR (C.N_CUST_REF_NO) NOT IN
                      (SELECT AGN.N_CUST_REF_NO
                       FROM AMMM_AGENT_MASTER AGN
                       WHERE AGN.N_CUST_REF_NO IS NOT NULL
                       UNION ALL
                       SELECT POL.N_PAYER_REF_NO
                       FROM GNMT_POLICY POL
                       WHERE POL.N_PAYER_REF_NO IS NOT NULL)
              AND C.N_CUST_REF_NO = V_CUST_REF_NO;


        CURSOR SUPPLIER_CONTACT (
            V_CUST_REF_NO NUMBER)
            IS
            SELECT 'JHL_UG_LIF_OU' OPERATING_UNIT,
                   NVL (
                           TRIM (
                                   SUBSTR (TRIM (NVL (V_FIRST_NAME, C.V_NAME)),
                                           1,
                                           INSTR (NVL (V_FIRST_NAME, C.V_NAME), ' ') - 1)),
                           C.V_NAME)
                                   FIRST_NAME,


                   NVL (
                           TRIM (SUBSTR (TRIM (NVL (V_FIRST_NAME, C.V_NAME)),
                                         INSTR (TRIM (NVL (V_FIRST_NAME, C.V_NAME)),
                                                ' ',
                                                -1,
                                                1))),
                           '.')
                                   LAST_NAME,

                   NVL (
                           (SELECT V_CONTACT_NUMBER
                            FROM GNDT_CUSTMOBILE_CONTACTS
                            WHERE     N_CUST_REF_NO = C.N_CUST_REF_NO
                              AND V_STATUS = 'A'
                              AND V_CONTACT_NUMBER NOT LIKE '%@%'
                              AND ROWNUM = 1),
                           '.')
                                   PHONE,
                   NVL (
                           (SELECT V_CONTACT_NUMBER
                            FROM GNDT_CUSTMOBILE_CONTACTS
                            WHERE     N_CUST_REF_NO = C.N_CUST_REF_NO
                              AND V_STATUS = 'A'
                              AND V_CONTACT_NUMBER LIKE '%@%'
                              AND ROWNUM = 1),
                           '.')
                                   EMAIL_ADDRESS,
                   JHL_BI_UTILS.GET_IND_CUSTOMER_PIN (C.N_CUST_REF_NO)
                                   LEGACY_REF1,
                   TO_CHAR (C.N_CUST_REF_NO) LEGACY_REF2
            FROM GNMT_CUSTOMER_MASTER C
            WHERE C.N_CUST_REF_NO = V_CUST_REF_NO;

        V_SUPPLIER_COUNT        NUMBER := 0;
        V_SUPPLIER_SITE_COUNT   NUMBER := 0;
        V_PIN_COUNT             NUMBER := 0;
        V_SITE_COUNT            NUMBER := 0;
        V_CONTACT_COUNT         NUMBER := 0;

        V_OSP_PIN_NO            VARCHAR2 (100);

        V_AGENT_COUNT           NUMBER;
        V_POLICY_COUNT          NUMBER;
        V_VENDOR_TYPE           VARCHAR2 (150);
        V_PAY_GROUP             VARCHAR2 (50);
    BEGIN
        FOR I IN SUPPLIERS
            LOOP
                IF JHL_BI_UTILS.CHECK_VALID_PIN (I.LEGACY_REF1) <> 'Y'
                THEN
                    INSERT
                    INTO JHL_OFA_SUPPLIER_ERRORS (N_CUST_REF_NO, SP_PIN_NO, SP_DATE)
                    VALUES (I.N_CUST_REF_NO, I.LEGACY_REF1, SYSDATE);
                END IF;


                IF JHL_BI_UTILS.CHECK_VALID_PIN (I.LEGACY_REF1) = 'Y'
                THEN
                    DELETE FROM JHL_OFA_SUPPLIER
                    WHERE N_CUST_REF_NO = I.N_CUST_REF_NO;

                    BEGIN
                        SELECT COUNT (*)
                        INTO V_SUPPLIER_COUNT
                        FROM JHL_OFA_SUPPLIER
                        WHERE N_CUST_REF_NO = I.N_CUST_REF_NO;

                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_SUPPLIER_COUNT := 0;
                    END;


                    IF V_SUPPLIER_COUNT = 0
                    THEN
                        DELETE FROM JHL_OFA_SUPPLIER
                        WHERE N_CUST_REF_NO = I.N_CUST_REF_NO;
                    END IF;


                    IF V_SUPPLIER_COUNT = 0
                    THEN
                        INSERT INTO JHL_OFA_SUPPLIER (OSP_NO,
                                                      N_CUST_REF_NO,
                                                      OSP_PIN_NO,
                                                      OSP_DATE,
                                                      OSP_ID_NO)
                        VALUES (JHL_OSP_NO_SEQ.NEXTVAL,
                                I.N_CUST_REF_NO,
                                I.LEGACY_REF1,
                                SYSDATE,
                                I.LEGACY_REF2);
                    END IF;

                    BEGIN
                        V_OSP_PIN_NO := I.LEGACY_REF1;




                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR ('Error Getting Pin number');
                    END;



                    BEGIN
                        SELECT COUNT (*)
                        INTO V_PIN_COUNT
                        FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                        WHERE     PAY_GROUP IN ('LIFE-CLAIM', 'LIFE-COMMISSION')
                          AND LEGACY_REF1 = I.LEGACY_REF1;
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_PIN_COUNT := 0;
                    END;



                    SELECT COUNT (*)
                    INTO V_AGENT_COUNT
                    FROM AMMM_AGENT_MASTER AGN
                    WHERE AGN.N_CUST_REF_NO = V_CUST_REF_NO;

                    SELECT COUNT (*)
                    INTO V_POLICY_COUNT
                    FROM GNMT_POLICY
                    WHERE N_PAYER_REF_NO = V_CUST_REF_NO;



                    IF V_AGENT_COUNT > 0 AND V_POLICY_COUNT = 0
                    THEN
                        V_VENDOR_TYPE := 'AGENTS';
                        V_PAY_GROUP := 'LIFE-COMMISSION';
                    ELSE
                        V_VENDOR_TYPE := I.TYPE_OF_SUPPLIER;
                        V_PAY_GROUP := I.PAY_GROUP;
                    END IF;

                    BEGIN
                        IF V_PIN_COUNT = 0
                        THEN
                            INSERT
                            INTO XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM (
                                SEQ_ID,
                                PROCESS_FLAG,
                                VENDOR_NAME,
                                ENABLED_FLAG,
                                TYPE_OF_SUPPLIER,
                                TERMS_NAME,
                                PAY_GROUP,
                                PAY_PRIORITY,
                                INVOICE_CURRENCY,
                                PAYMENT_CURRENCY,
                                HOLD_FLAG,
                                TERMS_DATE_BASIS,
                                INSPEC_REQ_FLAG,
                                RCPT_REQUIRED_FLAG,
                                MATCH_OPTION,
                                PAYM_METHOD_CODE,
                                LEGACY_REF1,
                                LEGACY_REF2,
                                LEGACY_REF3,
                                LEGACY_REF4,
                                LEGACY_REF5,
                                LEGACY_REF6,
                                LEGACY_REF7,
                                LEGACY_REF9,
                                LEGACY_REF11,
                                LAST_UPDATE_DATE)
                            VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                    1,
                                    I.VENDOR_NAME,
                                    I.ENABLED_FLAG,
                                    NVL (V_VENDOR_TYPE, I.TYPE_OF_SUPPLIER),
                                    I.TERMS_NAME,
                                    NVL (V_PAY_GROUP, I.PAY_GROUP),
                                    I.PAY_PRIORITY,
                                    I.INVOICE_CURRENCY,
                                    I.PAYMENT_CURRENCY,
                                    I.HOLD_FLAG,
                                    I.TERMS_DATE_BASIS,
                                    I.INSPEC_REQ_FLAG,
                                    I.RCPT_REQUIRED_FLAG,
                                    I.MATCH_OPTION,
                                    I.PAYM_METHOD_CODE,
                                    I.LEGACY_REF1,
                                    I.LEGACY_REF2,
                                    I.LEGACY_REF3,
                                    I.LEGACY_REF4,
                                    I.LEGACY_REF5,
                                    I.LEGACY_REF6,
                                    I.LEGACY_REF7,
                                    I.LEGACY_REF9,
                                    I.LEGACY_REF11,
                                    I.LAST_UPDATE_DATE);
                        END IF;
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR (
                                        'I.LEGACY_REF1=='
                                            || I.LEGACY_REF1
                                            || 'v_cust_ref_no=='
                                            || V_CUST_REF_NO);
                    END;






                    FOR J IN SUPPLIERS_SITE (I.N_CUST_REF_NO)
                        LOOP

                            BEGIN
                                SELECT COUNT (*)
                                INTO V_SUPPLIER_SITE_COUNT
                                FROM JHL_OFA_SUPPLIER_SITE
                                WHERE     N_CUST_REF_NO = I.N_CUST_REF_NO
                                  AND NVL (V_POLICY_NO, 'XXXX') =
                                      NVL (J.LEGACY_REF3, 'XXXX');
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_SUPPLIER_SITE_COUNT := 0;
                            END;



                            BEGIN
                                SELECT COUNT (*)
                                INTO V_SITE_COUNT
                                FROM APPS.XXJIC_AP_SUPPLIER_MAP@JICOFPROD.COM
                                WHERE     LOB_NAME IN ('JHL_UG_LIF_OU')
                                  AND PIN_NO = I.LEGACY_REF1
                                  AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE;
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_SITE_COUNT := 0;
                            END;



                            IF V_SITE_COUNT = 0
                            THEN
                                BEGIN
                                    SELECT COUNT (*)
                                    INTO V_SITE_COUNT
                                    FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                                    WHERE     PAY_GRP_LKP_CODE IN
                                              ('LIFE-CLAIM', 'LIFE-COMMISSION')
                                      AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE
                                      AND LEGACY_REF1 = I.LEGACY_REF1
                                      AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                                EXCEPTION
                                    WHEN OTHERS
                                        THEN
                                            V_SITE_COUNT := 0;
                                END;
                            END IF;


                            IF V_SUPPLIER_SITE_COUNT = 0
                            THEN
                                INSERT INTO JHL_OFA_SUPPLIER_SITE (OSPC_NO,
                                                                   N_CUST_REF_NO,
                                                                   V_POLICY_NO,
                                                                   OSPC_DATE)
                                VALUES (JHL_OSPC_NO_SEQ.NEXTVAL,
                                        I.N_CUST_REF_NO,
                                        J.LEGACY_REF3,
                                        SYSDATE);
                            END IF;

                            IF V_SITE_COUNT = 0
                            THEN
                                INSERT
                                INTO XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM (
                                    SEQ_ID,
                                    PROCESS_FLAG,
                                    VENDOR_SITE_CODE,
                                    PURCHASIN_SITE_FLAG,
                                    RFQ_ONLY_SITE_FLAG,
                                    PAY_SITE_FLAG,
                                    ADDRESS_LINE1,
                                    CITY,
                                    STATE,
                                    ZIP,
                                    COUNTRY,
                                    TERMS_DATE_BASIS,
                                    PAY_GRP_LKP_CODE,
                                    TERMS_NAME,
                                    INV_CURR_CODE,
                                    PYMT_CURR_CODE,
                                    OPERATING_UNIT,
                                    MATCH_OPTION,
                                    PAYMENT_METHOD_CODE,
                                    PREPAYMENT_ACCOUNT_ID,
                                    PREPAYMENT_ACCOUNT,
                                    LIABILITY_ACCOUNT,
                                    LIABILITY_ACCOUNT_ID,
                                    LEGACY_REF1,
                                    LEGACY_REF2,
                                    LEGACY_REF3,
                                    LEGACY_REF4,
                                    LEGACY_REF5,
                                    LEGACY_REF6,
                                    LEGACY_REF7,
                                    LEGACY_REF8,
                                    LEGACY_REF9,
                                    LEGACY_REF10)
                                VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                        1,
                                        J.VENDOR_SITE_CODE,
                                        J.PURCHASIN_SITE_FLAG,
                                        J.RFQ_ONLY_SITE_FLAG,
                                        J.PAY_SITE_FLAG,
                                        J.ADDRESS_LINE1,
                                        J.CITY,
                                        J.STATE,
                                        J.ZIP,
                                        J.COUNTRY,
                                        J.TERMS_DATE_BASIS,
                                        J.PAY_GRP_LKP_CODE,
                                        J.TERMS_NAME,
                                        J.INV_CURR_CODE,
                                        J.PYMT_CURR_CODE,
                                        J.OPERATING_UNIT,
                                        J.MATCH_OPTION,
                                        J.PAYMENT_METHOD_CODE,
                                        J.PREPAYMENT_ACCOUNT_ID,
                                        J.PREPAYMENT_ACCOUNT_ID,
                                        J.LIABILITY_ACCOUNT,
                                        J.LIABILITY_ACCOUNT,
                                        I.LEGACY_REF1,
                                        J.LEGACY_REF2,
                                        J.LEGACY_REF3,
                                        J.LEGACY_REF4,
                                        J.LEGACY_REF5,
                                        J.LEGACY_REF6,
                                        J.LEGACY_REF7,
                                        J.LEGACY_REF8,
                                        J.LEGACY_REF9,
                                        J.LEGACY_REF10);
                            END IF;
                        END LOOP;



                    FOR C IN SUPPLIER_CONTACT (I.N_CUST_REF_NO)
                        LOOP
                            BEGIN
                                SELECT COUNT (*)
                                INTO V_CONTACT_COUNT
                                FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                                WHERE     LEGACY_REF1 = V_OSP_PIN_NO
                                  AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_CONTACT_COUNT := 0;
                            END;

                            IF V_CONTACT_COUNT = 0
                            THEN
                                INSERT
                                INTO XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM (
                                    SEQ_ID,
                                    PROCESS_FLAG,
                                    OPERATING_UNIT,
                                    FIRST_NAME,
                                    LAST_NAME,
                                    PHONE,
                                    EMAIL_ADDRESS,
                                    LEGACY_REF1,
                                    LEGACY_REF2)
                                VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                        1,
                                        C.OPERATING_UNIT,
                                        C.FIRST_NAME,
                                        C.LAST_NAME,
                                        C.PHONE,
                                        C.EMAIL_ADDRESS,
                                        V_OSP_PIN_NO,
                                        I.LEGACY_REF2);
                            END IF;
                        END LOOP;



                    BEGIN
                        SELECT COUNT (*)
                        INTO V_SITE_COUNT
                        FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                        WHERE     PAY_GRP_LKP_CODE IN
                                  ('LIFE-CLAIM', 'LIFE-COMMISSION')
                          AND LEGACY_REF1 = V_OSP_PIN_NO
                          AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_SITE_COUNT := 0;
                    END;


                    IF V_SITE_COUNT = 0
                    THEN
                        DELETE FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                        WHERE     LEGACY_REF1 = V_OSP_PIN_NO
                          AND PAY_GROUP IN ('LIFE-CLAIM', 'LIFE-COMMISSION')
                          AND LEGACY_REF9 = 'Uganda';

                        DELETE FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                        WHERE     LEGACY_REF1 = V_OSP_PIN_NO
                          AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                    END IF;
                END IF;
            END LOOP;

        COMMIT;

    END;

    PROCEDURE CREATE_CORPORATE_SUPPLIER_NEW (
        COMPANY_CODE      VARCHAR,
        COMPANY_BRANCH    VARCHAR,
        V_AGENT_NO        NUMBER DEFAULT NULL)
        IS
        CURSOR SUPPLIERS
            IS
            SELECT C.V_COMPANY_NAME VENDOR_NAME,
                   DECODE (C.V_COMP_STAT, 'A', 'Y', 'N') ENABLED_FLAG,
                   'COMPANY' TYPE_OF_SUPPLIER,
                   'Immediate' TERMS_NAME,
                   'LIFE-CLAIM' PAY_GROUP,
                   99 PAY_PRIORITY,
                   'UGX' INVOICE_CURRENCY,
                   'UGX' PAYMENT_CURRENCY,
                   'N' HOLD_FLAG,
                   'INVOICE' TERMS_DATE_BASIS,
                   'N' INSPEC_REQ_FLAG,
                   'N' RCPT_REQUIRED_FLAG,
                   'R' MATCH_OPTION,
                   'CHECK' PAYM_METHOD_CODE,
                   V_REGN_NO LEGACY_REF1,
                   TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH)
                       LEGACY_REF2,
                   C.V_LASTUPD_USER LEGACY_REF3,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF4,
                   C.V_LASTUPD_USER LEGACY_REF5,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF6,
                   NULL LEGACY_REF7,
                   'Uganda' LEGACY_REF9,
                   '11' LEGACY_REF11,
                   SYSDATE LAST_UPDATE_DATE,
                   C.V_COMPANY_CODE,
                   C.V_COMPANY_BRANCH
            FROM GNMM_COMPANY_MASTER C
            WHERE     C.V_COMPANY_CODE = COMPANY_CODE
              AND C.V_COMPANY_BRANCH = COMPANY_BRANCH;



        CURSOR SUPPLIER_SITE (
            V_COMPANYCODE      VARCHAR,
            V_COMPANYBRANCH    VARCHAR)
            IS
            SELECT P.V_POLICY_NO VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NULL ATTENTION_AR_FLAG,
                   NVL (
                           (SELECT G.V_POST_BOX
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                 ADDRESS_LINE1,
                   NVL (
                           (SELECT G.V_TOWN
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                 CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   NULL PROVINCE,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'LIFE-CLAIM' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152037' PREPAYMENT_ACCOUNT_ID,
                   '202301' LIABILITY_ACCOUNT,
                   V_REGN_NO LEGACY_REF1,
                   TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH)
                       LEGACY_REF2,
                   P.V_POLICY_NO LEGACY_REF3,
                   P.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF5,
                   P.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, P.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                       LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '11' LEGACY_REF9,
                   '11' LEGACY_REF10,
                   C.V_COMPANY_CODE,
                   C.V_COMPANY_BRANCH
            FROM GNMT_POLICY P,
                 GNMM_COMPANY_MASTER C,
                 GNMM_POLICY_STATUS_MASTER STATUS,
                 GNLU_INSTITUTION_TYPE INS,
                 GNLU_PAY_METHOD PM
            WHERE     P.V_COMPANY_CODE = C.V_COMPANY_CODE
              AND P.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
              AND P.V_CNTR_STAT_CODE = STATUS.V_STATUS_CODE
              AND C.V_INST_TYPE = INS.V_INST_TYPE
              AND P.V_PMT_METHOD_CODE = PM.V_PMT_METHOD_CODE


              AND C.V_COMPANY_CODE = V_COMPANYCODE
              AND C.V_COMPANY_BRANCH = V_COMPANYBRANCH
            UNION
            SELECT SUBSTR (
                           TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH),
                           1,
                           15)
                                     VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NULL ATTENTION_AR_FLAG,
                   NVL (
                           (SELECT G.V_POST_BOX
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = AGN.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = AGN.V_COMPANY_BRANCH),
                           'KAMPALA')
                                     ADDRESS_LINE1,
                   NVL (
                           (SELECT G.V_TOWN
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = AGN.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = AGN.V_COMPANY_BRANCH),
                           'KAMPALA')
                                     CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   NULL PROVINCE,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'LIFE-COMMISSION' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152121' PREPAYMENT_ACCOUNT_ID,
                   '202351' LIABILITY_ACCOUNT,
                   C.V_REGN_NO LEGACY_REF1,
                   TO_CHAR (
                           TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH))
                                     LEGACY_REF2,
                   TO_CHAR (NULL) LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (C.V_LASTUPD_INFTIM, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                     LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (C.V_LASTUPD_INFTIM, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                     LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '12' LEGACY_REF9,
                   '11' LEGACY_REF10,
                   AGN.V_COMPANY_CODE,
                   AGN.V_COMPANY_BRANCH
            FROM GNMM_COMPANY_MASTER C,
                 AMMM_AGENT_MASTER AGN,
                 GNLU_INSTITUTION_TYPE INS
            WHERE     C.V_COMPANY_CODE = AGN.V_COMPANY_CODE
              AND C.V_COMPANY_BRANCH = AGN.V_COMPANY_BRANCH
              AND C.V_INST_TYPE = INS.V_INST_TYPE

              AND AGN.V_COMPANY_CODE = V_COMPANYCODE
              AND AGN.V_COMPANY_BRANCH = V_COMPANYBRANCH
              AND AGN.N_AGENT_NO = NVL (V_AGENT_NO, AGN.N_AGENT_NO)
            UNION
            SELECT SUBSTR (
                           TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH),
                           1,
                           15)
                                    VENDOR_SITE_CODE,
                   'N' PURCHASIN_SITE_FLAG,
                   'N' RFQ_ONLY_SITE_FLAG,
                   'Y' PAY_SITE_FLAG,
                   NULL ATTENTION_AR_FLAG,
                   NVL (
                           (SELECT G.V_POST_BOX
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                    ADDRESS_LINE1,
                   NVL (
                           (SELECT G.V_TOWN
                            FROM GNDT_COMPANY_ADDRESS G
                            WHERE     G.V_COMPANY_CODE = C.V_COMPANY_CODE
                              AND G.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH),
                           'KAMPALA')
                                    CITY,
                   'UGANDA' STATE,
                   '+256' ZIP,
                   NULL PROVINCE,
                   'UG' COUNTRY,
                   'INVOICE' TERMS_DATE_BASIS,
                   'LIFE-CLAIM' PAY_GRP_LKP_CODE,
                   'IMMEDIATE' TERMS_NAME,
                   'UGX' INV_CURR_CODE,
                   'UGX' PYMT_CURR_CODE,
                   'JHL_UG_LIF_OU' OPERATING_UNIT,
                   'R' MATCH_OPTION,
                   'CHECK' PAYMENT_METHOD_CODE,
                   '152037' PREPAYMENT_ACCOUNT_ID,
                   '202301' LIABILITY_ACCOUNT,
                   V_REGN_NO LEGACY_REF1,
                   TO_CHAR (C.V_COMPANY_CODE || '-' || C.V_COMPANY_BRANCH)
                                    LEGACY_REF2,
                   NULL LEGACY_REF3,
                   C.V_LASTUPD_USER LEGACY_REF4,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                    LEGACY_REF5,
                   C.V_LASTUPD_USER LEGACY_REF6,
                   TO_DATE (NVL (D_CREATED_DATE, C.V_LASTUPD_INFTIM),
                            'DD-MM-RRRR')
                                    LEGACY_REF7,
                   '210' LEGACY_REF8,
                   '11' LEGACY_REF9,
                   '11' LEGACY_REF10,
                   C.V_COMPANY_CODE,
                   C.V_COMPANY_BRANCH
            FROM GNMM_COMPANY_MASTER C
            WHERE     1 = 1
              AND C.V_COMPANY_CODE = V_COMPANYCODE
              AND C.V_COMPANY_BRANCH = V_COMPANYBRANCH
              AND (C.V_COMPANY_CODE, C.V_COMPANY_BRANCH) NOT IN
                  (SELECT AGN.V_COMPANY_CODE, AGN.V_COMPANY_BRANCH
                   FROM AMMM_AGENT_MASTER AGN
                   WHERE AGN.V_COMPANY_CODE IS NOT NULL)
              AND (C.V_COMPANY_CODE, C.V_COMPANY_BRANCH) NOT IN
                  (SELECT P.V_COMPANY_CODE, P.V_COMPANY_BRANCH
                   FROM GNMT_POLICY P,
                        GNMM_POLICY_STATUS_MASTER STATUS
                   WHERE     P.V_CNTR_STAT_CODE = STATUS.V_STATUS_CODE
                     AND P.V_COMPANY_CODE IS NOT NULL

                  );


        CURSOR SUPPLIER_CONTACT (
            V_COMPANYCODE      VARCHAR,
            V_COMPANYBRANCH    VARCHAR)
            IS
            SELECT DISTINCT
                'JHL_UG_LIF_OU' OPERATING_UNIT,
                C.V_COMPANY_NAME FIRST_NAME,
                '.' LAST_NAME,
                NVL (
                        SUBSTR (
                                (SELECT V_CONTACT_NUMBER
                                 FROM GNDT_COMPMOBILE_CONTACTS H
                                 WHERE     H.V_COMPANY_CODE = C.V_COMPANY_CODE
                                   AND H.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
                                   AND V_CONTACT_NUMBER NOT LIKE '%@%'
                                   AND ROWNUM = 1),
                                1,
                                30),
                        '.')
                    PHONE,
                NVL (
                        (SELECT V_CONTACT_NUMBER
                         FROM GNDT_COMPMOBILE_CONTACTS H
                         WHERE     H.V_COMPANY_CODE = C.V_COMPANY_CODE
                           AND H.V_COMPANY_BRANCH = C.V_COMPANY_BRANCH
                           AND V_CONTACT_NUMBER LIKE '%@%'
                           AND ROWNUM = 1),
                        '.')
                    EMAIL_ADDRESS,
                V_REGN_NO LEGACY_REF1
            FROM GNMM_COMPANY_MASTER C
            WHERE     C.V_COMPANY_CODE = V_COMPANYCODE
              AND C.V_COMPANY_BRANCH = V_COMPANYBRANCH;



        V_SUPPLIER_COUNT        NUMBER := 0;
        V_SUPPLIER_SITE_COUNT   NUMBER := 0;
        V_PIN_COUNT             NUMBER := 0;

        V_CSP_PIN_NO            VARCHAR2 (50);
        V_SITE_COUNT            NUMBER := 0;
        V_CONTACT_COUNT         NUMBER := 0;



        V_AGENT_COUNT           NUMBER;
        V_POLICY_COUNT          NUMBER;
        V_VENDOR_TYPE           VARCHAR2 (150);
        V_PAY_GROUP             VARCHAR2 (50);
    BEGIN


        FOR I IN SUPPLIERS
            LOOP






                IF JHL_BI_UTILS.CHECK_VALID_PIN (I.LEGACY_REF1) <> 'Y'
                THEN
                    INSERT INTO JHL_OFA_SUPPLIER_ERRORS (V_COMPANY_CODE,
                                                         V_COMPANY_BRANCH,
                                                         SP_PIN_NO,
                                                         SP_DATE)
                    VALUES (I.V_COMPANY_CODE,
                            I.V_COMPANY_BRANCH,
                            I.LEGACY_REF1,
                            SYSDATE);
                END IF;

                IF JHL_BI_UTILS.CHECK_VALID_PIN (I.LEGACY_REF1) = 'Y'
                THEN
                    BEGIN
                        SELECT COUNT (*)
                        INTO V_SUPPLIER_COUNT
                        FROM JHL_OFA_CO_SUPPLIER
                        WHERE     V_COMPANY_CODE = I.V_COMPANY_CODE
                          AND V_COMPANY_BRANCH = I.V_COMPANY_BRANCH;
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_SUPPLIER_COUNT := 0;
                    END;

                    IF V_SUPPLIER_COUNT = 0
                    THEN
                        SELECT NVL (MAX (CSP_PIN_COUNT), 0)
                        INTO V_PIN_COUNT
                        FROM JHL_OFA_CO_SUPPLIER;

                        V_PIN_COUNT := V_PIN_COUNT + 1;

                        INSERT INTO JHL_OFA_CO_SUPPLIER (CSP_NO,
                                                         V_COMPANY_CODE,
                                                         V_COMPANY_BRANCH,
                                                         CSP_PIN_NO,
                                                         CSP_DATE,
                                                         CSP_PIN_COUNT)
                        VALUES (JHL_CSP_NO_SEQ.NEXTVAL,
                                I.V_COMPANY_CODE,
                                I.V_COMPANY_BRANCH,

                                I.LEGACY_REF1,
                                SYSDATE,
                                V_PIN_COUNT);
                    ELSE


                        UPDATE JHL_OFA_CO_SUPPLIER
                        SET CSP_PIN_NO = I.LEGACY_REF1
                        WHERE     V_COMPANY_CODE = I.V_COMPANY_CODE
                          AND V_COMPANY_BRANCH = I.V_COMPANY_BRANCH;


                    END IF;


                    BEGIN
                        SELECT CSP_PIN_NO
                        INTO V_CSP_PIN_NO
                        FROM JHL_OFA_CO_SUPPLIER
                        WHERE     V_COMPANY_CODE = I.V_COMPANY_CODE
                          AND V_COMPANY_BRANCH = I.V_COMPANY_BRANCH;
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                RAISE_ERROR ('Error Getting Pin number');
                    END;



                    IF V_CSP_PIN_NO IS NULL
                    THEN
                        RAISE_ERROR ('Pin Number is null');
                    END IF;

                    BEGIN
                        SELECT COUNT (*)
                        INTO V_PIN_COUNT
                        FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                        WHERE     PAY_GROUP IN ('LIFE-CLAIM', 'LIFE-COMMISSION')
                          AND LEGACY_REF1 = V_CSP_PIN_NO;
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_PIN_COUNT := 0;
                    END;




                    SELECT COUNT (*)
                    INTO V_AGENT_COUNT
                    FROM AMMM_AGENT_MASTER AGN
                    WHERE     AGN.V_COMPANY_CODE = COMPANY_CODE
                      AND AGN.V_COMPANY_BRANCH = COMPANY_BRANCH;

                    SELECT COUNT (*)
                    INTO V_POLICY_COUNT
                    FROM GNMT_POLICY P
                    WHERE     P.V_COMPANY_CODE = COMPANY_CODE
                      AND P.V_COMPANY_BRANCH = COMPANY_BRANCH;

                    IF V_AGENT_COUNT > 0 AND V_POLICY_COUNT = 0
                    THEN
                        V_VENDOR_TYPE := 'BROKERS';
                        V_PAY_GROUP := 'LIFE-COMMISSION';
                    ELSE
                        V_VENDOR_TYPE := I.TYPE_OF_SUPPLIER;
                        V_PAY_GROUP := I.PAY_GROUP;
                    END IF;





                    IF V_PIN_COUNT = 0
                    THEN
                        INSERT
                        INTO XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM (
                            SEQ_ID,
                            PROCESS_FLAG,
                            VENDOR_NAME,
                            ENABLED_FLAG,
                            TYPE_OF_SUPPLIER,
                            TERMS_NAME,
                            PAY_GROUP,
                            PAY_PRIORITY,
                            INVOICE_CURRENCY,
                            PAYMENT_CURRENCY,
                            HOLD_FLAG,
                            TERMS_DATE_BASIS,
                            INSPEC_REQ_FLAG,
                            RCPT_REQUIRED_FLAG,
                            MATCH_OPTION,
                            PAYM_METHOD_CODE,
                            LEGACY_REF1,
                            LEGACY_REF2,
                            LEGACY_REF3,
                            LEGACY_REF4,
                            LEGACY_REF5,
                            LEGACY_REF6,
                            LEGACY_REF7,
                            LEGACY_REF9,
                            LEGACY_REF11,
                            LAST_UPDATE_DATE)
                        VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                1,
                                I.VENDOR_NAME,
                                I.ENABLED_FLAG,
                                NVL (V_VENDOR_TYPE, I.TYPE_OF_SUPPLIER),
                                I.TERMS_NAME,
                                NVL (V_PAY_GROUP, I.PAY_GROUP),
                                I.PAY_PRIORITY,
                                I.INVOICE_CURRENCY,
                                I.PAYMENT_CURRENCY,
                                I.HOLD_FLAG,
                                I.TERMS_DATE_BASIS,
                                I.INSPEC_REQ_FLAG,
                                I.RCPT_REQUIRED_FLAG,
                                I.MATCH_OPTION,
                                I.PAYM_METHOD_CODE,
                                V_CSP_PIN_NO,
                                I.LEGACY_REF2,
                                I.LEGACY_REF3,
                                I.LEGACY_REF4,
                                I.LEGACY_REF5,
                                I.LEGACY_REF6,
                                I.LEGACY_REF7,
                                I.LEGACY_REF9,
                                I.LEGACY_REF11,
                                I.LAST_UPDATE_DATE);
                    END IF;

                    FOR J IN SUPPLIER_SITE (I.V_COMPANY_CODE, I.V_COMPANY_BRANCH)
                        LOOP
                            BEGIN
                                SELECT COUNT (*)
                                INTO V_SUPPLIER_SITE_COUNT
                                FROM JHL_OFA_CO_SUPPLIER_SITE
                                WHERE     V_COMPANY_CODE = I.V_COMPANY_CODE
                                  AND V_COMPANY_BRANCH = I.V_COMPANY_BRANCH
                                  AND NVL (V_POLICY_NO, 'XXXX') =
                                      NVL (J.LEGACY_REF3, 'XXXX');
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_SUPPLIER_SITE_COUNT := 0;
                            END;



                            BEGIN
                                SELECT COUNT (*)
                                INTO V_SITE_COUNT
                                FROM APPS.XXJIC_AP_SUPPLIER_MAP@JICOFPROD.COM
                                WHERE     LOB_NAME IN ('JHL_UG_LIF_OU')
                                  AND PIN_NO = V_CSP_PIN_NO
                                  AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE;
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_SITE_COUNT := 0;
                            END;






                            IF V_SITE_COUNT = 0
                            THEN
                                BEGIN
                                    SELECT COUNT (*)
                                    INTO V_SITE_COUNT
                                    FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                                    WHERE     PAY_GRP_LKP_CODE IN
                                              ('LIFE-CLAIM', 'LIFE-COMMISSION')
                                      AND VENDOR_SITE_CODE = J.VENDOR_SITE_CODE
                                      AND OPERATING_UNIT = 'JHL_UG_LIF_OU'
                                      AND LEGACY_REF1 = V_CSP_PIN_NO;
                                EXCEPTION
                                    WHEN OTHERS
                                        THEN
                                            V_SITE_COUNT := 0;
                                END;
                            END IF;









                            IF V_SUPPLIER_SITE_COUNT = 0
                            THEN
                                INSERT INTO JHL_OFA_CO_SUPPLIER_SITE (CSPS_NO,
                                                                      V_COMPANY_CODE,
                                                                      V_COMPANY_BRANCH,
                                                                      V_POLICY_NO,
                                                                      CSPS_DATE)
                                VALUES (JHL_CSPS_NO_SEQ.NEXTVAL,
                                        I.V_COMPANY_CODE,
                                        I.V_COMPANY_BRANCH,
                                        J.LEGACY_REF3,
                                        SYSDATE);
                            END IF;



                            IF V_SITE_COUNT = 0
                            THEN
                                INSERT
                                INTO XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM (
                                    SEQ_ID,
                                    PROCESS_FLAG,
                                    VENDOR_SITE_CODE,
                                    PURCHASIN_SITE_FLAG,
                                    RFQ_ONLY_SITE_FLAG,
                                    PAY_SITE_FLAG,
                                    ADDRESS_LINE1,
                                    CITY,
                                    STATE,
                                    ZIP,
                                    COUNTRY,
                                    TERMS_DATE_BASIS,
                                    PAY_GRP_LKP_CODE,
                                    TERMS_NAME,
                                    INV_CURR_CODE,
                                    PYMT_CURR_CODE,
                                    OPERATING_UNIT,
                                    MATCH_OPTION,
                                    PAYMENT_METHOD_CODE,
                                    PREPAYMENT_ACCOUNT,
                                    PREPAYMENT_ACCOUNT_ID,
                                    LIABILITY_ACCOUNT,
                                    LIABILITY_ACCOUNT_ID,
                                    LEGACY_REF1,
                                    LEGACY_REF2,
                                    LEGACY_REF3,
                                    LEGACY_REF4,
                                    LEGACY_REF5,
                                    LEGACY_REF6,
                                    LEGACY_REF7,
                                    LEGACY_REF8,
                                    LEGACY_REF9,
                                    LEGACY_REF10)
                                VALUES (XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                        1,
                                        J.VENDOR_SITE_CODE,
                                        J.PURCHASIN_SITE_FLAG,
                                        J.RFQ_ONLY_SITE_FLAG,
                                        J.PAY_SITE_FLAG,
                                        J.ADDRESS_LINE1,
                                        J.CITY,
                                        J.STATE,
                                        J.ZIP,
                                        J.COUNTRY,
                                        J.TERMS_DATE_BASIS,
                                        J.PAY_GRP_LKP_CODE,
                                        J.TERMS_NAME,
                                        J.INV_CURR_CODE,
                                        J.PYMT_CURR_CODE,
                                        J.OPERATING_UNIT,
                                        J.MATCH_OPTION,
                                        J.PAYMENT_METHOD_CODE,
                                        J.PREPAYMENT_ACCOUNT_ID,
                                        J.PREPAYMENT_ACCOUNT_ID,
                                        J.LIABILITY_ACCOUNT,
                                        J.LIABILITY_ACCOUNT,
                                        V_CSP_PIN_NO,
                                        J.LEGACY_REF2,
                                        J.LEGACY_REF3,
                                        J.LEGACY_REF4,
                                        J.LEGACY_REF5,
                                        J.LEGACY_REF6,
                                        J.LEGACY_REF7,
                                        J.LEGACY_REF8,
                                        J.LEGACY_REF9,
                                        J.LEGACY_REF10);
                            END IF;
                        END LOOP;


                    FOR C IN SUPPLIER_CONTACT (I.V_COMPANY_CODE, I.V_COMPANY_BRANCH)
                        LOOP
                            BEGIN
                                SELECT COUNT (*)
                                INTO V_CONTACT_COUNT
                                FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                                WHERE     LEGACY_REF1 = V_CSP_PIN_NO
                                  AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                            EXCEPTION
                                WHEN OTHERS
                                    THEN
                                        V_CONTACT_COUNT := 0;
                            END;


                            IF V_CONTACT_COUNT = 0
                            THEN
                                INSERT
                                INTO XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM (
                                    PROCESS_FLAG,
                                    OPERATING_UNIT,
                                    FIRST_NAME,
                                    LAST_NAME,
                                    PHONE,
                                    EMAIL_ADDRESS,
                                    LEGACY_REF1,
                                    SEQ_ID,
                                    LEGACY_REF2)
                                VALUES (1,
                                        C.OPERATING_UNIT,
                                        SUBSTR (C.FIRST_NAME, 1, 50),
                                        C.LAST_NAME,
                                        C.PHONE,
                                        C.EMAIL_ADDRESS,
                                        V_CSP_PIN_NO,
                                        XXJICUG_COM_CONV_SEQ.NEXTVAL@JICOFPROD.COM,
                                        I.LEGACY_REF2);
                            END IF;
                        END LOOP;



                    BEGIN
                        SELECT COUNT (*)
                        INTO V_SITE_COUNT
                        FROM XXJICUG_AP_SUPPLIER_SITE_STG@JICOFPROD.COM
                        WHERE     PAY_GRP_LKP_CODE IN
                                  ('LIFE-CLAIM', 'LIFE-COMMISSION')
                          AND LEGACY_REF1 = V_CSP_PIN_NO
                          AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                    EXCEPTION
                        WHEN OTHERS
                            THEN
                                V_SITE_COUNT := 0;
                    END;



                    IF V_SITE_COUNT = 0
                    THEN
                        DELETE FROM XXJICUG_AP_SUPPLIER_STG@JICOFPROD.COM
                        WHERE     PAY_GROUP IN ('LIFE-CLAIM', 'LIFE-COMMISSION')
                          AND LEGACY_REF1 = V_CSP_PIN_NO
                          AND LEGACY_REF9 = 'Uganda';

                        DELETE FROM XXJICUG_AP_SUPPLIER_CONCT_STG@JICOFPROD.COM
                        WHERE     LEGACY_REF1 = V_CSP_PIN_NO
                          AND OPERATING_UNIT = 'JHL_UG_LIF_OU';
                    END IF;
                END IF;
            END LOOP;
    END;



    PROCEDURE CREATE_OFA_CANCELLED_PYMT_GL ( VOUCHER_NO NUMBER DEFAULT NULL) IS



        CURSOR VOUCHERS IS
            SELECT  V_VOU_DESC,V_VOU_NO,TO_DATE(D_VOU_DATE,'DD/MM/RRRR') D_VOU_DATE ,TO_DATE(JHL_GEN_PKG.GET_VOUCHER_APPROVAL_DATE (V_VOU_NO ) ,'DD/MM/RRRR') APPROVAL_DATE
            FROM PYMT_VOUCHER_ROOT PM, PYMT_VOU_MASTER PV
            WHERE PM.V_MAIN_VOU_NO = PV.V_MAIN_VOU_NO
              AND TO_DATE(D_VOU_DATE,'DD/MM/RRRR')   BETWEEN TO_DATE('01-JAN-20','DD/MM/RRRR')  AND TO_DATE(SYSDATE,'DD/MM/RRRR')
              AND JHL_GEN_PKG.IS_VOUCHER_AUTHORIZED(V_VOU_NO) = 'Y'
              AND JHL_GEN_PKG.IS_VOUCHER_CANCELLED (V_VOU_NO) = 'N'

              AND V_VOU_NO  NOT IN ( SELECT V_DOCU_REF_NO FROM JHL_OFA_GL_PYMT_TRANS WHERE V_DOCU_REF_NO =V_VOU_NO )

              AND V_VOU_NO = VOUCHER_NO;



        V_CONTROL_AMT  NUMBER :=0;



    BEGIN






        FOR I IN VOUCHERS LOOP

                BEGIN
                    V_CONTROL_AMT :=0;

                    BEGIN
                        SELECT  SUM(DECODE(V_TYPE,'D', N_AMT,-N_AMT))
                        INTO V_CONTROL_AMT

                        FROM GNMT_GL_MASTER M,GNDT_GL_DETAILS D
                        WHERE M.N_REF_NO = D.N_REF_NO
                          AND M.V_JOURNAL_STATUS = 'C'
                          AND NVL(M.V_REMARKS,'N') != 'X'
                          AND V_DOCU_TYPE ='VOUCHER'

                          AND V_DESC   LIKE  ('%PAYMENT CONTROL%')

                          AND V_DOCU_REF_NO = I.V_VOU_NO
                          AND M.N_REF_NO NOT IN  ( SELECT ORT.N_REF_NO FROM JHL_OFA_GL_PYMT_TRANS ORT WHERE ORT.N_REF_NO =M.N_REF_NO ) ;
                    EXCEPTION
                        WHEN OTHERS THEN
                            RAISE_ERROR('getting control amount  '|| I.V_VOU_NO );

                    END;




                    IF V_CONTROL_AMT = 0 THEN

                        INSERT INTO JHL_OFA_GL_PYMT_TRANS(OPYT_NO, N_REF_NO, D_DATE, V_BRANCH_CODE, V_LOB_CODE,
                                                          V_PROCESS_CODE, V_PROCESS_NAME, V_DOCU_TYPE, V_DOCU_REF_NO, V_GL_CODE, V_DESC, V_TYPE, N_AMT,OFA_ACC_CODE,V_SOURCE_CURRENCY,
                                                          D_VOU_DATE)

                        SELECT JHL_OPYT_NO_SEQ.NEXTVAL,M.N_REF_NO, M.D_DATE, NVL(V_BRANCH_CODE,'HO'), V_LOB_CODE, NVL(V_PROCESS_CODE,'N/A') V_PROCESS_CODE,NVL((SELECT V_PROCESS_NAME
                                                                                                                                                                FROM GNMM_PROCESS_MASTER
                                                                                                                                                                WHERE V_PROCESS_ID = V_PROCESS_CODE),NVL(V_PROCESS_CODE,'N/A')) V_PROCESS_NAME,V_DOCU_TYPE,V_DOCU_REF_NO,V_GL_CODE ,V_DESC ,V_TYPE, N_AMT,

                               NVL( (SELECT   OFA_ACC_CODE
                                     FROM JHL_ISF_OFA_ACC_MAP
                                     WHERE TRIM(ISF_GL_CODE) = TRIM(D.V_GL_CODE)
                                       AND TRIM(ACC_DESC)  = TRIM(D.V_DESC) ),'N') OFA_ACC_CODE

                                ,'UGX',NVL(I.APPROVAL_DATE,I.D_VOU_DATE)
                        FROM GNMT_GL_MASTER M,GNDT_GL_DETAILS D
                        WHERE M.N_REF_NO = D.N_REF_NO
                          AND M.V_JOURNAL_STATUS = 'C'
                          AND NVL(M.V_REMARKS,'N') != 'X'
                          AND V_DOCU_TYPE ='VOUCHER'


                          AND V_DOCU_REF_NO = I.V_VOU_NO
                          AND M.N_REF_NO NOT IN  ( SELECT ORT.N_REF_NO FROM JHL_OFA_GL_PYMT_TRANS ORT WHERE ORT.N_REF_NO =M.N_REF_NO ) ;

                    END IF;




                EXCEPTION
                    WHEN OTHERS THEN

                        RAISE_ERROR('Error on V_VOU_NO == ' || I.V_VOU_NO);

                END;

                COMMIT;
            END LOOP;
        TRANSFORM_OFA_CANCEL_PY_TRANS;
    END;



    PROCEDURE TRANSFORM_OFA_CANCEL_PY_TRANS IS



        CURSOR  VOUCHERS IS

            SELECT DISTINCT V_DOCU_REF_NO
            FROM  JHL_OFA_GL_PYMT_TRANS
            WHERE  OPYT_PROCESSED <>'Y';


        V_VGL_NO NUMBER;




    BEGIN


        FOR VOU IN VOUCHERS LOOP

                SELECT JGL_OFA_VGL_NO_SEQ.NEXTVAL
                INTO V_VGL_NO
                FROM DUAL;





                UPDATE JHL_OFA_GL_PYMT_TRANS
                SET  OPYT_PROCESSED = 'Y',
                     OPYT_PROCESSED_DT = SYSDATE,
                     OFA_VGL_NO =V_VGL_NO ,
                     OFA_VGL_CODE =  'OFA_PV_'||TO_CHAR(SYSDATE,'YYYY')||'_'||V_VGL_NO
                WHERE V_DOCU_REF_NO = VOU.V_DOCU_REF_NO
                  AND OPYT_PROCESSED <>'Y';




                COMMIT;

            END LOOP;

        TRANSFORM_OFA_PY_GL_TRANS;
    END;





    PROCEDURE TRANSFORM_OFA_PY_GL_TRANS IS


        CURSOR VOU_TRANS IS

            SELECT 'NEW' STATUS, '2088' SET_OF_BOOKS_ID,
                   'ISF LIFE' USER_JE_SOURCE_NAME, 'ISF Payments' USER_JE_CATEGORY_NAME, V_SOURCE_CURRENCY CURRENCY_CODE,
                   'A' ACTUAL_FLAG, TO_CHAR(D_DATE,'DD-MON-YY') ACCOUNTING_DATE, TO_CHAR(D_DATE,'DD-MON-YY')  DATE_CREATED, 0 CREATED_BY,
                   DECODE(V_TYPE,'D',N_AMT,NULL) ENTERED_DR, DECODE(V_TYPE,'C',N_AMT,NULL) ENTERED_CR,
                   '221'  SEGMENT1,
                   DECODE (V_BRANCH_CODE, 'HO', '210', '000')  SEGMENT2,
                   '00' SEGMENT3,
                   DECODE (V_LOB_CODE,  'LOB001', '12',  'LOB003', '11' ,'LOB004', '13','LOB005', '14','LOB002', '63', '00')  SEGMENT4,
                   OFA_ACC_CODE SEGMENT5,
                   '00' SEGMENT6,
                   '000' SEGMENT7,
                   '000' SEGMENT8,
                   OFA_VGL_NO GROUP_ID,
                   V_PROCESS_CODE|| '-'|| V_PROCESS_NAME JOURNAL_DESCRIPTION,
                   V_DESC LINE_DESCRIPTION,
                   OFA_VGL_NO REFERENCE,
                   TO_CHAR(D_DATE,'DD-MON-YY') REFERENCE_DATE,
                   V_DOCU_REF_NO REFERENCE1,
                   'ISF Payments - '||V_DOCU_REF_NO  REFERENCE2,
                   NULL  N_REF_NO,
                   V_BRANCH_CODE,
                   V_LOB_CODE,
                   V_PROCESS_CODE,
                   D_DATE,
                   OFA_VGL_NO,
                   OFA_VGL_CODE,
                   V_GL_CODE

            FROM

                (SELECT   TO_DATE(D_VOU_DATE,'DD/MM/RRRR') D_DATE , V_BRANCH_CODE, V_LOB_CODE, V_PROCESS_CODE, V_PROCESS_NAME, V_GL_CODE, V_DESC, V_TYPE, SUM(N_AMT) N_AMT,
                          V_SOURCE_CURRENCY,OFA_ACC_CODE,OFA_VGL_NO, OFA_VGL_CODE,V_DOCU_REF_NO
                 FROM JHL_OFA_GL_PYMT_TRANS
                 WHERE 1=1
                   AND OPYT_PROCESSED = 'Y'
                   AND  OPYT_POSTED = 'N'


                 GROUP BY  TO_DATE(D_VOU_DATE,'DD/MM/RRRR') ,V_BRANCH_CODE, V_LOB_CODE, V_PROCESS_CODE, V_PROCESS_NAME, V_GL_CODE, V_DESC,
                           V_TYPE,V_SOURCE_CURRENCY,OFA_ACC_CODE,OFA_VGL_NO, OFA_VGL_CODE,V_DOCU_REF_NO);





        V_VGL_NO  NUMBER;




    BEGIN



        FOR J IN  VOU_TRANS  LOOP

                INSERT INTO JHL_OFA_PYMT_GL_INTER
                (OGLI_NO, STATUS, SET_OF_BOOKS_ID, USER_JE_SOURCE_NAME, USER_JE_CATEGORY_NAME, CURRENCY_CODE, ACTUAL_FLAG,
                 ACCOUNTING_DATE, DATE_CREATED, CREATED_BY, ENTERED_DR, ENTERED_CR, SEGMENT1, SEGMENT2, SEGMENT3,
                 SEGMENT4, SEGMENT5, SEGMENT6, SEGMENT7, SEGMENT8, GROUP_ID, JOURNAL_DESCRIPTION, LINE_DESCRIPTION, REFERENCE,
                 REFERENCE_DATE, REFERENCE1, REFERENCE2, N_REF_NO, V_BRANCH_CODE, V_LOB_CODE, V_PROCESS_CODE,
                 REFERENCE5, REFERENCE6, REFERENCE10,OGLI_PROCESSED,D_DATE,V_DOCU_TYPE,OGLI_POSTED,OFA_VGL_NO,OFA_VGL_CODE,OGLI_PROCESSED_DT,V_GL_CODE)

                VALUES(

                          JHL_OGLI_NO_SEQ.NEXTVAL,J.STATUS,J.SET_OF_BOOKS_ID,J.USER_JE_SOURCE_NAME,J.USER_JE_CATEGORY_NAME,J.CURRENCY_CODE,J.ACTUAL_FLAG,J.
                        ACCOUNTING_DATE,J.DATE_CREATED,J.CREATED_BY,J.ENTERED_DR,J.ENTERED_CR,J.SEGMENT1,J.SEGMENT2,J.SEGMENT3,J.
                              SEGMENT4,J.SEGMENT5,J.SEGMENT6,J.SEGMENT7,J.SEGMENT8,J.GROUP_ID,J.JOURNAL_DESCRIPTION,J.LINE_DESCRIPTION,J.REFERENCE,J.
                              REFERENCE_DATE,J.REFERENCE1,J.REFERENCE2,J.N_REF_NO,J.V_BRANCH_CODE,J.V_LOB_CODE,J.V_PROCESS_CODE,
                          J.JOURNAL_DESCRIPTION,J.N_REF_NO,J.LINE_DESCRIPTION, 'Y',J.D_DATE,J.USER_JE_CATEGORY_NAME, 'N',J.OFA_VGL_NO, J.OFA_VGL_CODE,SYSDATE,J.V_GL_CODE

                      );


            END LOOP;



        UPDATE JHL_OFA_GL_PYMT_TRANS
        SET OPYT_POSTED = 'Y',
            OPYT_POSTED_DATE = SYSDATE
        WHERE OPYT_PROCESSED  = 'Y'

          AND OPYT_POSTED <> 'Y';

        COMMIT;


        SEND_PYMT_GL_TRANS_TO_OFA;
    END;

    PROCEDURE SEND_PYMT_GL_TRANS_TO_OFA IS

        cursor TRANS is
            SELECT OGLI_NO, STATUS, SET_OF_BOOKS_ID, USER_JE_SOURCE_NAME, USER_JE_CATEGORY_NAME, CURRENCY_CODE, ACTUAL_FLAG,
                   ACCOUNTING_DATE, DATE_CREATED, CREATED_BY, ENTERED_DR, ENTERED_CR, SEGMENT1, SEGMENT2, SEGMENT3, SEGMENT4, SEGMENT5,
                   SEGMENT6, SEGMENT7, SEGMENT8, GROUP_ID, JOURNAL_DESCRIPTION, LINE_DESCRIPTION, to_char(REFERENCE) REFERENCE, REFERENCE_DATE, REFERENCE1,
                   REFERENCE2, N_REF_NO, V_BRANCH_CODE, V_LOB_CODE,
                   V_PROCESS_CODE, REFERENCE5, REFERENCE6, REFERENCE10, OGLI_PROCESSED, V_DOCU_TYPE, OFA_VGL_NO, OFA_VGL_CODE, OGLI_POSTED, D_DATE
            FROM JHL_OFA_PYMT_GL_INTER
            WHERE 1=1
              AND OGLI_PROCESSED = 'Y'
              AND OGLI_POSTED =  'N'
            ORDER BY REFERENCE1 ;

    BEGIN

        FOR cI IN TRANS LOOP
                INSERT INTO XXJICUG_GL_INTERFACE_STG (
                    ogli_no,
                    status,
                    set_of_books_id,
                    ledger_id,
                    user_je_source_name,
                    user_je_category_name,
                    currency_code,
                    actual_flag,
                    accounting_date,
                    date_created,
                    created_by,
                    entered_dr,
                    entered_cr,
                    segment1,
                    segment2,
                    segment3,
                    segment4,
                    segment5,
                    segment6,
                    segment7,
                    segment8,
                    group_id,
                    reference5,
                    reference10,
                    reference6,
                    reference_date,
                    reference1,
                    reference2,
                    odi_posted
                ) select i.ogli_no,
                         i.status,
                         i.set_of_books_id,
                         i.set_of_books_id,
                         TRIM(i.user_je_source_name),
                         TRIM(i.user_je_category_name),
                         i.currency_code,
                         i.actual_flag,
                         i.accounting_date,
                         i.date_created,
                         i.created_by,
                         i.entered_dr,
                         i.entered_cr,
                         i.segment1,
                         i.segment2,
                         i.segment3,
                         i.segment4,
                         i.segment5,
                         i.segment6,
                         i.segment7,
                         i.segment8,
                         i.group_id,
                         i.reference5,
                         i.reference10,
                         i.reference6,
                         i.reference_date,
                         substr(i.reference1, 1, 99),
                         i.reference2,
                         'N' from (
                                      SELECT
                                          ogli_no,
                                          status,
                                          set_of_books_id,
                                          TRIM(user_je_source_name) as user_je_source_name,
                                          TRIM(user_je_category_name) as user_je_category_name,
                                          currency_code,
                                          actual_flag,
                                          accounting_date,
                                          date_created,
                                          created_by,
                                          entered_dr,
                                          entered_cr,
                                          segment1,
                                          segment2,
                                          segment3,
                                          segment4,
                                          segment5,
                                          segment6,
                                          segment7,
                                          segment8,
                                          group_id,
                                          journal_description,
                                          line_description,
                                          reference reference,
                                          reference_date,
                                          reference1                   reference1,
                                          reference2,
                                          n_ref_no,
                                          v_branch_code,
                                          v_lob_code,
                                          v_process_code,
                                          reference5,
                                          reference1 reference6,
                                          reference1   reference10,
                                          ogli_processed,
                                          v_docu_type,
                                          ofa_vgl_no,
                                          ofa_vgl_code,
                                          ogli_posted,
                                          d_date
                                      FROM
                                          JHL_OFA_PYMT_GL_INTER
                                      WHERE 1=1
                                        AND OGLI_PROCESSED = 'Y'
                                        AND OGLI_POSTED =  'N' and OGLI_NO = cI.OGLI_NO
                                      ORDER BY REFERENCE1 )  i ;




                UPDATE JHL_OFA_PYMT_GL_INTER
                SET OGLI_POSTED = 'Y',
                    OGLI_POSTED_DATE = SYSDATE
                WHERE OGLI_NO = cI.OGLI_NO;

                commit;
            END LOOP;




        commit;
    END;



    PROCEDURE SEND_PYMT_GL_TRANS_TO_OFA_OLD IS

        CURSOR TRANS IS



            SELECT OGLI_NO, STATUS, SET_OF_BOOKS_ID, USER_JE_SOURCE_NAME, USER_JE_CATEGORY_NAME, CURRENCY_CODE, ACTUAL_FLAG,
                   ACCOUNTING_DATE, TRUNC(SYSDATE) DATE_CREATED, CREATED_BY, ENTERED_DR, ENTERED_CR, SEGMENT1, SEGMENT2, SEGMENT3, SEGMENT4, SEGMENT5,
                   SEGMENT6, SEGMENT7, SEGMENT8, GROUP_ID, JOURNAL_DESCRIPTION, LINE_DESCRIPTION, TO_CHAR(REFERENCE) REFERENCE, REFERENCE_DATE, REFERENCE1,
                   REFERENCE2, N_REF_NO, V_BRANCH_CODE, V_LOB_CODE,
                   V_PROCESS_CODE, REFERENCE5, REFERENCE6, REFERENCE10, OGLI_PROCESSED, V_DOCU_TYPE, OFA_VGL_NO, OFA_VGL_CODE, OGLI_POSTED, D_DATE
            FROM JHL_OFA_PYMT_GL_INTER
            WHERE 1=1

              AND OGLI_PROCESSED = 'Y'
              AND OGLI_POSTED =  'N'
            ORDER BY REFERENCE1 ;



    BEGIN




        FOR I IN TRANS LOOP

                INSERT INTO APPS.GL_INTERFACE@JICOFPROD.COM(STATUS,SET_OF_BOOKS_ID,LEDGER_ID,USER_JE_SOURCE_NAME, USER_JE_CATEGORY_NAME,
                                                            CURRENCY_CODE,ACTUAL_FLAG, ACCOUNTING_DATE, DATE_CREATED, CREATED_BY,ENTERED_DR, ENTERED_CR,SEGMENT1,SEGMENT2,SEGMENT3,
                                                            SEGMENT4,SEGMENT5,SEGMENT6,SEGMENT7,SEGMENT8,GROUP_ID,REFERENCE5,REFERENCE10,REFERENCE6,REFERENCE_DATE, REFERENCE1,REFERENCE2)
                VALUES(
                          I.STATUS,I.SET_OF_BOOKS_ID,I.SET_OF_BOOKS_ID,TRIM(I.USER_JE_SOURCE_NAME),TRIM(I. USER_JE_CATEGORY_NAME),I.
                        CURRENCY_CODE,I.ACTUAL_FLAG,I. ACCOUNTING_DATE,I. DATE_CREATED,I. CREATED_BY,I.ENTERED_DR,I. ENTERED_CR,I.SEGMENT1,I.SEGMENT2,I.SEGMENT3,I.
                              SEGMENT4,I.SEGMENT5,I.SEGMENT6,I.SEGMENT7,I.SEGMENT8,I.GROUP_ID,I.REFERENCE5,I.REFERENCE10,I.REFERENCE6,I.REFERENCE_DATE,I. REFERENCE1,I.REFERENCE2
                      );




                UPDATE JHL_OFA_PYMT_GL_INTER
                SET OGLI_POSTED = 'Y',
                    OGLI_POSTED_DATE = SYSDATE
                WHERE OGLI_NO = I.OGLI_NO;

                COMMIT;
            END LOOP;




        COMMIT;
    END;



    PROCEDURE UPDT_CHQ
    AS
        V_START_DATE   DATE;
    BEGIN
        V_START_DATE := SYSDATE;

        INSERT INTO JHL_OFA_CHQ_DETAILS (CQR_NO,
                                         LOB_NAME,
                                         INVOICE_ID,
                                         PAYMENT_VOUCHER,
                                         VENDOR_NAME,
                                         VENDOR_SITE_CODE,
                                         PAYMENT_AMOUNT,
                                         PIN_NO,
                                         POLICY_NO,
                                         LEGACY_ENTITY_ID,
                                         CHECK_NUMBER,
                                         CQR_DATE,
                                         INVOICE_DATE,
                                         PAYMENT_DATE)
        SELECT JHL_CQR_NO_SEQ.NEXTVAL,
               LOB_NAME,
               INVOICE_ID,
               PAYMENT_VOUCHER,
               VENDOR_NAME,
               VENDOR_SITE_CODE,
               PAYMENT_AMOUNT,
               PIN_NO,
               POLICY_NO,
               LEGACY_ENTITY_ID,
               CHECK_NUMBER,
               SYSDATE,
               INVOICE_DATE,
               PAYMENT_DATE
        FROM APPS.XXJIC_AP_CLAIM_MAP@JICOFPROD.COM
        WHERE     LOB_NAME = 'JHL_UG_LIF_OU'

          AND CHECK_NUMBER IS NOT NULL
          AND PAYMENT_VOUCHER NOT IN
              (SELECT PAYMENT_VOUCHER FROM JHL_OFA_CHQ_DETAILS);


        UPDATE PYMT_VOU_MASTER P
        SET V_CHQ_NO =
                (SELECT DISTINCT A.CHECK_NUMBER
                 FROM JHL_OFA_CHQ_DETAILS A
                 WHERE     TRIM (REPLACE (A.PAYMENT_VOUCHER, '-NEW', '')) =
                           P.V_VOU_NO
                   AND ROWNUM = 1)
        WHERE     NVL (V_CHQ_NO, 'X') = 'X'
          AND P.V_VOU_NO IN
              (SELECT TRIM (REPLACE (B.PAYMENT_VOUCHER, '-NEW', ''))
               FROM JHL_OFA_CHQ_DETAILS B
               WHERE TRIM (REPLACE (B.PAYMENT_VOUCHER, '-NEW', '')) =
                     P.V_VOU_NO);





        INSERT INTO JHL_OFA_JOBS (OJB_ID,
                                  OJB_NAME,
                                  OJB_START_DT,
                                  OJB_END_DT)
        VALUES (JHL_OJB_ID_SEQ.NEXTVAL,
                'UPDT_CHQ',
                V_START_DATE,
                SYSDATE);

        COMMIT;
    END UPDT_CHQ;
END JHL_OFA_UTILS_1;
/
